<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PK Assistant ‚Äì RER A</title>
<style>
  body {
    background-color: #0b0014;
    color: #f2f2f2;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  h1 {
    margin-top: 15px;
    font-size: 1.8em;
    background: radial-gradient(circle at center, #c246ff 0%, #5e0acc 80%);
    color: white;
    display: inline-block;
    padding: 10px 25px;
    border-radius: 50px;
    box-shadow: 0 0 12px #6c1bff;
  }
  button {
    margin: 6px;
    padding: 10px 14px;
    border-radius: 8px;
    background-color: #361b75;
    color: #fff;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background-color: #5123b4;
  }
  .section {
    background-color: rgba(255,255,255,0.05);
    border-radius: 12px;
    margin: 12px auto;
    padding: 10px;
    max-width: 400px;
    box-shadow: 0 0 6px rgba(255,255,255,0.08);
  }
  .warning {
    color: #ffa64d;
  }
</style>
</head>

<body>
<h1>PK Assistant ‚Äì RER A</h1>

<div class="section">
  <p><b>G√âOLOCALISATION</b></p>
  <p id="status">üìç GPS inactif</p>
  <button onclick="startGeoloc()">D√©marrer la g√©oloc</button>
</div>

<div class="section">
  <p><b>PK estim√©</b> : <span id="pkDisplay">‚Äî</span></p>
  <p id="precision" class="warning">Pr√©cision typique : ¬±100‚Äì200 m</p>
  <p><b>Gare la plus proche :</b> <span id="nearestStation">Aucune</span></p>
  <p><b>Branche :</b> <span id="branchName">‚Äî</span></p>
</div>

<div class="section">
  <p><b>Param√®tres</b></p>
  <button onclick="recalibratePK()">Recaler le PK actuel</button>
  <button onclick="sendEmergency()">üì© Urgence / Avarie</button>
</div>

<script>
// =============== Donn√©es ligne RER A =======================
const troncCommun = [
  { name: "St-Germain-en-Laye", lat: 48.89847, lon: 2.09463, pk: 0 },
  { name: "Le V√©sinet ‚Äì Le Pecq", lat: 48.89845, lon: 2.12228, pk: 2000 },
  { name: "Le V√©sinet ‚Äì Centre", lat: 48.89016, lon: 2.13470, pk: 4000 },
  { name: "Chatou ‚Äì Croissy", lat: 48.88546, lon: 2.15640, pk: 6000 },
  { name: "Rueil-Malmaison", lat: 48.88774, lon: 2.17255, pk: 7000 },
  { name: "Nanterre-Ville", lat: 48.89521, lon: 2.19572, pk: 8000 },
  { name: "Nanterre-Universit√©", lat: 48.90095, lon: 2.21287, pk: 11000 },
  { name: "Nanterre-Pr√©fecture", lat: 48.89584, lon: 2.22307, pk: 12000 },
  { name: "La D√©fense ‚Äì Grande Arche", lat: 48.89190, lon: 2.23856, pk: 13000 },
  { name: "Charles de Gaulle ‚Äì √âtoile", lat: 48.87429, lon: 2.29488, pk: 18000 },
  { name: "Auber", lat: 48.87254, lon: 2.32981, pk: 20000 },
  { name: "Ch√¢telet ‚Äì Les Halles", lat: 48.86198, lon: 2.34694, pk: 22000 },
  { name: "Gare de Lyon", lat: 48.84449, lon: 2.37436, pk: 25000 },
  { name: "Nation", lat: 48.84882, lon: 2.39702, pk: 27000 },
  { name: "Vincennes", lat: 48.84754, lon: 2.43328, pk: 30000 },
  { name: "Fontenay-sous-Bois", lat: 48.84578, lon: 2.46415, pk: 31500 },
  { name: "Val de Fontenay", lat: 48.85442, lon: 2.48909, pk: 34000 }
];
const brancheBoissy = [
  { name: "Nogent-sur-Marne", lat: 48.83540, lon: 2.47166, pk: 35500 },
  { name: "Joinville-le-Pont", lat: 48.82118, lon: 2.46414, pk: 37000 },
  { name: "Saint-Maur ‚Äì Cr√©teil", lat: 48.80882, lon: 2.47080, pk: 38500 },
  { name: "La Varenne ‚Äì Chennevi√®res", lat: 48.79420, lon: 2.51351, pk: 40000 },
  { name: "Sucy ‚Äì Bonneuil", lat: 48.77099, lon: 2.50838, pk: 41500 },
  { name: "Boissy-Saint-L√©ger", lat: 48.75399, lon: 2.50598, pk: 43000 }
];
const brancheChessy = [
  { name: "Neuilly-Plaisance", lat: 48.85346, lon: 2.51384, pk: 35500 },
  { name: "Bry-sur-Marne", lat: 48.84427, lon: 2.52619, pk: 37000 },
  { name: "Noisy-le-Grand ‚Äì Mont d‚ÄôEst", lat: 48.84101, lon: 2.55274, pk: 39000 },
  { name: "Noisy ‚Äì Champs", lat: 48.84295, lon: 2.57884, pk: 41000 },
  { name: "Noisiel", lat: 48.84377, lon: 2.61608, pk: 43000 },
  { name: "Lognes", lat: 48.83936, lon: 2.63353, pk: 45000 },
  { name: "Torcy", lat: 48.83903, lon: 2.65506, pk: 47000 },
  { name: "Bussy-Saint-Georges", lat: 48.83718, lon: 2.71254, pk: 52000 },
  { name: "Val d‚ÄôEurope", lat: 48.85617, lon: 2.77383, pk: 57000 },
  { name: "Marne-la-Vall√©e ‚Äì Chessy", lat: 48.87072, lon: 2.78263, pk: 59000 }
];

// =============== Fonctions de base =========================
function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function detectBranch(lat, lon) {
  const dBoissy = distanceMeters(lat, lon, brancheBoissy[0].lat, brancheBoissy[0].lon);
  const dChessy = distanceMeters(lat, lon, brancheChessy[0].lat, brancheChessy[0].lon);
  return dBoissy < dChessy ? "Boissy" : "Chessy";
}
function nearestStation(lat, lon, arr) {
  let minD = Infinity, near = arr[0];
  for (const s of arr) {
    const d = distanceMeters(lat, lon, s.lat, s.lon);
    if (d < minD) { minD = d; near = s; }
  }
  return { station: near, dist: minD };
}
function interpolatePK(lat, lon, line) {
  const n = nearestStation(lat, lon, line);
  return n.station.pk;
}

// =============== G√©olocalisation ===========================
let currentPK = null;
let currentBranch = "‚Äî";
function startGeoloc() {
  document.getElementById("status").textContent = "üì° Recherche GPS...";
  navigator.geolocation.watchPosition(handlePosition, handleError, { enableHighAccuracy: true, maximumAge: 1000 });
}
function handlePosition(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  currentBranch = detectBranch(lat, lon);
  const line = troncCommun.concat(currentBranch === "Boissy" ? brancheBoissy : brancheChessy);
  const pk = interpolatePK(lat, lon, line);
  const nearest = nearestStation(lat, lon, line);
  currentPK = pk;
  document.getElementById("status").textContent = `‚úÖ GPS actif (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
  document.getElementById("pkDisplay").textContent = pk.toFixed(0) + " m";
  document.getElementById("nearestStation").textContent = nearest.station.name;
  document.getElementById("branchName").textContent = currentBranch;
}
function handleError(err) {
  document.getElementById("status").textContent = "‚ö†Ô∏è Erreur GPS : " + err.message;
}

// =============== Fonctions diverses =======================
function recalibratePK() {
  const val = prompt("Entre le PK exact (en m√®tres, ex: 32400) :");
  if (val) {
    currentPK = parseInt(val);
    alert("PK recal√© √† " + currentPK + " m");
    document.getElementById("pkDisplay").textContent = currentPK + " m";
  }
}
function sendEmergency() {
  const msg = `‚ö†Ô∏è URGENCE RER A\nPosition estim√©e : PK ${currentPK ?? "‚Äî"}\nBranche : ${currentBranch}\nGare la plus proche : ${document.getElementById("nearestStation").textContent}\nLien Google Maps : https://maps.google.com/?q=${navigator.geolocation?.coords?.latitude || ""},${navigator.geolocation?.coords?.longitude || ""}`;
  prompt("Copie ce message d'urgence :", msg);
}
</script>
</body>
</html><!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PK Assistant ‚Äì RER A</title>
<style>
  body {
    background-color: #0b0014;
    color: #f2f2f2;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  h1 {
    margin-top: 15px;
    font-size: 1.8em;
    background: radial-gradient(circle at center, #c246ff 0%, #5e0acc 80%);
    color: white;
    display: inline-block;
    padding: 10px 25px;
    border-radius: 50px;
    box-shadow: 0 0 12px #6c1bff;
  }
  button {
    margin: 6px;
    padding: 10px 14px;
    border-radius: 8px;
    background-color: #361b75;
    color: #fff;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background-color: #5123b4;
  }
  .section {
    background-color: rgba(255,255,255,0.05);
    border-radius: 12px;
    margin: 12px auto;
    padding: 10px;
    max-width: 400px;
    box-shadow: 0 0 6px rgba(255,255,255,0.08);
  }
  .warning {
    color: #ffa64d;
  }
</style>
</head>

<body>
<h1>PK Assistant ‚Äì RER A</h1>

<div class="section">
  <p><b>G√âOLOCALISATION</b></p>
  <p id="status">üìç GPS inactif</p>
  <button onclick="startGeoloc()">D√©marrer la g√©oloc</button>
</div>

<div class="section">
  <p><b>PK estim√©</b> : <span id="pkDisplay">‚Äî</span></p>
  <p id="precision" class="warning">Pr√©cision typique : ¬±100‚Äì200 m</p>
  <p><b>Gare la plus proche :</b> <span id="nearestStation">Aucune</span></p>
  <p><b>Branche :</b> <span id="branchName">‚Äî</span></p>
</div>

<div class="section">
  <p><b>Param√®tres</b></p>
  <button onclick="recalibratePK()">Recaler le PK actuel</button>
  <button onclick="sendEmergency()">üì© Urgence / Avarie</button>
</div>

<script>
// =============== Donn√©es ligne RER A =======================
const troncCommun = [
  { name: "St-Germain-en-Laye", lat: 48.89847, lon: 2.09463, pk: 0 },
  { name: "Le V√©sinet ‚Äì Le Pecq", lat: 48.89845, lon: 2.12228, pk: 2000 },
  { name: "Le V√©sinet ‚Äì Centre", lat: 48.89016, lon: 2.13470, pk: 4000 },
  { name: "Chatou ‚Äì Croissy", lat: 48.88546, lon: 2.15640, pk: 6000 },
  { name: "Rueil-Malmaison", lat: 48.88774, lon: 2.17255, pk: 7000 },
  { name: "Nanterre-Ville", lat: 48.89521, lon: 2.19572, pk: 8000 },
  { name: "Nanterre-Universit√©", lat: 48.90095, lon: 2.21287, pk: 11000 },
  { name: "Nanterre-Pr√©fecture", lat: 48.89584, lon: 2.22307, pk: 12000 },
  { name: "La D√©fense ‚Äì Grande Arche", lat: 48.89190, lon: 2.23856, pk: 13000 },
  { name: "Charles de Gaulle ‚Äì √âtoile", lat: 48.87429, lon: 2.29488, pk: 18000 },
  { name: "Auber", lat: 48.87254, lon: 2.32981, pk: 20000 },
  { name: "Ch√¢telet ‚Äì Les Halles", lat: 48.86198, lon: 2.34694, pk: 22000 },
  { name: "Gare de Lyon", lat: 48.84449, lon: 2.37436, pk: 25000 },
  { name: "Nation", lat: 48.84882, lon: 2.39702, pk: 27000 },
  { name: "Vincennes", lat: 48.84754, lon: 2.43328, pk: 30000 },
  { name: "Fontenay-sous-Bois", lat: 48.84578, lon: 2.46415, pk: 31500 },
  { name: "Val de Fontenay", lat: 48.85442, lon: 2.48909, pk: 34000 }
];
const brancheBoissy = [
  { name: "Nogent-sur-Marne", lat: 48.83540, lon: 2.47166, pk: 35500 },
  { name: "Joinville-le-Pont", lat: 48.82118, lon: 2.46414, pk: 37000 },
  { name: "Saint-Maur ‚Äì Cr√©teil", lat: 48.80882, lon: 2.47080, pk: 38500 },
  { name: "La Varenne ‚Äì Chennevi√®res", lat: 48.79420, lon: 2.51351, pk: 40000 },
  { name: "Sucy ‚Äì Bonneuil", lat: 48.77099, lon: 2.50838, pk: 41500 },
  { name: "Boissy-Saint-L√©ger", lat: 48.75399, lon: 2.50598, pk: 43000 }
];
const brancheChessy = [
  { name: "Neuilly-Plaisance", lat: 48.85346, lon: 2.51384, pk: 35500 },
  { name: "Bry-sur-Marne", lat: 48.84427, lon: 2.52619, pk: 37000 },
  { name: "Noisy-le-Grand ‚Äì Mont d‚ÄôEst", lat: 48.84101, lon: 2.55274, pk: 39000 },
  { name: "Noisy ‚Äì Champs", lat: 48.84295, lon: 2.57884, pk: 41000 },
  { name: "Noisiel", lat: 48.84377, lon: 2.61608, pk: 43000 },
  { name: "Lognes", lat: 48.83936, lon: 2.63353, pk: 45000 },
  { name: "Torcy", lat: 48.83903, lon: 2.65506, pk: 47000 },
  { name: "Bussy-Saint-Georges", lat: 48.83718, lon: 2.71254, pk: 52000 },
  { name: "Val d‚ÄôEurope", lat: 48.85617, lon: 2.77383, pk: 57000 },
  { name: "Marne-la-Vall√©e ‚Äì Chessy", lat: 48.87072, lon: 2.78263, pk: 59000 }
];

// =============== Fonctions de base =========================
function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function detectBranch(lat, lon) {
  const dBoissy = distanceMeters(lat, lon, brancheBoissy[0].lat, brancheBoissy[0].lon);
  const dChessy = distanceMeters(lat, lon, brancheChessy[0].lat, brancheChessy[0].lon);
  return dBoissy < dChessy ? "Boissy" : "Chessy";
}
function nearestStation(lat, lon, arr) {
  let minD = Infinity, near = arr[0];
  for (const s of arr) {
    const d = distanceMeters(lat, lon, s.lat, s.lon);
    if (d < minD) { minD = d; near = s; }
  }
  return { station: near, dist: minD };
}
function interpolatePK(lat, lon, line) {
  const n = nearestStation(lat, lon, line);
  return n.station.pk;
}

// =============== G√©olocalisation ===========================
let currentPK = null;
let currentBranch = "‚Äî";
function startGeoloc() {
  document.getElementById("status").textContent = "üì° Recherche GPS...";
  navigator.geolocation.watchPosition(handlePosition, handleError, { enableHighAccuracy: true, maximumAge: 1000 });
}
function handlePosition(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  currentBranch = detectBranch(lat, lon);
  const line = troncCommun.concat(currentBranch === "Boissy" ? brancheBoissy : brancheChessy);
  const pk = interpolatePK(lat, lon, line);
  const nearest = nearestStation(lat, lon, line);
  currentPK = pk;
  document.getElementById("status").textContent = `‚úÖ GPS actif (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
  document.getElementById("pkDisplay").textContent = pk.toFixed(0) + " m";
  document.getElementById("nearestStation").textContent = nearest.station.name;
  document.getElementById("branchName").textContent = currentBranch;
}
function handleError(err) {
  document.getElementById("status").textContent = "‚ö†Ô∏è Erreur GPS : " + err.message;
}

// =============== Fonctions diverses =======================
function recalibratePK() {
  const val = prompt("Entre le PK exact (en m√®tres, ex: 32400) :");
  if (val) {
    currentPK = parseInt(val);
    alert("PK recal√© √† " + currentPK + " m");
    document.getElementById("pkDisplay").textContent = currentPK + " m";
  }
}
function sendEmergency() {
  const msg = `‚ö†Ô∏è URGENCE RER A\nPosition estim√©e : PK ${currentPK ?? "‚Äî"}\nBranche : ${currentBranch}\nGare la plus proche : ${document.getElementById("nearestStation").textContent}\nLien Google Maps : https://maps.google.com/?q=${navigator.geolocation?.coords?.latitude || ""},${navigator.geolocation?.coords?.longitude || ""}`;
  prompt("Copie ce message d'urgence :", msg);
}
</script>
</body>
</html>
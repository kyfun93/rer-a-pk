<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>PK RER A ‚Äì St-Germain ‚Üî Paris ‚Üî Chessy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

  :root {
    color-scheme: dark;
    --bg: #0c0e16;
    --bg-gradient: radial-gradient(circle at top, #171b2c 0%, #0c0e16 60%, #05060b 100%);
    --card: #121522;
    --card-soft: #16182a;
    --border: #262a3a;
    --text: #f0f2ff;
    --muted: #a8abcc;
    --accent: #3d7bff;
    --accent-soft: rgba(61, 123, 255, 0.15);
    --danger: #ff4b6b;
    --danger-soft: rgba(255, 75, 107, 0.18);
    --good: #4bd67a;
    --good-soft: rgba(75, 214, 122, 0.12);
    --warning: #ffc75e;
  }

  * { box-sizing: border-box; }

  html, body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    background: var(--bg-gradient);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
  }

  body {
    padding: 16px 0 40px;
  }

  .app {
    max-width: 740px;
    margin: 0 auto;
    padding: 0 16px 32px;
  }

  /* TITRES */
  h1 {
    font-size: 1.6rem;
    margin: 0 0 4px;
    letter-spacing: 0.02em;
    font-weight: 700;
    color: #fff;
  }

  .subtitle {
    color: var(--muted);
    font-size: 0.9rem;
    margin-bottom: 12px;
  }

  /* BARRE DU HAUT */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 10px;
  }

  /* BOUTONS */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 18px;
    border-radius: 16px;
    border: none;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: center;
  }

  .btn-primary {
    background: linear-gradient(135deg, #3d7bff, #6fa3ff);
    color: white;
    box-shadow: 0 4px 12px rgba(61,123,255,0.4);
  }

  .btn-primary:hover {
    filter: brightness(1.1);
  }

  .btn-secondary {
    background: #1a1d2b;
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: #22263a;
  }

  .btn-danger {
    background: linear-gradient(135deg, #ff4b6b, #ff7592);
    color: white;
    box-shadow: 0 4px 12px rgba(255,75,107,0.4);
  }

  .btn-danger:hover {
    filter: brightness(1.08);
  }

  .btn-icon {
    display:inline-flex;
    align-items:center;
    gap:6px;
  }

  /* CARTES */
  .card {
    background: linear-gradient(145deg, #121522, #0d0f18);
    border-radius: 20px;
    padding: 18px 18px 14px;
    border: 1px solid rgba(255,255,255,0.06);
    margin-bottom: 14px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.45);
  }

  .card-soft {
    background: var(--card-soft);
  }

  .card-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
  }

  .card-title {
    font-size: 0.9rem;
    font-weight: 650;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
  }

  /* TEXTES ET INFOS */
  .big-value {
    font-size: 1.7rem;
    font-weight: 700;
    margin: 4px 0 3px;
    color: #fff;
  }

  .big-sub {
    font-size: 0.95rem;
    color: var(--muted);
  }

  .muted {
    color: var(--muted);
    font-size: 0.9rem;
  }

  /* BADGES */
  .badge {
    font-size: 0.8rem;
    padding: 4px 9px;
    border-radius: 12px;
    border: 1px solid var(--border);
    color: var(--muted);
    background: #181b2a;
  }

  .badge-good {
    color: var(--good);
    background: var(--good-soft);
    border-color: rgba(75,214,122,0.4);
  }

  .badge-danger {
    color: var(--danger);
    background: var(--danger-soft);
    border-color: rgba(255,75,107,0.4);
  }

  .badge-warn {
    color: var(--warning);
    background: rgba(255,184,77,0.12);
    border-color: rgba(255,184,77,0.5);
  }

  /* CHAMPS ET FORMULAIRES */
  .field {
    margin-top: 8px;
    display:flex;
    flex-direction:column;
    gap: 6px;
  }

  .field label {
    font-size: 0.85rem;
    color: var(--muted);
  }

  input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid #303047;
    background: #0a0c12;
    color: var(--text);
    font-size: 0.95rem;
    outline: none;
  }

  input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 6px rgba(61,123,255,0.4);
  }

  input::placeholder {
    color: #55556d;
  }

  .access-item { margin-bottom: 6px; }
  .access-item:last-child { margin-bottom: 0; }

  .settings-badge {
    font-size: 0.8rem;
    padding: 3px 8px;
    border-radius: 999px;
    background: var(--accent-soft);
    color: var(--accent);
    border: 1px solid rgba(61,123,255,0.5);
  }

  .settings-footer {
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--muted);
  }

  .divider {
    margin: 10px 0;
    height: 1px;
    background: rgba(255,255,255,0.04);
  }

  /* RESPONSIVE */
  @media (max-width: 640px) {
    .app {
      padding: 0 10px 24px;
    }

    h1 {
      font-size: 1.3rem;
    }

    .subtitle {
      font-size: 0.85rem;
    }

    .card {
      padding: 14px 14px 12px;
      border-radius: 18px;
    }

    .big-value {
      font-size: 1.5rem;
    }

    .big-sub,
    .muted {
      font-size: 0.85rem;
    }

    .btn {
      width: 100%;
      border-radius: 14px;
    }

    .top-bar {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }
  }

  @media (max-width: 380px) {
    h1 {
      font-size: 1.2rem;
    }
    .card {
      padding: 10px 10px 8px;
    }
  }
  </style>
</head>
<body>
  <div class="app">
    <div class="top-bar">
      <div>
        <h1>PK RER A ‚Äì St-Germain ‚Üî Paris ‚Üî Chessy</h1>
        <div class="subtitle">Estimation du PK en temps r√©el √† partir de la g√©olocalisation.</div>
      </div>
      <button id="btnSettingsToggle" class="btn btn-secondary btn-icon" type="button">
        <span>‚öôÔ∏è</span><span>Param√®tres</span>
      </button>
    </div>

    <!-- PARAM√àTRES -->
    <div id="settingsPanel" class="card card-soft" style="display:none;">
      <div class="card-header">
        <div class="card-title">Param√®tres</div>
        <span class="settings-badge">Local au t√©l√©phone</span>
      </div>

      <div class="field">
        <label for="inputSosPhone">Num√©ro SOS pour le SMS d‚Äôurgence</label>
        <input id="inputSosPhone" type="tel" placeholder="ex : 0612345678 ou +33612345678" />
        <div class="muted">Ce num√©ro sera utilis√© par le bouton ¬´ SMS d‚Äôurgence ¬ª.</div>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label for="selectSensitivity">Sensibilit√© au mouvement</label>
        <select id="selectSensitivity">
          <option value="slow">Marche lente</option>
          <option value="normal">Normal</option>
          <option value="train">Train</option>
        </select>
        <div class="muted">¬´ Marche lente ¬ª d√©tecte plus facilement un d√©placement √† pied.</div>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>Recalage PK</label>
        <div id="pkOffsetInfo" class="muted">Offset actuel : ¬±0 m appliqu√©s √† tous les PK.</div>
        <button id="btnResetOffset" class="btn btn-secondary" type="button">R√©initialiser le recalage PK</button>
      </div>

      <div class="field">
        <label>Position PK estim√©e (lecture seule)</label>
        <div id="pkEstimateText" class="muted">En attente de position GPS‚Ä¶</div>
      </div>

      <div class="field">
        <label for="inputPkRecal">PK exact ici (pour recaler l‚Äôappli)</label>
        <input id="inputPkRecal" type="text" placeholder="ex : 52700 ou 52+700" />
        <button id="btnApplyRecal" class="btn btn-primary" type="button">Recaler l‚Äôappli sur ce PK</button>
      </div>

      <div class="field">
        <button id="btnSaveSettings" class="btn btn-primary btn-icon" type="button">
          <span>üíæ</span><span>Enregistrer les param√®tres</span>
        </button>
      </div>

      <div class="settings-footer">
        Ces r√©glages restent stock√©s dans ton navigateur (localStorage).  
        Ils ne sont pas effac√©s quand on met √† jour l‚Äôapplication.
      </div>
    </div>

    <!-- G√âOLOC -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">G√©olocalisation</div>
        <span id="gpsStatusBadge" class="badge badge-danger">GPS inactif</span>
      </div>
      <div id="geolocText" class="muted">Position non encore re√ßue.</div>
      <div class="field">
        <button id="btnToggleGeoloc" class="btn btn-primary btn-icon" type="button">
          <span>üìç</span><span>D√©marrer la g√©oloc</span>
        </button>
      </div>
    </div>

    <!-- GARE LA PLUS PROCHE -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Gare la plus proche (en PK)</div>
      </div>
      <div id="nearestStationName" class="big-value">Aucune</div>
      <div id="nearestStationInfo" class="big-sub">En attente de position GPS‚Ä¶</div>
    </div>

    <!-- SENS / MOUVEMENT -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Sens / mouvement</div>
      </div>
      <div id="movementTitle" class="big-value">En attente d‚Äôun deuxi√®me point‚Ä¶</div>
      <div id="movementDetails" class="big-sub">‚Äî</div>
    </div>

    <!-- PROCHAINE GARE -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Prochaine gare (en PK)</div>
      </div>
      <div id="nextStationName" class="big-value">Aucune</div>
      <div id="nextStationInfo" class="big-sub">En attente de position GPS‚Ä¶</div>
    </div>

    <!-- PK CIBLE -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">PK cible</div>
      </div>
      <div id="pkTargetLabel" class="big-value">Aucun</div>
      <div id="pkTargetInfo" class="big-sub">
        Saisis un PK puis clique sur ¬´ D√©finir ce PK comme cible ¬ª.
      </div>
      <div class="field">
        <label for="inputPkTarget">Saisis un PK en m√®tres (ex : 32400) ou au format 32+400.</label>
        <input id="inputPkTarget" type="text" placeholder="ex : 32400 ou 32+400" />
        <button id="btnSetPkTarget" class="btn btn-primary" type="button">D√©finir ce PK comme cible</button>
      </div>
    </div>

    <!-- ACC√àS / GAres les plus proches -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Acc√®s les plus proches (en PK)</div>
      </div>
      <div class="big-sub">Top 3 en PK</div>
      <div id="accessList" class="muted" style="margin-top:8px;">
        En attente de position GPS‚Ä¶
      </div>
    </div>

    <!-- URGENCE / SMS -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Urgence / partage position</div>
      </div>
      <div id="smsPreview" class="muted">
        En attente de position GPS pour pr√©parer le SMS.
      </div>
      <div class="field">
        <button id="btnSms" class="btn btn-danger btn-icon" type="button">
          <span>‚úâÔ∏è</span><span>SMS d‚Äôurgence</span>
        </button>
      </div>
      <div class="settings-footer">
        Prototype perso ‚Äì pr√©cision typiquement ¬±100‚Äì200 m selon le GPS.  
        Utilise le recalage PK quand tu passes devant une borne.
      </div>
    </div>
  </div>

  <script>
  // === DONN√âES DE LIGNE =====================================================

  const stations = [
    { name: "St-Germain-en-Laye",      lat: 48.8984745677, lon: 2.0946251970, pk:    0 },
    { name: "Le V√©sinet ‚Äì Le Pecq",    lat: 48.8984530458, lon: 2.1222846835, pk:  2000 },
    { name: "Le V√©sinet ‚Äì Centre",     lat: 48.8901555110, lon: 2.1347027835, pk:  4000 },
    { name: "Chatou ‚Äì Croissy",        lat: 48.8854638305, lon: 2.1564040970, pk:  6000 },
    { name: "Rueil-Malmaison",         lat: 48.8877403423, lon: 2.1725468932, pk:  7000 },
    { name: "Nanterre-Ville",          lat: 48.8952086355, lon: 2.1957210472, pk:  8000 },
    { name: "Nanterre-Universit√©",     lat: 48.9009541230, lon: 2.2128683712, pk: 11000 },
    { name: "Nanterre-Pr√©fecture",     lat: 48.8958449352, lon: 2.2230702306, pk: 12000 },
    { name: "La D√©fense ‚Äì Grande Arche", lat: 48.8919045058, lon: 2.2385616258, pk: 13000 },
    { name: "Charles de Gaulle ‚Äì √âtoile", lat: 48.8742900059, lon: 2.2948848393, pk: 18000 },
    { name: "Auber",                   lat: 48.8725358497, lon: 2.3298119681, pk: 20000 },
    { name: "Ch√¢telet ‚Äì Les Halles",   lat: 48.8619752528, lon: 2.3469363528, pk: 22000 },
    { name: "Gare de Lyon",            lat: 48.8444873499, lon: 2.3743558393, pk: 25000 },
    { name: "Nation",                  lat: 48.8488218026, lon: 2.3970239229, pk: 27000 },
    { name: "Vincennes",               lat: 48.8475419027, lon: 2.4332766909, pk: 30000 },
    { name: "Fontenay-sous-Bois",      lat: 48.8457834716, lon: 2.4641534958, pk: 31500 },
    { name: "Val de Fontenay",         lat: 48.8544183594, lon: 2.4890884591, pk: 34000 },
    { name: "Neuilly-Plaisance",       lat: 48.8534646981, lon: 2.5138398779, pk: 36000 },
    { name: "Bry-sur-Marne",           lat: 48.8442657465, lon: 2.5261924528, pk: 38000 },
    { name: "Noisy-le-Grand ‚Äì Mont d‚ÄôEst", lat: 48.8410135149, lon: 2.5527359297, pk: 40000 },
    { name: "Noisy ‚Äì Champs",          lat: 48.8429502416, lon: 2.5788366796, pk: 42000 },
    { name: "Noisiel",                 lat: 48.8437650426, lon: 2.6160790153, pk: 44000 },
    { name: "Lognes",                  lat: 48.8393611271, lon: 2.6335250335, pk: 46000 },
    { name: "Torcy",                   lat: 48.8390276009, lon: 2.6550584298, pk: 48000 },
    { name: "Bussy-Saint-Georges",     lat: 48.8371826388, lon: 2.7125386010, pk: 52000 },
    { name: "Val d‚ÄôEurope",            lat: 48.8561684149, lon: 2.7738274672, pk: 57000 },
    { name: "Marne-la-Vall√©e ‚Äì Chessy",lat: 48.8707237150, lon: 2.7826307507, pk: 59000 }
  ];

  const linePoints = stations; // on utilise les gares comme points de la polyligne

  const sensitivityProfiles = {
    slow:   { idle: 0.15, walk: 1.5 },
    normal: { idle: 0.30, walk: 2.5 },
    train:  { idle: 1.00, walk: 6.0 }
  };

  // === √âTAT GLOBAL ==========================================================

  const state = {
    watchId: null,
    lastRawPk: null,
    lastPk: null,
    lastPkTime: null,
    lastLat: null,
    lastLon: null,
    lastDist: null,
    direction: null,  // "est" (vers Chessy) ou "ouest"
    nearestStation: null
  };

  let pkOffset = 0;
  let sosPhone = "";
  let motionSensitivity = "normal";
  let pkTarget = null;

  // === UTILITAIRES PK / GPS ================================================

  function formatPk(pkMeters) {
    if (pkMeters == null || isNaN(pkMeters)) return "‚Äî";
    const m = Math.round(pkMeters);
    const km = Math.floor(m / 1000);
    const rest = m % 1000;
    return km + "+" + rest.toString().padStart(3, "0");
  }

  function parsePkInput(str) {
    if (!str) return null;
    str = String(str).trim().replace(/\s+/g, "");
    if (/^\d+\+\d+$/.test(str)) {
      const [km, r] = str.split("+");
      return parseInt(km, 10) * 1000 + parseInt(r, 10);
    }
    if (/^\d+$/.test(str)) {
      return parseInt(str, 10);
    }
    return null;
  }

  function distanceMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function projectToSegment(lat, lon, a, b) {
    const meanLat = (a.lat + b.lat) / 2 * Math.PI/180;
    const cosLat = Math.cos(meanLat);

    const ax = a.lon * cosLat;
    const ay = a.lat;
    const bx = b.lon * cosLat;
    const by = b.lat;
    const px = lon * cosLat;
    const py = lat;

    const vx = bx - ax;
    const vy = by - ay;
    const wx = px - ax;
    const wy = py - ay;

    const c1 = vx * wx + vy * wy;
    const c2 = vx * vx + vy * vy;
    let t = c2 > 0 ? c1 / c2 : 0;
    if (t < 0) t = 0;
    if (t > 1) t = 1;

    const latProj = a.lat + (b.lat - a.lat) * t;
    const lonProj = a.lon + (b.lon - a.lon) * t;
    const pkProj = a.pk + (b.pk - a.pk) * t;
    const dist = distanceMeters(lat, lon, latProj, lonProj);

    return { latProj, lonProj, pkProj, dist };
  }

  function projectToLine(lat, lon) {
    let best = { dist: Infinity, pkProj: null, latProj: null, lonProj: null };
    for (let i = 0; i < linePoints.length - 1; i++) {
      const a = linePoints[i];
      const b = linePoints[i+1];
      const res = projectToSegment(lat, lon, a, b);
      if (res.dist < best.dist) {
        best = { dist: res.dist, pkProj: res.pkProj, latProj: res.latProj, lonProj: res.lonProj };
      }
    }
    return best;
  }

  function findNearestStation(pk) {
    if (pk == null) return null;
    let best = null;
    let bestDiff = Infinity;
    for (const st of stations) {
      const d = Math.abs(st.pk - pk);
      if (d < bestDiff) {
        bestDiff = d;
        best = st;
      }
    }
    return best;
  }

  function findNextStation(pk, direction) {
    if (pk == null) return null;
    let candidates;
    if (direction === "est") {
      candidates = stations.filter(s => s.pk > pk);
      candidates.sort((a,b) => a.pk - b.pk);
    } else if (direction === "ouest") {
      candidates = stations.filter(s => s.pk < pk);
      candidates.sort((a,b) => b.pk - a.pk);
    } else {
      return findNearestStation(pk);
    }
    return candidates[0] || findNearestStation(pk);
  }

  // === DOM ==================================================================

  const btnSettingsToggle = document.getElementById("btnSettingsToggle");
  const settingsPanel = document.getElementById("settingsPanel");

  const gpsStatusBadge = document.getElementById("gpsStatusBadge");
  const geolocText = document.getElementById("geolocText");
  const btnToggleGeoloc = document.getElementById("btnToggleGeoloc");

  const nearestStationName = document.getElementById("nearestStationName");
  const nearestStationInfo = document.getElementById("nearestStationInfo");

  const movementTitle = document.getElementById("movementTitle");
  const movementDetails = document.getElementById("movementDetails");

  const nextStationName = document.getElementById("nextStationName");
  const nextStationInfo = document.getElementById("nextStationInfo");

  const pkTargetLabel = document.getElementById("pkTargetLabel");
  const pkTargetInfo = document.getElementById("pkTargetInfo");
  const inputPkTarget = document.getElementById("inputPkTarget");
  const btnSetPkTarget = document.getElementById("btnSetPkTarget");

  const accessList = document.getElementById("accessList");

  const smsPreview = document.getElementById("smsPreview");
  const btnSms = document.getElementById("btnSms");

  // param√®tres
  const inputSosPhone = document.getElementById("inputSosPhone");
  const selectSensitivity = document.getElementById("selectSensitivity");
  const pkOffsetInfo = document.getElementById("pkOffsetInfo");
  const btnResetOffset = document.getElementById("btnResetOffset");
  const pkEstimateText = document.getElementById("pkEstimateText");
  const inputPkRecal = document.getElementById("inputPkRecal");
  const btnApplyRecal = document.getElementById("btnApplyRecal");
  const btnSaveSettings = document.getElementById("btnSaveSettings");

  // === GESTION PARAM√àTRES ===================================================

  function loadSettings() {
    const storedOffset = parseFloat(localStorage.getItem("pkOffset"));
    pkOffset = isNaN(storedOffset) ? 0 : storedOffset;

    sosPhone = localStorage.getItem("sosPhone") || "";
    motionSensitivity = localStorage.getItem("motionSensitivity") || "normal";

    inputSosPhone.value = sosPhone;
    selectSensitivity.value = motionSensitivity;
    updateOffsetInfo();
  }

  function updateOffsetInfo() {
    const val = Math.round(pkOffset);
    const sign = val === 0 ? "0" : (val > 0 ? "+"+val : ""+val);
    pkOffsetInfo.textContent = "Offset actuel : " + sign + " m appliqu√©s √† tous les PK.";
  }

  function saveSettings() {
    sosPhone = inputSosPhone.value.trim();
    motionSensitivity = selectSensitivity.value;
    localStorage.setItem("sosPhone", sosPhone);
    localStorage.setItem("motionSensitivity", motionSensitivity);
    localStorage.setItem("pkOffset", pkOffset);
    updateOffsetInfo();
  }

  function updatePkEstimateInSettings() {
    if (state.lastRawPk == null) {
      pkEstimateText.textContent = "En attente de position GPS‚Ä¶";
      return;
    }
    const corrected = state.lastRawPk + pkOffset;
    const pkText = "PK " + formatPk(corrected) +
      " (~" + Math.round(corrected) + " m depuis l‚Äôorigine de la ligne)";
    const distText = state.lastDist != null
      ? " ~ " + Math.round(state.lastDist) + " m de la voie (projection)."
      : "";
    pkEstimateText.textContent = pkText + distText;
  }

  // === G√âOLOCALISATION ======================================================

  let geolocActive = false;

  function setGpsStatus(status, message) {
    if (status === "off") {
      gpsStatusBadge.className = "badge badge-danger";
      gpsStatusBadge.textContent = "GPS inactif";
      geolocText.textContent = message || "Position non encore re√ßue.";
    } else if (status === "on") {
      gpsStatusBadge.className = "badge badge-good";
      gpsStatusBadge.textContent = "GPS actif";
      if (message) geolocText.textContent = message;
    } else if (status === "error") {
      gpsStatusBadge.className = "badge badge-danger";
      gpsStatusBadge.textContent = "Erreur GPS";
      geolocText.textContent = message ||
        "Impossible d‚Äôobtenir la position. V√©rifie que la g√©olocalisation est autoris√©e pour ce site.";
    }
  }

  function startGeoloc() {
    if (!navigator.geolocation) {
      setGpsStatus("error", "Ce navigateur ne supporte pas la g√©olocalisation.");
      return;
    }
    if (geolocActive) return;

    geolocActive = true;
    btnToggleGeoloc.innerHTML = "Arr√™ter la g√©oloc";
    setGpsStatus("on", "En attente d‚Äôun premier point‚Ä¶");

    state.watchId = navigator.geolocation.watchPosition(
      handlePosition,
      handleGeolocError,
      { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 }
    );
  }

  function stopGeoloc() {
    if (state.watchId != null) {
      navigator.geolocation.clearWatch(state.watchId);
      state.watchId = null;
    }
    geolocActive = false;
    btnToggleGeoloc.innerHTML = "D√©marrer la g√©oloc";
    setGpsStatus("off");
  }

  function handleGeolocError(err) {
    setGpsStatus("error");
    console.error(err);
  }

  function handlePosition(pos) {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    setGpsStatus("on", "Position re√ßue (lat : " +
      lat.toFixed(5) + ", lon : " + lon.toFixed(5) + ")");

    const proj = projectToLine(lat, lon);
    if (proj.pkProj == null) return;

    const rawPk = proj.pkProj;
    const correctedPk = rawPk + pkOffset;
    const now = Date.now() / 1000;

    // mouvement / direction
    if (state.lastPk != null && state.lastPkTime != null) {
      const dPk = correctedPk - state.lastPk;
      const dt = now - state.lastPkTime;
      if (dt > 1) {
        updateMovement(dPk, dt);
      }
    } else {
      movementTitle.textContent = "En attente d‚Äôun deuxi√®me point‚Ä¶";
      movementDetails.textContent = "‚Äî";
    }

    state.lastRawPk = rawPk;
    state.lastPk = correctedPk;
    state.lastPkTime = now;
    state.lastLat = lat;
    state.lastLon = lon;
    state.lastDist = proj.dist;

    // gares & acc√®s
    const nearest = findNearestStation(correctedPk);
    state.nearestStation = nearest;
    updateNearestStation(correctedPk, nearest);
    updateNextStation(correctedPk);
    updatePkTargetView();
    updateAccessList(correctedPk);
    updateSmsPreview();
    updatePkEstimateInSettings();
  }

  function updateMovement(dPk, dt) {
    const profile = sensitivityProfiles[motionSensitivity] || sensitivityProfiles.normal;
    const speed = Math.abs(dPk) / dt; // m/s

    if (dPk > 0) state.direction = "est";
    else if (dPk < 0) state.direction = "ouest";

    const dirLabel = state.direction === "est" ? "vers Chessy"
                    : state.direction === "ouest" ? "vers St-Germain / Paris"
                    : "";

    const distText = "ŒîPK ‚âà " + Math.round(Math.abs(dPk)) +
      " m sur ~" + Math.round(dt) + " s.";

    if (speed < profile.idle) {
      movementTitle.textContent = "Quasi immobile";
      movementDetails.textContent = distText;
    } else if (speed < profile.walk) {
      movementTitle.textContent = "√Ä pied " + dirLabel;
      movementDetails.textContent = distText + " (‚âà " + speed.toFixed(1) + " m/s)";
    } else {
      movementTitle.textContent = "Train " + dirLabel;
      movementDetails.textContent = distText + " (‚âà " + speed.toFixed(1) + " m/s)";
    }
  }

  function updateNearestStation(pk, nearest) {
    if (!nearest || pk == null) {
      nearestStationName.textContent = "Aucune";
      nearestStationInfo.textContent = "En attente de position GPS‚Ä¶";
      return;
    }
    nearestStationName.textContent = nearest.name;
    const delta = Math.round(Math.abs(nearest.pk - pk));
    nearestStationInfo.textContent =
      "PK " + formatPk(nearest.pk) + " ¬∑ ŒîPK ‚âà " + delta + " m";
  }

  function updateNextStation(pk) {
    if (pk == null) {
      nextStationName.textContent = "Aucune";
      nextStationInfo.textContent = "En attente de position GPS‚Ä¶";
      return;
    }
    const next = findNextStation(pk, state.direction);
    if (!next) {
      nextStationName.textContent = "Aucune";
      nextStationInfo.textContent = "‚Äî";
      return;
    }
    nextStationName.textContent = next.name;
    const delta = Math.round(Math.abs(next.pk - pk));
    const dir = next.pk >= pk ? "vers Chessy" : "vers St-Germain / Paris";
    nextStationInfo.textContent =
      "PK " + formatPk(next.pk) + " ¬∑ ‚âà " + delta + " m " + dir;
  }

  function updatePkTargetView() {
    if (!pkTarget) {
      pkTargetLabel.textContent = "Aucun";
      pkTargetInfo.textContent =
        "Saisis un PK puis clique sur ¬´ D√©finir ce PK comme cible ¬ª.";
      return;
    }
    pkTargetLabel.textContent = "PK " + formatPk(pkTarget);
    if (state.lastPk == null) {
      pkTargetInfo.textContent = "En attente de position GPS‚Ä¶";
      return;
    }
    const delta = pkTarget - state.lastPk;
    const dist = Math.round(Math.abs(delta));
    const dir = delta >= 0 ? "vers Chessy" : "vers St-Germain / Paris";
    pkTargetInfo.textContent = "‚âà " + dist + " m " + dir;
  }

  function updateAccessList(pk) {
    if (pk == null) {
      accessList.textContent = "En attente de position GPS‚Ä¶";
      return;
    }
    const sorted = stations.slice().sort(
      (a,b) => Math.abs(a.pk - pk) - Math.abs(b.pk - pk)
    );
    const top3 = sorted.slice(0,3);
    if (!top3.length) {
      accessList.textContent = "Aucun point disponible.";
      return;
    }
    const lines = top3.map(st => {
      const delta = Math.round(Math.abs(st.pk - pk));
      const dir = st.pk >= pk ? "vers Chessy" : "vers St-Germain / Paris";
      return (
        '<div class="access-item">' +
        '<div><strong>PK ' + formatPk(st.pk) + "</strong> ‚Äì " + st.name + "</div>" +
        '<div class="muted">ŒîPK ‚âà ' + delta + " m " + dir + "</div>" +
        "</div>"
      );
    });
    accessList.innerHTML = lines.join("");
  }

  function updateSmsPreview() {
    if (state.lastPk == null || !state.nearestStation || state.lastLat == null) {
      smsPreview.textContent =
        "En attente de position GPS pour pr√©parer le SMS.";
      return;
    }
    const pkText = "PK " + formatPk(state.lastPk);
    const nearestName = state.nearestStation.name;
    const base =
      pkText + ", gare la plus proche : " + nearestName +
      ", lat " + state.lastLat.toFixed(5) +
      ", lon " + state.lastLon.toFixed(5) + ".";
    const numPart = " Num√©ro utilis√© : " +
      (sosPhone ? sosPhone : "aucun (√† d√©finir dans Param√®tres).");
    smsPreview.textContent = base + numPart;
  }

  function sendSms() {
    if (state.lastPk == null || state.lastLat == null || !state.nearestStation) {
      alert("Position GPS insuffisante pour pr√©parer le SMS.");
      return;
    }
    const pkText = "PK " + formatPk(state.lastPk);
    const nearestName = state.nearestStation.name;
    const message =
      pkText + ", gare la plus proche : " + nearestName +
      ", lat " + state.lastLat.toFixed(5) +
      ", lon " + state.lastLon.toFixed(5);

    const body = encodeURIComponent(message);
    const numberPart = sosPhone ? encodeURIComponent(sosPhone) : "";
    const url = numberPart
      ? "sms:" + numberPart + "?&body=" + body
      : "sms:?&body=" + body;

    window.location.href = url;
  }

  // === LISTENERS ============================================================

  btnSettingsToggle.addEventListener("click", () => {
    const isVisible = settingsPanel.style.display !== "none";
    settingsPanel.style.display = isVisible ? "none" : "block";
  });

  btnToggleGeoloc.addEventListener("click", () => {
    if (geolocActive) stopGeoloc();
    else startGeoloc();
  });

  btnSetPkTarget.addEventListener("click", () => {
    const val = parsePkInput(inputPkTarget.value);
    if (val == null) {
      alert("PK cible invalide. Utilise 32400 ou 32+400.");
      return;
    }
    pkTarget = val;
    updatePkTargetView();
  });

  btnSms.addEventListener("click", sendSms);

  btnResetOffset.addEventListener("click", () => {
    pkOffset = 0;
    localStorage.setItem("pkOffset", pkOffset);
    updateOffsetInfo();
    updatePkEstimateInSettings();
    if (state.lastPk != null) {
      // recalculer avec nouvel offset
      state.lastPk = state.lastRawPk;
      updateNearestStation(state.lastPk, findNearestStation(state.lastPk));
      updateNextStation(state.lastPk);
      updatePkTargetView();
      updateAccessList(state.lastPk);
      updateSmsPreview();
    }
  });

  btnApplyRecal.addEventListener("click", () => {
    const exactPk = parsePkInput(inputPkRecal.value);
    if (exactPk == null) {
      alert("PK invalide. Utilise 52700 ou 52+700.");
      return;
    }
    if (state.lastRawPk == null) {
      alert("Pas de position GPS pour recaler. Lance la g√©oloc d‚Äôabord.");
      return;
    }
    pkOffset = exactPk - state.lastRawPk;
    localStorage.setItem("pkOffset", pkOffset);
    updateOffsetInfo();
    updatePkEstimateInSettings();
  });

  btnSaveSettings.addEventListener("click", () => {
    saveSettings();
    updateSmsPreview();
  });

  selectSensitivity.addEventListener("change", () => {
    motionSensitivity = selectSensitivity.value;
    localStorage.setItem("motionSensitivity", motionSensitivity);
  });

  // === INIT =================================================================

  loadSettings();
  updateSmsPreview();
  setGpsStatus("off");
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PK Assistant ‚Äì RER A</title>
<style>
  :root {
    --bg: #050010;
    --card: rgba(255,255,255,0.06);
    --border-soft: rgba(255,255,255,0.12);
    --accent: #b84cff;
    --accent-dark: #4500a8;
    --text-main: #f5f5f7;
    --text-soft: #d0cfe6;
    --warn: #ffb84d;
    --danger: #ff5c5c;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    padding: 0 8px 16px;
    background: radial-gradient(circle at top, #1a0035 0%, #050010 60%, #000000 100%);
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    text-align: center;
  }

  .header {
    margin-top: 16px;
    margin-bottom: 8px;
    text-align: center;
  }

  .title-pill {
    margin: 0 auto 6px auto;
    display: inline-block;
    padding: 10px 26px;
    border-radius: 999px;
    background: radial-gradient(circle at center, var(--accent) 0%, var(--accent-dark) 80%);
    box-shadow: 0 0 18px rgba(99, 45, 255, 0.9);
  }

  .title-main {
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: 0.06em;
  }

  .title-sub {
    font-size: 1.05rem;
    opacity: 0.9;
    margin-top: 2px;
  }

  .subtitle {
    font-size: 0.9rem;
    color: var(--text-soft);
    margin-top: 4px;
  }

  .note {
    font-size: 0.8rem;
    color: var(--warn);
    margin-top: 3px;
  }

  main {
    max-width: 520px;
    margin: 0 auto;
  }

  .card {
    background-color: var(--card);
    border-radius: 14px;
    padding: 10px 12px;
    margin: 10px 0;
    box-shadow: 0 0 10px rgba(0,0,0,0.4);
    text-align: left;
  }

  .card h2 {
    margin: 0 0 6px 0;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-soft);
  }

  .badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
    margin-left: 4px;
  }

  .badge-ok {
    background-color: #163e20;
    color: #86ff9c;
  }

  .badge-off {
    background-color: #3a1a1a;
    color: #ff9b9b;
  }

  .badge-branch {
    background-color: rgba(184,76,255,0.16);
    color: var(--accent);
  }

  .value-main {
    font-size: 1.2rem;
    font-weight: 600;
  }

  .value-soft {
    font-size: 0.9rem;
    color: var(--text-soft);
  }

  .row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin: 4px 0;
  }

  .row-col {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  button {
    border: none;
    border-radius: 999px;
    padding: 8px 14px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    color: #fff;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(100, 60, 255, 0.7);
  }

  button.secondary {
    background: #2b2750;
    box-shadow: none;
  }

  button.danger {
    background: linear-gradient(135deg, #ff5c5c, #c81f1f);
    box-shadow: 0 0 10px rgba(255, 80, 80, 0.6);
  }

  button:active {
    transform: scale(0.97);
  }

  input, select, textarea {
    width: 100%;
    border-radius: 10px;
    border: 1px solid var(--border-soft);
    padding: 7px 9px;
    background-color: rgba(4, 0, 20, 0.9);
    color: var(--text-main);
    font-size: 0.9rem;
  }

  textarea {
    resize: vertical;
    min-height: 70px;
  }

  label {
    font-size: 0.85rem;
    color: var(--text-soft);
    display: block;
    margin-bottom: 3px;
  }

  .small {
    font-size: 0.8rem;
    color: var(--text-soft);
  }

  .warning {
    color: var(--warn);
  }

  .settings-panel {
    background-color: rgba(10,0,30,0.98);
    border-radius: 16px;
    margin-top: 10px;
    padding: 10px 12px 14px;
    border: 1px solid var(--border-soft);
  }

  .settings-panel h3 {
    margin: 0 0 6px 0;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .settings-row {
    margin: 6px 0;
  }

  .chip-list {
    font-size: 0.8rem;
    color: var(--text-soft);
  }

  .chip {
    display: inline-block;
    padding: 2px 7px;
    margin: 1px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.15);
  }

  .hidden {
    display: none;
  }
</style>
</head>

<body>
  <div class="header">
    <div class="title-pill">
      <div class="title-main">PK ASSISTANT</div>
      <div class="title-sub">RER A</div>
    </div>
    <div class="subtitle">Estimation du PK en temps r√©el √† partir de la g√©olocalisation.</div>
    <div class="note">Diff√©rence typique : de l‚Äôordre de 100 √† 200 m, √† recaler avec une borne PK.</div>
  </div>

  <main>
    <!-- G√âOLOCALISATION -->
    <div class="card">
      <h2>
        G√©olocalisation
        <span id="gpsBadge" class="badge badge-off">GPS inactif</span>
      </h2>
      <p id="gpsStatus" class="small">Position non encore re√ßue.</p>
      <div class="row">
        <button id="btnToggleGps">D√©marrer la g√©oloc</button>
      </div>
    </div>

    <!-- INFO PK / GARE / BRANCHE / SENS -->
    <div class="card">
      <h2>Position sur la ligne</h2>
      <div class="row">
        <div class="row-col" style="flex:2;">
          <span class="value-soft">PK estim√©</span>
          <span class="value-main" id="pkDisplay">‚Äî</span>
          <span class="small warning">Position estim√©e : <span id="pkPhrase">‚Äî</span></span>
          <span class="small warning">Pr√©cision typique : ¬±100‚Äì200 m selon le GPS.</span>
        </div>
        <div class="row-col" style="flex:1;">
          <span class="value-soft">Branche</span>
          <span class="badge badge-branch" id="branchName">‚Äî</span>
        </div>
      </div>

      <div class="row">
        <div class="row-col" style="flex:1;">
          <span class="value-soft">Gare la plus proche</span>
          <span id="nearestStation" class="value-main" style="font-size:1rem;">Aucune</span>
        </div>
        <div class="row-col" style="flex:1;">
          <span class="value-soft">Prochaine gare</span>
          <span id="nextStation" class="value-main" style="font-size:1rem;">‚Äî</span>
        </div>
      </div>

      <div class="row">
        <div class="row-col" style="flex:1;">
          <span class="value-soft">Sens / mouvement</span>
          <span id="movementInfo" class="small">En attente d‚Äôun deuxi√®me point‚Ä¶</span>
        </div>
      </div>
    </div>

    <!-- PK CIBLE -->
    <div class="card">
      <h2>PK cible</h2>
      <p class="small">Saisis un PK pour suivre ta progression vers un point pr√©cis (ex : 32400).</p>
      <div class="row">
        <input id="inputPkTarget" type="text" placeholder="ex : 32400 ou 32+400" />
      </div>
      <div class="row" style="margin-top:4px;">
        <button id="btnSetPkTarget" class="secondary">D√©finir ce PK comme cible</button>
      </div>
      <p class="small">
        PK cible actuel : <span id="pkTargetLabel">aucun</span><br />
        √âcart √† la cible : <span id="pkTargetDelta">‚Äî</span>
      </p>
    </div>

    <!-- ACC√àS LES PLUS PROCHES -->
    <div class="card">
      <h2>Acc√®s / gares les plus proches (en PK)</h2>
      <p class="small">Top 3 calcul√© √† partir de ton PK estim√©.</p>
      <div id="accessList" class="chip-list">
        En attente de position GPS‚Ä¶
      </div>
    </div>

    <!-- URGENCE -->
    <div class="card">
      <h2>Urgence / partage position</h2>
      <p class="small">Pr√©pare un message avec PK, gare la plus proche et lien Maps, pr√™t √† coller dans SMS / WhatsApp.</p>
      <button id="btnEmergency" class="danger">‚úâÔ∏è Pr√©parer le message d‚Äôurgence</button>
      <p id="emergencyPreview" class="small" style="margin-top:6px;"></p>
    </div>

    <!-- BOUTON PARAM√àTRES -->
    <div class="card" style="text-align:center;">
      <button id="btnSettingsToggle" class="secondary">‚öôÔ∏è Param√®tres</button>
    </div>

    <!-- PANEL PARAM√àTRES -->
    <div id="settingsPanel" class="settings-panel hidden">
      <h3>Param√®tres</h3>

      <!-- Num√©ro SOS -->
      <div class="settings-row">
        <label for="inputSosPhone">Num√©ro SOS pour le SMS d‚Äôurgence</label>
        <input id="inputSosPhone" type="tel" placeholder="ex : 06 12 34 56 78" />
        <p class="small">Utilis√© uniquement dans le texte g√©n√©r√©, rien n‚Äôest envoy√© automatiquement.</p>
      </div>

      <!-- Sensibilit√© mouvement -->
      <div class="settings-row">
        <label for="selectSensitivity">Sensibilit√© au mouvement</label>
        <select id="selectSensitivity">
          <option value="low">Tr√®s sensible (marche lente)</option>
          <option value="normal" selected>Normal</option>
          <option value="high">Mouvement franc uniquement</option>
        </select>
        <p class="small">Ajuste le seuil pour d√©tecter le sens (vers Paris ou vers Boissy / Chessy).</p>
      </div>

      <!-- Recalage PK -->
      <div class="settings-row">
        <label>Recalage PK (offset global)</label>
        <p class="small">
          Offset actuel : <span id="pkOffsetInfo">0 m</span><br />
          Position PK estim√©e (brute) : <span id="pkEstimateRaw">‚Äî</span><br />
          Position PK affich√©e (avec offset) : <span id="pkEstimateAdj">‚Äî</span>
        </p>
        <input id="inputPkRecal" type="text" placeholder="PK exact ici (ex : 32400 ou 32+400)" />
        <div style="margin-top:4px;">
          <button id="btnApplyRecal" class="secondary">Recaler l‚Äôappli sur ce PK</button>
          <button id="btnResetOffset" class="secondary">R√©initialiser le recalage PK</button>
        </div>
      </div>

      <!-- Recherche par PK : acc√®s le plus proche -->
      <div class="settings-row">
        <label for="inputPkLookup">Recherche par PK (acc√®s / gare la plus proche)</label>
        <input id="inputPkLookup" type="text" placeholder="ex : 32400 ou 32+400" />
        <div style="margin-top:4px;">
          <button id="btnPkLookup" class="secondary">Rechercher</button>
        </div>
        <p id="pkLookupResultField" class="small">
          R√©sultat : <span id="pkLookupResult">‚Äî</span>
        </p>
      </div>

      <!-- Avarie / incident -->
      <div class="settings-row">
        <label>Signalement d‚Äôavarie / incident (brouillon)</label>
        <select id="selectIncidentType">
          <option value="cheminement">Cheminement</option>
          <option value="rail casse">Rail cass√©</option>
          <option value="animal mort">Animal mort</option>
          <option value="autre">Autre (√† pr√©ciser)</option>
        </select>
        <div id="incidentOtherField" style="margin-top:4px; display:none;">
          <input id="inputIncidentOther" type="text" placeholder="Pr√©ciser l‚Äôincident‚Ä¶" />
        </div>
        <p class="small" style="margin-top:4px;">
          (Optionnel) Tu peux prendre une photo avec l‚Äôappareil de ton t√©l√©phone, puis mentionner ‚Äúphoto jointe‚Äù dans le message.
        </p>
        <button id="btnGenerateIncident" class="secondary" style="margin-top:4px;">G√©n√©rer le texte de signalement</button>
        <div id="incidentResultField" class="small" style="margin-top:6px; display:none;">
          <p>Texte g√©n√©r√© :</p>
          <textarea id="incidentResultText" readonly></textarea>
          <button id="btnCopyIncident" class="secondary" style="margin-top:4px;">Copier le texte</button>
        </div>
      </div>

      <div class="settings-row" style="margin-top:8px; text-align:center;">
        <button id="btnSaveSettings" class="secondary">Enregistrer les param√®tres</button>
      </div>

      <p class="small" style="margin-top:4px;">
        Ces r√©glages restent stock√©s dans ton navigateur (localStorage) sur cet appareil uniquement.
      </p>
    </div>
  </main>

<script>
// ========================= DONN√âES LIGNE ===========================
const troncCommun = [
  { name: "St-Germain-en-Laye",           lat: 48.89847, lon: 2.09463, pk: 0 },
  { name: "Le V√©sinet ‚Äì Le Pecq",         lat: 48.89845, lon: 2.12228, pk: 2000 },
  { name: "Le V√©sinet ‚Äì Centre",          lat: 48.89016, lon: 2.13470, pk: 4000 },
  { name: "Chatou ‚Äì Croissy",             lat: 48.88546, lon: 2.15640, pk: 6000 },
  { name: "Rueil-Malmaison",              lat: 48.88774, lon: 2.17255, pk: 7000 },
  { name: "Nanterre-Ville",               lat: 48.89521, lon: 2.19572, pk: 8000 },
  { name: "Nanterre-Universit√©",          lat: 48.90095, lon: 2.21287, pk: 11000 },
  { name: "Nanterre-Pr√©fecture",          lat: 48.89584, lon: 2.22307, pk: 12000 },
  { name: "La D√©fense ‚Äì Grande Arche",    lat: 48.89190, lon: 2.23856, pk: 13000 },
  { name: "Charles de Gaulle ‚Äì √âtoile",   lat: 48.87429, lon: 2.29488, pk: 18000 },
  { name: "Auber",                        lat: 48.87254, lon: 2.32981, pk: 20000 },
  { name: "Ch√¢telet ‚Äì Les Halles",        lat: 48.86198, lon: 2.34694, pk: 22000 },
  { name: "Gare de Lyon",                 lat: 48.84449, lon: 2.37436, pk: 25000 },
  { name: "Nation",                       lat: 48.84882, lon: 2.39702, pk: 27000 },
  { name: "Vincennes",                    lat: 48.84754, lon: 2.43328, pk: 30000 },
  { name: "Fontenay-sous-Bois",           lat: 48.84578, lon: 2.46415, pk: 31500 },
  { name: "Val de Fontenay",              lat: 48.85442, lon: 2.48909, pk: 34000 }
];

const brancheBoissy = [
  { name: "Nogent-sur-Marne",             lat: 48.83540, lon: 2.47166, pk: 35500 },
  { name: "Joinville-le-Pont",            lat: 48.82118, lon: 2.46414, pk: 37000 },
  { name: "Saint-Maur ‚Äì Cr√©teil",         lat: 48.80882, lon: 2.47080, pk: 38500 },
  { name: "La Varenne ‚Äì Chennevi√®res",    lat: 48.79420, lon: 2.51351, pk: 40000 },
  { name: "Sucy ‚Äì Bonneuil",              lat: 48.77099, lon: 2.50838, pk: 41500 },
  { name: "Boissy-Saint-L√©ger",           lat: 48.75399, lon: 2.50598, pk: 43000 }
];

const brancheChessy = [
  { name: "Neuilly-Plaisance",            lat: 48.85346, lon: 2.51384, pk: 35500 },
  { name: "Bry-sur-Marne",                lat: 48.84427, lon: 2.52619, pk: 37000 },
  { name: "Noisy-le-Grand ‚Äì Mont d‚ÄôEst",  lat: 48.84101, lon: 2.55274, pk: 39000 },
  { name: "Noisy ‚Äì Champs",               lat: 48.84295, lon: 2.57884, pk: 41000 },
  { name: "Noisiel",                      lat: 48.84377, lon: 2.61608, pk: 43000 },
  { name: "Lognes",                       lat: 48.83936, lon: 2.63353, pk: 45000 },
  { name: "Torcy",                        lat: 48.83903, lon: 2.65506, pk: 47000 },
  { name: "Bussy-Saint-Georges",          lat: 48.83718, lon: 2.71254, pk: 52000 },
  { name: "Val d‚ÄôEurope",                 lat: 48.85617, lon: 2.77383, pk: 57000 },
  { name: "Marne-la-Vall√©e ‚Äì Chessy",     lat: 48.87072, lon: 2.78263, pk: 59000 }
];

const accessPoints = [
  ...troncCommun,
  ...brancheBoissy,
  ...brancheChessy
];

// ========================= OUTILS G√âO / PK ===========================
const R_EARTH = 6371000;

function distanceMeters(lat1, lon1, lat2, lon2) {
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
            Math.sin(dLon/2)**2;
  return R_EARTH * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function toXY(lat, lon, lat0) {
  const rad = Math.PI / 180;
  const mPerDegLat = 111320;
  const mPerDegLon = 111320 * Math.cos(lat0 * rad);
  return {
    x: lon * mPerDegLon,
    y: lat * mPerDegLat
  };
}

function detectBranch(lat, lon) {
  const dBoissy = distanceMeters(lat, lon, brancheBoissy[0].lat, brancheBoissy[0].lon);
  const dChessy = distanceMeters(lat, lon, brancheChessy[0].lat, brancheChessy[0].lon);
  return dBoissy < dChessy ? "Boissy" : "Chessy";
}

function projectToLine(lat, lon, line) {
  if (line.length < 2) return { pk: line[0].pk, dist: 0 };
  const lat0 = line[0].lat;
  const p = toXY(lat, lon, lat0);
  let bestDist = Infinity;
  let bestPk = line[0].pk;

  for (let i = 0; i < line.length - 1; i++) {
    const a = line[i];
    const b = line[i+1];
    const aXY = toXY(a.lat, a.lon, lat0);
    const bXY = toXY(b.lat, b.lon, lat0);
    const vx = bXY.x - aXY.x;
    const vy = bXY.y - aXY.y;
    const wx = p.x - aXY.x;
    const wy = p.y - aXY.y;
    const c1 = vx*wx + vy*wy;
    const c2 = vx*vx + vy*vy;
    let t = c2 > 0 ? c1 / c2 : 0;
    if (t < 0) t = 0;
    if (t > 1) t = 1;
    const projX = aXY.x + t * vx;
    const projY = aXY.y + t * vy;
    const dx = p.x - projX;
    const dy = p.y - projY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist < bestDist) {
      bestDist = dist;
      const pk = a.pk + t * (b.pk - a.pk);
      bestPk = pk;
    }
  }
  return { pk: bestPk, dist: bestDist };
}

function nearestStationForLine(lat, lon, line) {
  let minD = Infinity, near = line[0];
  for (const s of line) {
    const d = distanceMeters(lat, lon, s.lat, s.lon);
    if (d < minD) { minD = d; near = s; }
  }
  return { station: near, dist: minD };
}

// ========================= √âTAT GLOBAL ===========================
let gpsWatchId = null;
let lastLat = null;
let lastLon = null;
let currentRawPk = null;   // PK sans offset
let pkOffset = 0;          // offset global
let currentBranch = "‚Äî";
let lastAdjPk = null;
let lastTime = null;
let movementSensitivity = "normal";
let pkTarget = null;

// ========================= R√âF√âRENCES DOM ===========================
const gpsBadgeEl = document.getElementById("gpsBadge");
const gpsStatusEl = document.getElementById("gpsStatus");
const pkDisplayEl = document.getElementById("pkDisplay");
const pkPhraseEl = document.getElementById("pkPhrase");
const nearestStationEl = document.getElementById("nearestStation");
const nextStationEl = document.getElementById("nextStation");
const branchNameEl = document.getElementById("branchName");
const movementInfoEl = document.getElementById("movementInfo");
const accessListEl = document.getElementById("accessList");
const emergencyPreviewEl = document.getElementById("emergencyPreview");
const btnToggleGps = document.getElementById("btnToggleGps");
const settingsPanelEl = document.getElementById("settingsPanel");
const btnSettingsToggle = document.getElementById("btnSettingsToggle");

// ========================= G√âOLOCALISATION ===========================
function updateGpsBadge(active) {
  if (active) {
    gpsBadgeEl.textContent = "GPS actif";
    gpsBadgeEl.classList.remove("badge-off");
    gpsBadgeEl.classList.add("badge-ok");
  } else {
    gpsBadgeEl.textContent = "GPS inactif";
    gpsBadgeEl.classList.remove("badge-ok");
    gpsBadgeEl.classList.add("badge-off");
  }
}

function startGeolocWatch() {
  if (!navigator.geolocation) {
    gpsStatusEl.textContent = "Le GPS n‚Äôest pas support√© sur cet appareil.";
    return;
  }
  updateGpsBadge(true);
  gpsStatusEl.textContent = "üì° Recherche GPS‚Ä¶";
  gpsWatchId = navigator.geolocation.watchPosition(
    handlePosition,
    handleError,
    { enableHighAccuracy: true, maximumAge: 1000 }
  );
  btnToggleGps.textContent = "Arr√™ter la g√©oloc";
}

function stopGeolocWatch() {
  if (gpsWatchId !== null && navigator.geolocation) {
    navigator.geolocation.clearWatch(gpsWatchId);
  }
  gpsWatchId = null;
  updateGpsBadge(false);
  gpsStatusEl.textContent = "GPS arr√™t√©.";
  btnToggleGps.textContent = "D√©marrer la g√©oloc";
}

btnToggleGps.addEventListener("click", () => {
  if (gpsWatchId === null) startGeolocWatch();
  else stopGeolocWatch();
});

function getSpeedThreshold() {
  switch (movementSensitivity) {
    case "low": return 0.2;
    case "high": return 1.0;
    case "normal":
    default: return 0.5;
  }
}

function handlePosition(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  lastLat = lat;
  lastLon = lon;

  gpsStatusEl.textContent = `‚úÖ GPS actif (${lat.toFixed(5)}, ${lon.toFixed(5)})`;

  currentBranch = detectBranch(lat, lon);
  branchNameEl.textContent = currentBranch;

  const line = troncCommun.concat(
    currentBranch === "Boissy" ? brancheBoissy : brancheChessy
  );

  const proj = projectToLine(lat, lon, line);
  currentRawPk = proj.pk;
  const adjPk = currentRawPk + pkOffset;

  pkDisplayEl.textContent = `${Math.round(adjPk)} m`;
  pkPhraseEl.textContent = `PK ${Math.round(adjPk)} m`;

  const nearest = nearestStationForLine(lat, lon, line);
  nearestStationEl.textContent = nearest.station.name;

  updateMovementAndNextStation(adjPk, line);
  updateAccessList(adjPk);
  updatePkTargetDelta(adjPk);
  updateRecalPanel();
}

function handleError(err) {
  gpsStatusEl.textContent = "‚ö†Ô∏è Erreur GPS : " + err.message;
  updateGpsBadge(false);
}

// ========================= MOUVEMENT / SENS ===========================
function updateMovementAndNextStation(adjPk, line) {
  const now = Date.now();
  if (lastAdjPk === null || lastTime === null) {
    movementInfoEl.textContent = "En attente d‚Äôun deuxi√®me point‚Ä¶";
  } else {
    const dt = (now - lastTime) / 1000;
    const dPk = adjPk - lastAdjPk;
    const speed = Math.abs(dPk) / dt; // m/s
    const threshold = getSpeedThreshold();

    if (dt > 2 && speed > threshold) {
      const directionForward = dPk > 0;
      const kmh = speed * 3.6;
      const sensTexte =
        (currentBranch === "Boissy"
          ? (directionForward ? "vers Boissy-Saint-L√©ger" : "vers Paris")
          : (directionForward ? "vers Marne-la-Vall√©e ‚Äì Chessy" : "vers Paris"));

      movementInfoEl.textContent =
        `En mouvement ${sensTexte} (~${kmh.toFixed(1)} km/h)`;
      updateNextStation(adjPk, line, directionForward);
    } else {
      movementInfoEl.textContent = "Quasi immobile (d√©calage GPS ou arr√™t).";
      updateNextStation(adjPk, line, null);
    }
  }

  lastAdjPk = adjPk;
  lastTime = now;
}

function updateNextStation(adjPk, line, directionForward) {
  let next = null;
  if (directionForward === null) {
    for (let i = 0; i < line.length; i++) {
      if (line[i].pk >= adjPk) { next = line[i]; break; }
    }
  } else if (directionForward) {
    for (let i = 0; i < line.length; i++) {
      if (line[i].pk > adjPk) { next = line[i]; break; }
    }
  } else {
    for (let i = line.length-1; i >= 0; i--) {
      if (line[i].pk < adjPk) { next = line[i]; break; }
    }
  }
  nextStationEl.textContent = next ? next.name : "‚Äî";
}

// ========================= ACC√àS PROCHES ===========================
function updateAccessList(adjPk) {
  if (adjPk == null) {
    accessListEl.textContent = "En attente de position GPS‚Ä¶";
    return;
  }
  const items = accessPoints
    .map(a => ({
      name: a.name,
      pk: a.pk,
      diff: Math.abs(a.pk - adjPk)
    }))
    .sort((a,b) => a.diff - b.diff)
    .slice(0, 3);

  accessListEl.innerHTML = "";
  items.forEach(item => {
    const span = document.createElement("span");
    span.className = "chip";
    const sign = item.pk >= adjPk ? "+" : "‚Äì";
    const diff = Math.round(Math.abs(item.pk - adjPk));
    span.textContent = `${item.name} (PK ${item.pk} m, ${sign}${diff} m)`;
    accessListEl.appendChild(span);
  });
}

// ========================= PK CIBLE ===========================
const pkTargetLabelEl = document.getElementById("pkTargetLabel");
const pkTargetDeltaEl = document.getElementById("pkTargetDelta");
const inputPkTargetEl = document.getElementById("inputPkTarget");
document.getElementById("btnSetPkTarget").addEventListener("click", () => {
  const val = parsePkFromInput(inputPkTargetEl.value);
  if (val == null) {
    alert("PK invalide. Exemples valides : 32400 ou 32+400.");
    return;
  }
  pkTarget = val;
  pkTargetLabelEl.textContent = `${pkTarget} m`;
  if (currentRawPk != null) {
    updatePkTargetDelta(currentRawPk + pkOffset);
  }
});

function parsePkFromInput(str) {
  if (!str) return null;
  const clean = str.replace(/\s/g, "");
  const plusIdx = clean.indexOf("+");
  if (plusIdx !== -1) {
    const km = parseInt(clean.slice(0, plusIdx), 10);
    const m = parseInt(clean.slice(plusIdx+1), 10);
    if (isNaN(km) || isNaN(m)) return null;
    return km*1000 + m;
  } else {
    const v = parseInt(clean, 10);
    return isNaN(v) ? null : v;
  }
}

function updatePkTargetDelta(adjPk) {
  if (pkTarget == null || adjPk == null) {
    pkTargetDeltaEl.textContent = "‚Äî";
    return;
  }
  const diff = pkTarget - adjPk;
  const sign = diff > 0 ? "+" : "‚Äì";
  pkTargetDeltaEl.textContent = `${sign}${Math.abs(Math.round(diff))} m`;
}

// ========================= PARAM√àTRES ===========================
btnSettingsToggle.addEventListener("click", () => {
  settingsPanelEl.classList.toggle("hidden");
});

// stockage local
const STORAGE_KEYS = {
  SOS_PHONE: "pkassistant_sos_phone",
  PK_OFFSET: "pkassistant_pk_offset",
  SENSITIVITY: "pkassistant_sensitivity"
};

const inputSosPhoneEl = document.getElementById("inputSosPhone");
const selectSensitivityEl = document.getElementById("selectSensitivity");
const pkOffsetInfoEl = document.getElementById("pkOffsetInfo");
const pkEstimateRawEl = document.getElementById("pkEstimateRaw");
const pkEstimateAdjEl = document.getElementById("pkEstimateAdj");
const inputPkRecalEl = document.getElementById("inputPkRecal");
const btnApplyRecalEl = document.getElementById("btnApplyRecal");
const btnResetOffsetEl = document.getElementById("btnResetOffset");
const inputPkLookupEl = document.getElementById("inputPkLookup");
const btnPkLookupEl = document.getElementById("btnPkLookup");
const pkLookupResultEl = document.getElementById("pkLookupResult");
const selectIncidentTypeEl = document.getElementById("selectIncidentType");
const incidentOtherFieldEl = document.getElementById("incidentOtherField");
const inputIncidentOtherEl = document.getElementById("inputIncidentOther");
const btnGenerateIncidentEl = document.getElementById("btnGenerateIncident");
const incidentResultFieldEl = document.getElementById("incidentResultField");
const incidentResultTextEl = document.getElementById("incidentResultText");
const btnCopyIncidentEl = document.getElementById("btnCopyIncident");
const btnSaveSettingsEl = document.getElementById("btnSaveSettings");

// init param√®tres
function loadSettings() {
  const storedPhone = localStorage.getItem(STORAGE_KEYS.SOS_PHONE);
  if (storedPhone) inputSosPhoneEl.value = storedPhone;

  const storedOffset = localStorage.getItem(STORAGE_KEYS.PK_OFFSET);
  if (storedOffset != null) pkOffset = parseFloat(storedOffset) || 0;

  const storedSens = localStorage.getItem(STORAGE_KEYS.SENSITIVITY);
  if (storedSens) {
    movementSensitivity = storedSens;
    selectSensitivityEl.value = storedSens;
  } else {
    movementSensitivity = "normal";
  }
  updateRecalPanel();
}
loadSettings();

selectSensitivityEl.addEventListener("change", () => {
  movementSensitivity = selectSensitivityEl.value;
});

btnSaveSettingsEl.addEventListener("click", () => {
  localStorage.setItem(STORAGE_KEYS.SOS_PHONE, inputSosPhoneEl.value || "");
  localStorage.setItem(STORAGE_KEYS.PK_OFFSET, String(pkOffset));
  localStorage.setItem(STORAGE_KEYS.SENSITIVITY, movementSensitivity);
  alert("Param√®tres enregistr√©s sur cet appareil.");
});

// panel recalage PK
function updateRecalPanel() {
  pkOffsetInfoEl.textContent = `${Math.round(pkOffset)} m`;
  if (currentRawPk == null) {
    pkEstimateRawEl.textContent = "‚Äî";
    pkEstimateAdjEl.textContent = "‚Äî";
  } else {
    pkEstimateRawEl.textContent = `${Math.round(currentRawPk)} m`;
    pkEstimateAdjEl.textContent = `${Math.round(currentRawPk + pkOffset)} m`;
  }
}

btnApplyRecalEl.addEventListener("click", () => {
  const val = parsePkFromInput(inputPkRecalEl.value);
  if (val == null || currentRawPk == null) {
    alert("Impossible de recalibrer : PK exact invalide ou pas de position.");
    return;
  }
  pkOffset = val - currentRawPk;
  localStorage.setItem(STORAGE_KEYS.PK_OFFSET, String(pkOffset));
  updateRecalPanel();
  if (currentRawPk != null) {
    const adjPk = currentRawPk + pkOffset;
    pkDisplayEl.textContent = `${Math.round(adjPk)} m`;
    pkPhraseEl.textContent = `PK ${Math.round(adjPk)} m`;
    updatePkTargetDelta(adjPk);
  }
  alert(`Offset mis √† jour : ${Math.round(pkOffset)} m`);
});

btnResetOffsetEl.addEventListener("click", () => {
  pkOffset = 0;
  localStorage.setItem(STORAGE_KEYS.PK_OFFSET, "0");
  updateRecalPanel();
  if (currentRawPk != null) {
    const adjPk = currentRawPk;
    pkDisplayEl.textContent = `${Math.round(adjPk)} m`;
    pkPhraseEl.textContent = `PK ${Math.round(adjPk)} m`;
    updatePkTargetDelta(adjPk);
  }
  alert("Offset PK r√©initialis√© √† 0 m.");
});

// recherche par PK
btnPkLookupEl.addEventListener("click", () => {
  const val = parsePkFromInput(inputPkLookupEl.value);
  if (val == null) {
    alert("PK invalide. Exemples valides : 32400 ou 32+400.");
    return;
  }
  const best = accessPoints
    .map(a => ({
      name: a.name,
      pk: a.pk,
      diff: Math.abs(a.pk - val)
    }))
    .sort((a,b) => a.diff - b.diff)[0];

  if (!best) {
    pkLookupResultEl.textContent = "Aucun acc√®s connu.";
  } else {
    const sign = best.pk >= val ? "+" : "‚Äì";
    pkLookupResultEl.textContent =
      `${best.name} (PK ${best.pk} m, ${sign}${Math.round(Math.abs(best.pk - val))} m)`;
  }
});

// champ "Autre" pour incident
selectIncidentTypeEl.addEventListener("change", () => {
  if (selectIncidentTypeEl.value === "autre") {
    incidentOtherFieldEl.style.display = "block";
  } else {
    incidentOtherFieldEl.style.display = "none";
  }
});

// g√©n√©ration texte avarie / incident
btnGenerateIncidentEl.addEventListener("click", () => {
  const type = selectIncidentTypeEl.value;
  const autre = inputIncidentOtherEl.value.trim();
  const incidentLabel = (type === "autre" && autre) ? autre : type;

  const pkText = currentRawPk != null
    ? `${Math.round(currentRawPk + pkOffset)} m (offset ${Math.round(pkOffset)} m)`
    : "‚Äî";
  const gareText = nearestStationEl.textContent || "‚Äî";
  const branchText = currentBranch || "‚Äî";
  const latText = lastLat != null ? lastLat.toFixed(6) : "";
  const lonText = lastLon != null ? lastLon.toFixed(6) : "";
  const mapsLink = (latText && lonText)
    ? `https://maps.google.com/?q=${latText},${lonText}`
    : "Position GPS non disponible";

  const now = new Date();
  const h = String(now.getHours()).padStart(2,"0");
  const m = String(now.getMinutes()).padStart(2,"0");

  const msg =
`Signalement avarie / incident ‚Äì RER A
Type : ${incidentLabel}
Heure approx : ${h}h${m}
Branche : ${branchText}
PK approx : ${pkText}
Gare la plus proche : ${gareText}
Lien carte : ${mapsLink}
Remarque : photo jointe si disponible.`;

  incidentResultTextEl.value = msg;
  incidentResultFieldEl.style.display = "block";
});

btnCopyIncidentEl.addEventListener("click", () => {
  incidentResultTextEl.select();
  try {
    document.execCommand("copy");
    alert("Texte de signalement copi√©.");
  } catch {
    alert("Copie impossible automatiquement. S√©lectionne le texte et copie-le manuellement.");
  }
});

// ========================= URGENCE ===========================
document.getElementById("btnEmergency").addEventListener("click", () => {
  const pkText = currentRawPk != null
    ? `${Math.round(currentRawPk + pkOffset)} m (offset ${Math.round(pkOffset)} m)`
    : "‚Äî";
  const gareText = nearestStationEl.textContent || "‚Äî";
  const branchText = currentBranch || "‚Äî";
  const sosPhone = inputSosPhoneEl.value || "num√©ro SOS √† compl√©ter";

  const latText = lastLat != null ? lastLat.toFixed(6) : "";
  const lonText = lastLon != null ? lastLon.toFixed(6) : "";
  const mapsLink = (latText && lonText)
    ? `https://maps.google.com/?q=${latText},${lonText}`
    : "Position GPS non disponible";

  const msg =
`‚ö†Ô∏è URGENCE RER A
Position estim√©e : PK ${pkText}
Branche : ${branchText}
Gare la plus proche : ${gareText}
Lien carte : ${mapsLink}
√Ä transmettre √† : ${sosPhone}`;

  emergencyPreviewEl.textContent = "Message g√©n√©r√©. Tu peux le copier depuis la bo√Æte de dialogue.";
  window.prompt("Copie ce message d'urgence :", msg);
});
</script>
</body>
</html>
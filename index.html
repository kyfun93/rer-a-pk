<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>PK RER A ‚Äì St-Germain ‚Üî Paris ‚Üî Chessy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #050509;
      --card: #101017;
      --card-soft: #151521;
      --border: #262636;
      --text: #f6f6ff;
      --muted: #a4a4c0;
      --accent: #2f8cff;
      --accent-soft: rgba(47,140,255,0.15);
      --danger: #ff4b4b;
      --danger-soft: rgba(255,75,75,0.15);
      --good: #44d26a;
      --good-soft: rgba(68,210,106,0.12);
      --warning: #ffb84d;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
                   system-ui, sans-serif;
      background: radial-gradient(circle at top, #141424 0, #050509 50%, #000 100%);
      color: var(--text);
    }
    body { padding: 12px 0 32px; }
    .app {
      max-width: 780px;
      margin: 0 auto;
      padding: 0 16px 32px;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0 0 4px;
    }
    .subtitle {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 12px;
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease-out, box-shadow 0.05s ease-out,
                  background 0.1s, color 0.1s;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04),
                  0 8px 18px rgba(0,0,0,0.55),
                  0 0 28px rgba(47,140,255,0.4);
    }
    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(0,0,0,0.6),
                  0 0 18px rgba(47,140,255,0.25);
    }
    .btn-secondary {
      background: #1b1b2a;
      color: var(--text);
      box-shadow: 0 0 0 1px var(--border);
    }
    .btn-secondary:active {
      transform: translateY(1px) scale(0.99);
      background: #181824;
    }
    .btn-danger {
      background: var(--danger);
      color: #fff;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.03),
                  0 8px 18px rgba(0,0,0,0.55),
                  0 0 28px rgba(255,61,61,0.5);
    }
    .btn-danger:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(0,0,0,0.6),
                  0 0 18px rgba(255,61,61,0.3);
    }
    .btn-icon {
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-icon span.icon {
      font-size: 1rem;
    }

    .settings-chip {
      font-size: 0.85rem;
      padding: 3px 9px;
      border-radius: 999px;
      background: #171726;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .panel {
      margin-top: 12px;
    }
    .card {
      background: linear-gradient(135deg, #131321, #0b0b13);
      border-radius: 18px;
      padding: 16px 16px 14px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
      box-shadow: 0 16px 35px rgba(0,0,0,0.55);
    }
    .card-soft {
      background: var(--card-soft);
    }
    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .card-title {
      font-size: 0.9rem;
      font-weight: 650;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .badge {
      font-size: 0.8rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: #151522;
    }
    .badge-good {
      color: var(--good);
      background: var(--good-soft);
      border-color: rgba(68,210,106,0.5);
    }
    .badge-danger {
      color: var(--danger);
      background: var(--danger-soft);
      border-color: rgba(255,75,75,0.7);
    }
    .badge-warn {
      color: var(--warning);
      background: rgba(255,184,77,0.12);
      border-color: rgba(255,184,77,0.6);
    }

    .big-value {
      font-size: 1.8rem;
      font-weight: 800;
      margin: 4px 0 2px;
    }
    .big-sub {
      font-size: 0.95rem;
      color: var(--muted);
    }
    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .pk-chip {
      display:inline-flex;
      align-items:center;
      padding: 2px 9px;
      border-radius:999px;
      background:#191928;
      border:1px solid var(--border);
      font-size:0.8rem;
      color:var(--muted);
      margin-top:4px;
    }

    .row-two {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 640px) {
      .row-two { grid-template-columns: 1fr; }
      .top-bar { flex-direction: column; align-items: flex-start; }
    }

    .field {
      margin-top: 8px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .field label {
      font-size: 0.85rem;
      color: var(--muted);
    }
    input, select, textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 11px;
      border: 1px solid #303047;
      background: #090910;
      color: var(--text);
      font-size: 0.95rem;
      outline: none;
    }
    input::placeholder {
      color: #55556d;
    }
    select {
      appearance:none;
    }
    .hint {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .hint-strong {
      color: #d0d0ff;
    }

    ul.access-list {
      list-style:none;
      padding:0;
      margin: 6px 0 0;
      font-size:0.9rem;
    }
    ul.access-list li + li {
      margin-top:6px;
      padding-top:6px;
      border-top:1px dashed #303048;
    }
    .access-name {
      font-weight:600;
    }
    .access-meta {
      font-size:0.82rem;
      color:var(--muted);
    }

    .footer {
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .hidden { display:none; }
  </style>
</head>
<body>
<div class="app">
  <div class="top-bar">
    <div>
      <h1>PK RER A ‚Äì St-Germain ‚Üî Paris ‚Üî Chessy</h1>
      <div class="subtitle">
        Estimation du PK en temps r√©el √† partir de la g√©olocalisation.
      </div>
    </div>
    <button id="btnToggleSettings" class="btn btn-secondary btn-icon" type="button">
      <span class="icon">‚öôÔ∏è</span>
      <span>Param√®tres</span>
    </button>
  </div>

  <!-- PANEL PRINCIPAL -->
  <div id="panel-main" class="panel">
    <!-- G√©oloc -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">G√©olocalisation</div>
        <div id="gpsStatusBadge" class="badge badge-danger">GPS inactif</div>
      </div>
      <div id="gpsStatusText" class="muted">En attente du GPS‚Ä¶</div>
      <div id="gpsCoords" class="hint"></div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnStartStopGps" class="btn btn-primary btn-icon" type="button">
          <span class="icon">üìç</span><span>D√©marrer la g√©oloc</span>
        </button>
      </div>
    </div>

    <!-- Gare la plus proche -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Gare la plus proche (en PK)</div>
        <div id="nearestStationDeltaBadge" class="badge">‚Äì</div>
      </div>
      <div id="nearestStationName" class="big-value">Aucune</div>
      <div id="nearestStationDetails" class="big-sub">En attente de position‚Ä¶</div>
    </div>

    <!-- Ligne sens / prochaine gare -->
    <div class="row-two">
      <!-- Sens -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Sens / Mouvement</div>
          <div id="movementBadge" class="badge">‚Äì</div>
        </div>
        <div id="movementLabel" class="big-value">En attente‚Ä¶</div>
        <div id="movementDetails" class="big-sub">Bouge quelques m√®tres pour que l‚Äôapp d√©tecte le sens.</div>
      </div>
      <!-- Prochaine gare -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Prochaine gare (en PK)</div>
          <div id="nextStationBadge" class="badge">‚Äì</div>
        </div>
        <div id="nextStationName" class="big-value">‚Äì</div>
        <div id="nextStationDetails" class="big-sub">En attente de mouvement‚Ä¶</div>
      </div>
    </div>

    <!-- PK cible -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">PK cible</div>
        <div id="targetPkBadge" class="badge">Aucun</div>
      </div>
      <div id="targetPkInfo" class="big-sub" style="margin-bottom:8px;">
        Saisis un PK puis clique sur ¬´ D√©finir ce PK comme cible ¬ª.
      </div>
      <div class="field">
        <label for="targetPkInput">
          PK en m√®tres ou au format 32+400
        </label>
        <input id="targetPkInput" type="text" inputmode="numeric"
               placeholder="ex : 32400 ou 32+400" />
      </div>
      <div style="margin-top:10px;">
        <button id="btnSetTargetPk" class="btn btn-primary" type="button">
          D√©finir ce PK comme cible
        </button>
      </div>
    </div>

    <!-- Acc√®s les plus proches -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Acc√®s les plus proches (en PK)</div>
      </div>
      <div id="accessInfoHint" class="big-sub">
        En attente de position‚Ä¶
      </div>
      <ul id="accessList" class="access-list"></ul>
    </div>

    <!-- Urgence / SMS -->
    <div class="card card-soft">
      <div class="card-header">
        <div class="card-title">Urgence / Partage position</div>
        <div class="badge badge-warn">Prototype</div>
      </div>
      <div id="smsPreview" class="muted" style="margin-bottom:10px;">
        Le SMS contiendra la position (PK, gare la plus proche, coordonn√©es GPS).
      </div>
      <button id="btnSms" class="btn btn-danger btn-icon" type="button">
        <span class="icon">‚úâÔ∏è</span><span>SMS d‚Äôurgence</span>
      </button>
      <div class="hint" style="margin-top:10px;">
        <span class="hint-strong">Attention :</span> le SMS part via ton application
        Messages, l‚Äôapp ne l‚Äôenvoie pas automatiquement.
      </div>
    </div>

    <div class="footer">
      Prototype perso ‚Äì pr√©cision typique ¬±100‚Äì200 m selon le GPS.
      Utilise le recalage PK quand tu passes devant une borne pour affiner.
    </div>
  </div>

  <!-- PANEL PARAM√àTRES -->
  <div id="panel-settings" class="panel hidden">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Param√®tres</div>
        <div class="settings-chip">Local au t√©l√©phone</div>
      </div>
      <div class="muted">
        Ces r√©glages sont stock√©s dans ton navigateur (localStorage) uniquement.
        Ils restent apr√®s un rechargement de la page ou une mise √† jour de l‚Äôapp.
      </div>

      <!-- Num√©ro SOS -->
      <div class="field" style="margin-top:10px;">
        <label for="sosNumber">
          Num√©ro SOS pour le bouton ¬´ SMS d‚Äôurgence  ¬ª
        </label>
        <input id="sosNumber" type="tel"
               placeholder="ex : 0612345678 ou +33612345678" />
        <div class="hint">
          Ce num√©ro sera utilis√© lorsque tu appuies sur <b>SMS d‚Äôurgence</b>.
        </div>
      </div>

      <!-- Sensibilit√© mouvement -->
      <div class="field">
        <label for="movementSensitivity">Sensibilit√© au mouvement</label>
        <select id="movementSensitivity">
          <option value="normal">Normal</option>
          <option value="slow">Marche lente</option>
        </select>
        <div class="hint">
          ¬´ Marche lente ¬ª d√©tecte plus facilement un d√©placement √† pied,
          mais peut bouger un peu plus quand tu es immobile.
        </div>
      </div>

      <!-- Recalage PK -->
      <div class="field">
        <label>Recalage PK</label>
        <div id="pkOffsetInfo" class="hint">
          Offset actuel : ¬±0 m appliqu√©s √† tous les PK.
        </div>
      </div>

      <div class="field">
        <label>Position PK estim√©e (lecture seule)</label>
        <div id="settingsPkEstimated" class="big-sub">
          En attente de position‚Ä¶
        </div>
      </div>

      <div class="field">
        <label for="recalPkInput">
          PK exact ici (pour recaler l‚Äôappli)
        </label>
        <input id="recalPkInput" type="text" inputmode="numeric"
               placeholder="ex : 52700 ou 52+700" />
        <div class="hint">
          Utilise une borne PK officielle pour recaler l‚Äôappli
          quand tu passes devant.
        </div>
      </div>

      <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
        <button id="btnApplyRecal" class="btn btn-primary" type="button">
          Recaler l‚Äôappli sur ce PK
        </button>
        <button id="btnResetRecal" class="btn btn-secondary" type="button">
          R√©initialiser le recalage PK
        </button>
      </div>

      <div style="margin-top:14px;">
        <button id="btnSaveSettings" class="btn btn-primary btn-icon" type="button">
          <span class="icon">üíæ</span><span>Enregistrer les param√®tres</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // ========================
  //  DONN√âES DE LA LIGNE
  // ========================

  // Stations principales St-Germain ‚Üí Paris ‚Üí Chessy
  const stations = [
    { name: "St-Germain-en-Laye",         lat: 48.89847456774899, lon: 2.0946251969575758 },
    { name: "Le V√©sinet ‚Äì Le Pecq",       lat: 48.898453045773756, lon: 2.1222846834668463 },
    { name: "Le V√©sinet ‚Äì Centre",        lat: 48.89015551102287, lon: 2.1347027834663734 },
    { name: "Chatou ‚Äì Croissy",           lat: 48.885463830476226, lon: 2.1564040969568476 },
    { name: "Rueil-Malmaison",            lat: 48.8877403422539, lon: 2.172546893247054 },
    { name: "Nanterre-Ville",             lat: 48.895208635538054, lon: 2.1957210472104185 },
    { name: "Nanterre-Universit√©",        lat: 48.90095412304061, lon: 2.212868371163578 },
    { name: "Nanterre-Pr√©fecture",        lat: 48.89584493515037, lon: 2.223070230599684 },
    { name: "La D√©fense ‚Äì Grande Arche",  lat: 48.89190450584105, lon: 2.238561625793641 },
    { name: "Charles-de-Gaulle ‚Äì √âtoile", lat: 48.87429000590014, lon: 2.2948848392833265 },
    { name: "Auber",                      lat: 48.87253584968609, lon: 2.3298119681196616 },
    { name: "Ch√¢telet ‚Äì Les Halles",      lat: 48.861975252750504, lon: 2.3469363527734237 },
    { name: "Gare de Lyon",               lat: 48.84448734989796, lon: 2.3743558392817015 },
    { name: "Nation",                     lat: 48.84882180258805, lon: 2.3970239229241757 },
    { name: "Vincennes",                  lat: 48.84754190270547, lon: 2.4332766908509558 },
    { name: "Fontenay-sous-Bois",         lat: 48.845783471591815, lon: 2.4641534957610167 },
    { name: "Val de Fontenay",            lat: 48.854418359362505, lon: 2.4890884590969433 },
    { name: "Neuilly-Plaisance",          lat: 48.8534646980684, lon: 2.513839877899415 },
    { name: "Bry-sur-Marne",              lat: 48.844265746484844, lon: 2.526192452772413 },
    { name: "Noisy-le-Grand ‚Äì Mont d‚ÄôEst",lat: 48.841013514905114, lon: 2.5527359297146157 },
    { name: "Noisy ‚Äì Champs",             lat: 48.84295024164959, lon: 2.5788366796099105 },
    { name: "Noisiel",                    lat: 48.84376504256413, lon: 2.6160790153456777 },
    { name: "Lognes",                     lat: 48.83936112712248, lon: 2.6335250334635436 },
    { name: "Torcy",                      lat: 48.839027600948114, lon: 2.655058429753598 },
    { name: "Bussy-Saint-Georges",        lat: 48.83718263876794, lon: 2.712538601000879 },
    { name: "Val d‚ÄôEurope",               lat: 48.856168414902776, lon: 2.773827467210709 },
    { name: "Marne-la-Vall√©e ‚Äì Chessy",   lat: 48.870723714970545, lon: 2.7826307506659154 }
  ];

  // Pour l‚Äôapproximation initiale, on suppose Chessy ‚âà PK 59+000.
  const PK_CHESSY_APPROX = 59000;

  // Quelques acc√®s en PK "th√©oriques" (affich√©s dans Top 3)
  const accesses = [
    { pkOffsetFromLine: 0,  ref: "Noisy ‚Äì Champs",             approxPk: 42000 },
    { pkOffsetFromLine: 0,  ref: "Noisy-le-Grand ‚Äì Mont d‚ÄôEst",approxPk: 40000 },
    { pkOffsetFromLine: 0,  ref: "Noisiel",                    approxPk: 44000 }
  ];

  // ========================
  //  OUTILS G√âO
  // ========================

  const R = 6371000;
  const lat0 = stations[0].lat * Math.PI / 180;
  const lon0 = stations[0].lon * Math.PI / 180;

  function toXY(lat, lon) {
    const la = lat * Math.PI / 180;
    const lo = lon * Math.PI / 180;
    const x = (lo - lon0) * Math.cos(lat0) * R;
    const y = (la - lat0) * R;
    return { x, y };
  }

  // Pr√©-calcul de la polyline de la ligne
  const linePts = stations.map(s => {
    const p = toXY(s.lat, s.lon);
    return { x: p.x, y: p.y };
  });

  const segLens = [];
  const cumLens = [0];
  for (let i = 0; i < linePts.length - 1; i++) {
    const dx = linePts[i+1].x - linePts[i].x;
    const dy = linePts[i+1].y - linePts[i].y;
    const d = Math.hypot(dx, dy);
    segLens.push(d);
    cumLens.push(cumLens[i] + d);
  }
  const totalLineLen = cumLens[cumLens.length - 1];

  function projectOnLine(lat, lon) {
    const p = toXY(lat, lon);
    let best = { s: 0, dist: Infinity, lat: stations[0].lat, lon: stations[0].lon };

    for (let i = 0; i < linePts.length - 1; i++) {
      const a = linePts[i];
      const b = linePts[i+1];
      const abx = b.x - a.x;
      const aby = b.y - a.y;
      const apx = p.x - a.x;
      const apy = p.y - a.y;
      const ab2 = abx*abx + aby*aby;
      let t = ab2 === 0 ? 0 : (apx*abx + apy*aby) / ab2;
      if (t < 0) t = 0;
      else if (t > 1) t = 1;
      const projx = a.x + t * abx;
      const projy = a.y + t * aby;
      const dist = Math.hypot(p.x - projx, p.y - projy);
      const segLen = segLens[i];
      const s = cumLens[i] + t * segLen;

      if (dist < best.dist) {
        // conversion inverse approx lat/lon
        const la = (projy / R) + lat0;
        const lo = (projx / (R * Math.cos(lat0))) + lon0;
        best = {
          s,
          dist,
          lat: la * 180 / Math.PI,
          lon: lo * 180 / Math.PI
        };
      }
    }
    return best;
  }

  // sStation (abscisse) pour chaque gare
  stations.forEach(s => {
    const proj = projectOnLine(s.lat, s.lon);
    s.s = proj.s;
  });

  // offset PK initial pour que Chessy ‚âà 59 000
  const sChessy = stations[stations.length - 1].s;
  const initialPkOffset = PK_CHESSY_APPROX - sChessy;

  // ========================
  //  √âTAT APPLI
  // ========================

  const state = {
    watchId: null,
    lastProjection: null,   // {s, dist, lat, lon}
    lastPkMeters: null,     // pk "officiel" estim√© (avec offset)
    movementSamples: [],    // {t, s}
    movementMode: "normal", // "normal" | "slow"
    pkOffset: initialPkOffset,
    targetPk: null,         // en m√®tres
    sosNumber: "",
  };

  // ========================
  //  PERSO / LOCALSTORAGE
  // ========================

  const STORAGE_KEY = "rer-a-pk-settings";

  function loadSettings() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (typeof obj.pkOffset === "number") state.pkOffset = obj.pkOffset;
      if (typeof obj.movementMode === "string") state.movementMode = obj.movementMode;
      if (typeof obj.sosNumber === "string") state.sosNumber = obj.sosNumber;
    } catch(e) {}
  }

  function saveSettings() {
    const obj = {
      pkOffset: state.pkOffset,
      movementMode: state.movementMode,
      sosNumber: state.sosNumber
    };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    } catch(e) {}
  }

  // ========================
  //  UTILITAIRES PK
  // ========================

  function formatPk(meters) {
    if (!isFinite(meters)) return "‚Äî";
    const m = Math.round(meters);
    const km = Math.floor(m / 1000);
    const rest = Math.abs(m % 1000);
    return `PK ${km}+${rest.toString().padStart(3,"0")}`;
  }

  function parsePkInput(value) {
    if (!value) return null;
    const s = value.trim().replace(/\s+/g,"");
    const plus = s.indexOf("+");
    if (plus !== -1) {
      const a = parseInt(s.slice(0, plus), 10);
      const b = parseInt(s.slice(plus+1), 10);
      if (Number.isFinite(a) && Number.isFinite(b)) {
        return a * 1000 + b;
      }
      return null;
    }
    const n = parseInt(s, 10);
    if (!Number.isFinite(n)) return null;
    return n;
  }

  function movementThreshold() {
    // vitesse en m/s au-del√† de laquelle on consid√®re qu‚Äôon bouge
    return state.movementMode === "slow" ? 0.15 : 0.35;
  }

  function directionLabel(deltaPk) {
    if (deltaPk > 0) return "vers Chessy";
    if (deltaPk < 0) return "vers St-Germain / Paris";
    return "";
  }

  // ========================
  //  MISE √Ä JOUR UI
  // ========================

  const el = {
    panelMain: document.getElementById("panel-main"),
    panelSettings: document.getElementById("panel-settings"),
    btnToggleSettings: document.getElementById("btnToggleSettings"),

    gpsStatusBadge: document.getElementById("gpsStatusBadge"),
    gpsStatusText: document.getElementById("gpsStatusText"),
    gpsCoords: document.getElementById("gpsCoords"),
    btnStartStopGps: document.getElementById("btnStartStopGps"),

    nearestStationDeltaBadge: document.getElementById("nearestStationDeltaBadge"),
    nearestStationName: document.getElementById("nearestStationName"),
    nearestStationDetails: document.getElementById("nearestStationDetails"),

    movementBadge: document.getElementById("movementBadge"),
    movementLabel: document.getElementById("movementLabel"),
    movementDetails: document.getElementById("movementDetails"),

    nextStationBadge: document.getElementById("nextStationBadge"),
    nextStationName: document.getElementById("nextStationName"),
    nextStationDetails: document.getElementById("nextStationDetails"),

    targetPkBadge: document.getElementById("targetPkBadge"),
    targetPkInfo: document.getElementById("targetPkInfo"),
    targetPkInput: document.getElementById("targetPkInput"),
    btnSetTargetPk: document.getElementById("btnSetTargetPk"),

    accessInfoHint: document.getElementById("accessInfoHint"),
    accessList: document.getElementById("accessList"),

    smsPreview: document.getElementById("smsPreview"),
    btnSms: document.getElementById("btnSms"),

    sosNumber: document.getElementById("sosNumber"),
    movementSensitivity: document.getElementById("movementSensitivity"),
    pkOffsetInfo: document.getElementById("pkOffsetInfo"),
    settingsPkEstimated: document.getElementById("settingsPkEstimated"),
    recalPkInput: document.getElementById("recalPkInput"),
    btnApplyRecal: document.getElementById("btnApplyRecal"),
    btnResetRecal: document.getElementById("btnResetRecal"),
    btnSaveSettings: document.getElementById("btnSaveSettings")
  };

  function setGpsStatus(active, message, error) {
    if (active) {
      el.gpsStatusBadge.textContent = "GPS actif";
      el.gpsStatusBadge.classList.remove("badge-danger");
      el.gpsStatusBadge.classList.add("badge-good");
    } else {
      el.gpsStatusBadge.textContent = error ? "Erreur GPS" : "GPS inactif";
      el.gpsStatusBadge.classList.remove("badge-good");
      el.gpsStatusBadge.classList.add("badge-danger");
    }
    if (message) el.gpsStatusText.textContent = message;
  }

  function updatePkOffsetInfo() {
    const off = Math.round(state.pkOffset);
    const sign = off > 0 ? "+" : off < 0 ? "‚àí" : "¬±";
    const val = Math.abs(off);
    el.pkOffsetInfo.textContent =
      `Offset actuel : ${sign}${val} m appliqu√©s √† tous les PK.`;
  }

  function updateFromProjection() {
    const proj = state.lastProjection;
    if (!proj) return;

    const pkRaw = proj.s;
    const pkOfficial = pkRaw + state.pkOffset;
    state.lastPkMeters = pkOfficial;

    // Coordonn√©es
    el.gpsCoords.textContent =
      `Position re√ßue (lat : ${proj.lat.toFixed(5)}, lon : ${proj.lon.toFixed(5)}), ` +
      `distance √† la voie ~ ${Math.round(proj.dist)} m.`;

    // Nearest station
    let bestStation = null;
    let bestDelta = Infinity;
    for (const st of stations) {
      const d = Math.abs(st.s - proj.s);
      if (d < bestDelta) {
        bestDelta = d;
        bestStation = st;
      }
    }
    if (bestStation) {
      const stPk = bestStation.s + state.pkOffset;
      const delta = stPk - pkOfficial;
      const dir = directionLabel(delta);
      el.nearestStationName.textContent = bestStation.name;
      el.nearestStationDetails.textContent =
        `${formatPk(stPk)} ‚Äì ${Math.round(Math.abs(delta))} m ${dir || "d√©calage"}`;
      el.nearestStationDeltaBadge.textContent =
        `ŒîPK ‚âà ${Math.round(Math.abs(delta))} m`;
    }

    // Settings panel current PK
    const lineDist = Math.round(proj.dist);
    el.settingsPkEstimated.textContent =
      `${formatPk(pkOfficial)}\n~ ${Math.round(pkOfficial)} m depuis l‚Äôorigine de la ligne\n` +
      `~ ${lineDist} m de la voie (projection perpendiculaire).`;

    // Mouvement
    updateMovement(proj);

    // Prochaine gare
    updateNextStation(proj, pkOfficial);

    // PK cible
    updateTargetPkInfo();

    // Acc√®s
    updateAccesses(pkOfficial);

    // SMS preview
    updateSmsPreview();
  }

  function updateMovement(proj) {
    const now = Date.now();
    state.movementSamples.push({ t: now, s: proj.s });

    // garder les 7 derni√®res secondes
    const horizon = 7000;
    state.movementSamples = state.movementSamples.filter(
      p => now - p.t <= horizon
    );

    if (state.movementSamples.length < 2) {
      el.movementBadge.textContent = "En attente";
      el.movementLabel.textContent = "En attente d‚Äôun deuxi√®me point‚Ä¶";
      el.movementDetails.textContent = "Bouge un peu pour d√©tecter le sens.";
      return;
    }

    const first = state.movementSamples[0];
    const last = state.movementSamples[state.movementSamples.length - 1];
    const dt = (last.t - first.t) / 1000;
    if (dt <= 0) return;
    const ds = last.s - first.s;
    const speed = Math.abs(ds) / dt; // m/s

    const thr = movementThreshold();
    if (speed < thr) {
      el.movementBadge.textContent = "Immobile";
      el.movementLabel.textContent = "Quasi immobile";
      el.movementDetails.textContent =
        `ŒîPK ‚âà ${Math.round(Math.abs(ds))} m sur ~${dt.toFixed(1)} s.`;
    } else {
      const dirLabel = directionLabel(ds);
      el.movementBadge.textContent =
        ds > 0 ? "‚Üí vers Chessy" : "‚Üê vers St-Germain / Paris";
      el.movementLabel.textContent =
        ds > 0 ? "Tu te d√©places vers Chessy" : "Tu te d√©places vers St-Germain / Paris";
      el.movementDetails.textContent =
        `ŒîPK ‚âà ${Math.round(Math.abs(ds))} m sur ~${dt.toFixed(1)} s.`;
    }
  }

  function updateNextStation(proj, pkOfficial) {
    // sens : bas√© sur les derniers √©chantillons
    let dir = 0;
    if (state.movementSamples.length >= 2) {
      const first = state.movementSamples[0];
      const last = state.movementSamples[state.movementSamples.length - 1];
      const ds = last.s - first.s;
      if (Math.abs(ds) > 1) dir = ds > 0 ? 1 : -1;
    }

    let candidate = null;
    if (dir >= 0) {
      // vers Chessy (sens "positif")
      let best = Infinity;
      for (const st of stations) {
        if (st.s >= proj.s) {
          const d = st.s - proj.s;
          if (d < best) {
            best = d;
            candidate = st;
          }
        }
      }
    } else {
      // vers St-Germain
      let best = Infinity;
      for (const st of stations) {
        if (st.s <= proj.s) {
          const d = proj.s - st.s;
          if (d < best) {
            best = d;
            candidate = st;
          }
        }
      }
    }

    if (!candidate) {
      el.nextStationName.textContent = "‚Äî";
      el.nextStationDetails.textContent = "En attente de mouvement‚Ä¶";
      el.nextStationBadge.textContent = "‚Äî";
      return;
    }

    const stPk = candidate.s + state.pkOffset;
    const delta = stPk - pkOfficial;
    const dirLabel = directionLabel(delta);

    el.nextStationName.textContent = candidate.name;
    el.nextStationDetails.textContent =
      `${formatPk(stPk)} ‚Äì ‚âà ${Math.round(Math.abs(delta))} m ${dirLabel}`;
    el.nextStationBadge.textContent =
      `${Math.round(Math.abs(delta))} m`;
  }

  function updateTargetPkInfo() {
    const pk = state.targetPk;
    if (!state.lastPkMeters || !pk) {
      el.targetPkBadge.textContent = pk ? formatPk(pk) : "Aucun";
      el.targetPkInfo.textContent =
        pk ? "En attente de la g√©oloc pour calculer la distance." :
             "Aucun PK cible pour l‚Äôinstant.";
      return;
    }

    const delta = pk - state.lastPkMeters;
    const dirLabel = directionLabel(delta);
    el.targetPkBadge.textContent = formatPk(pk);
    if (Math.abs(delta) < 1) {
      el.targetPkInfo.textContent =
        `${formatPk(pk)} ‚Äì tu es exactement sur le PK cible.`;
    } else {
      el.targetPkInfo.textContent =
        `${formatPk(pk)} ‚Äì ‚âà ${Math.round(Math.abs(delta))} m ${dirLabel}.`;
    }
  }

  function updateAccesses(pkOfficial) {
    if (!pkOfficial) {
      el.accessInfoHint.textContent = "En attente de position‚Ä¶";
      el.accessList.innerHTML = "";
      return;
    }

    const items = accesses.map(acc => {
      // on convertit l‚ÄôapproxPk dans le rep√®re actuel
      // en l‚Äôajustant avec l‚Äôoffset r√©el
      const pkAcc = acc.approxPk + (state.pkOffset - initialPkOffset);
      const delta = pkAcc - pkOfficial;
      return {
        ref: acc.ref,
        pk: pkAcc,
        delta,
        dir: directionLabel(delta)
      };
    });

    items.sort((a,b) => Math.abs(a.delta) - Math.abs(b.delta));
    const top = items.slice(0,3);

    el.accessList.innerHTML = "";
    if (!top.length) {
      el.accessInfoHint.textContent = "Aucun acc√®s configur√©.";
      return;
    }

    el.accessInfoHint.textContent = "Top 3 en PK :";
    for (const it of top) {
      const li = document.createElement("li");
      li.innerHTML =
        `<div class="access-name">${formatPk(it.pk)} ‚Äì Gare ${it.ref}</div>` +
        `<div class="access-meta">ŒîPK ‚âà ${Math.round(Math.abs(it.delta))} m ${it.dir}</div>`;
      el.accessList.appendChild(li);
    }
  }

  function updateSmsPreview() {
    const pk = state.lastPkMeters;
    const st = (() => {
      if (!state.lastProjection) return null;
      let best = null, bestDelta = Infinity;
      for (const s of stations) {
        const d = Math.abs(s.s - state.lastProjection.s);
        if (d < bestDelta) { bestDelta = d; best = s; }
      }
      return best;
    })();

    const num = state.sosNumber || "aucun (√† d√©finir dans Param√®tres)";
    if (!pk || !st || !state.lastProjection) {
      el.smsPreview.textContent =
        `Le SMS contiendra : PK estim√©, gare la plus proche et tes coordonn√©es GPS.\n` +
        `Num√©ro utilis√© : ${num}.`;
      return;
    }

    const txt =
      `${formatPk(pk)}, gare la plus proche : ${st.name}, ` +
      `lat ${state.lastProjection.lat.toFixed(5)}, lon ${state.lastProjection.lon.toFixed(5)}. ` +
      `Num√©ro utilis√© : ${num}.`;
    el.smsPreview.textContent = txt;
  }

  // ========================
  //  GPS
  // ========================

  function startGps() {
    if (!navigator.geolocation) {
      setGpsStatus(false, "La g√©olocalisation n‚Äôest pas support√©e sur ce navigateur.", true);
      return;
    }
    if (state.watchId != null) return;
    try {
      state.watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude, accuracy } = pos.coords;
          setGpsStatus(true, "Position re√ßue.", false);
          const proj = projectOnLine(latitude, longitude);
          state.lastProjection = proj;
          updateFromProjection();
        },
        err => {
          console.error("GPS error", err);
          setGpsStatus(false, `Impossible d‚Äôobtenir la position (${err.message}).`, true);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 15000
        }
      );
      setGpsStatus(true, "Demande de position en cours‚Ä¶", false);
    } catch(e) {
      setGpsStatus(false, "Erreur lors de l‚Äôacc√®s √† la g√©olocalisation.", true);
    }
  }

  function stopGps() {
    if (state.watchId != null && navigator.geolocation) {
      navigator.geolocation.clearWatch(state.watchId);
    }
    state.watchId = null;
    setGpsStatus(false, "La g√©olocalisation est arr√™t√©e.", false);
  }

  // ========================
  //  SMS URGENCE
  // ========================

  function sendSms() {
    if (!state.sosNumber) {
      alert("D√©finis d‚Äôabord un num√©ro SOS dans Param√®tres.");
      return;
    }
    const pkStr = formatPk(state.lastPkMeters || 0);
    const st = (() => {
      if (!state.lastProjection) return null;
      let best = null, bestDelta = Infinity;
      for (const s of stations) {
        const d = Math.abs(s.s - state.lastProjection.s);
        if (d < bestDelta) { bestDelta = d; best = s; }
      }
      return best;
    })();
    const stName = st ? st.name : "inconnue";
    const lat = state.lastProjection ? state.lastProjection.lat.toFixed(5) : "?";
    const lon = state.lastProjection ? state.lastProjection.lon.toFixed(5) : "?";

    const body =
      `[PK RER A] ${pkStr}, gare la plus proche : ${stName}, ` +
      `lat ${lat}, lon ${lon}.`;
    const encodedBody = encodeURIComponent(body);
    const num = encodeURIComponent(state.sosNumber);
    // iOS & Android acceptent g√©n√©ralement ce format
    const url = `sms:${num}?&body=${encodedBody}`;
    window.location.href = url;
  }

  // ========================
  //  REGLAGES / PARAM√àTRES
  // ========================

  function applyUiSettings() {
    el.sosNumber.value = state.sosNumber || "";
    el.movementSensitivity.value = state.movementMode;
    updatePkOffsetInfo();
    updateSmsPreview();
  }

  // ========================
  //  LISTENERS
  // ========================

  el.btnStartStopGps.addEventListener("click", () => {
    if (state.watchId == null) {
      startGps();
      el.btnStartStopGps.textContent = "Arr√™ter la g√©oloc";
    } else {
      stopGps();
      el.btnStartStopGps.textContent = "D√©marrer la g√©oloc";
    }
  });

  el.btnToggleSettings.addEventListener("click", () => {
    const showSettings = el.panelSettings.classList.contains("hidden");
    if (showSettings) {
      el.panelSettings.classList.remove("hidden");
      el.panelMain.classList.add("hidden");
      el.btnToggleSettings.innerHTML = '<span class="icon">‚¨ÖÔ∏è</span><span>Retour</span>';
    } else {
      el.panelSettings.classList.add("hidden");
      el.panelMain.classList.remove("hidden");
      el.btnToggleSettings.innerHTML = '<span class="icon">‚öôÔ∏è</span><span>Param√®tres</span>';
    }
  });

  el.btnSetTargetPk.addEventListener("click", () => {
    const value = el.targetPkInput.value;
    const pk = parsePkInput(value);
    if (!pk || pk <= 0) {
      alert("PK invalide. Utilise par ex. 32400 ou 32+400.");
      return;
    }
    state.targetPk = pk;
    updateTargetPkInfo();
  });

  el.btnSms.addEventListener("click", sendSms);

  el.movementSensitivity.addEventListener("change", () => {
    state.movementMode = el.movementSensitivity.value;
    saveSettings();
  });

  el.btnApplyRecal.addEventListener("click", () => {
    if (!state.lastProjection) {
      alert("Pas de position GPS pour le moment. Lance la g√©oloc et attends quelques secondes.");
      return;
    }
    const value = el.recalPkInput.value;
    const pk = parsePkInput(value);
    if (!pk || pk <= 0) {
      alert("PK invalide. Utilise par ex. 52700 ou 52+700.");
      return;
    }
    const rawPk = state.lastProjection.s;
    state.pkOffset = pk - rawPk;
    saveSettings();
    updatePkOffsetInfo();
    updateFromProjection();
    alert(`Recalage appliqu√© : l‚Äôappli consid√®re maintenant que tu es √† ${formatPk(pk)}.`);
  });

  el.btnResetRecal.addEventListener("click", () => {
    state.pkOffset = initialPkOffset;
    saveSettings();
    updatePkOffsetInfo();
    updateFromProjection();
  });

  el.btnSaveSettings.addEventListener("click", () => {
    state.sosNumber = el.sosNumber.value.trim();
    state.movementMode = el.movementSensitivity.value;
    saveSettings();
    updateSmsPreview();
    alert("Param√®tres enregistr√©s.");
  });

  // ========================
  //  INIT
  // ========================

  loadSettings();
  applyUiSettings();
  setGpsStatus(false, "En attente du GPS‚Ä¶", false);
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>PK Assistant ‚Äì RER A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Emp√™che la 404 sur /favicon.ico -->
  <link rel="icon" href="data:,">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
 
  :root {
    color-scheme: dark;
    --bg: #050510;
    --bg-gradient: radial-gradient(circle at top, #251c4a 0%, #050510 60%, #010106 100%);
    --card: #121522;
    --card-soft: #16182a;
    --border: #262a3a;
    --text: #f0f2ff;
    --muted: #a8abcc;
    --accent: #3d7bff;
    --accent-hover: #5a8fff;
    --accent-active: #2d6bff;
    --danger: #ff4b6b;
    --danger-hover: #ff6b85;
    --danger-active: #ff2b4b;
    --danger-soft: rgba(255, 75, 107, 0.18);
    --good: #4bd67a;
    --good-soft: rgba(73, 171, 105, 0.12);
    --warning: #ffc75e;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 8px 25px rgba(0, 0, 0, 0.45);
    --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.5);
    --transition-fast: 0.15s ease;
    --transition-normal: 0.25s ease;
    --transition-slow: 0.4s ease;
  }

  * { box-sizing: border-box; }

  html, body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    -webkit-font-smoothing: antialiased;
  }

  body {
    position: relative;
    padding: 16px 0 40px;
    background: var(--bg-gradient);
    color: var(--text);
    overflow-x: hidden;
  }

  body::before {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: -1;
    background-image:
      radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,0.16), transparent 60%),
      radial-gradient(2px 2px at 80% 30%, rgba(255,255,255,0.10), transparent 60%),
      radial-gradient(1.5px 1.5px at 20% 80%, rgba(255,255,255,0.12), transparent 60%),
      radial-gradient(1.5px 1.5px at 70% 70%, rgba(255,255,255,0.08), transparent 60%);
    opacity: 0.35;
  }

  /* Arri√®re-plan √©toil√© avec motif r√©p√©t√© et anim√© - √©toiles lumineuses */
  body::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: -1;
    background-image:
      /* √âtoiles moyennes lumineuses */
      radial-gradient(3px 3px at 10% 15%, rgba(255,255,255,1), transparent 70%),
      radial-gradient(3px 3px at 30% 25%, rgba(255,255,255,0.9), transparent 70%),
      radial-gradient(3px 3px at 50% 35%, rgba(255,255,255,1), transparent 70%),
      radial-gradient(3px 3px at 70% 45%, rgba(255,255,255,0.95), transparent 70%),
      radial-gradient(3px 3px at 90% 55%, rgba(255,255,255,0.9), transparent 70%),
      radial-gradient(3px 3px at 20% 65%, rgba(255,255,255,1), transparent 70%),
      radial-gradient(3px 3px at 40% 75%, rgba(255,255,255,0.95), transparent 70%),
      radial-gradient(3px 3px at 60% 85%, rgba(255,255,255,0.9), transparent 70%),
      radial-gradient(3px 3px at 80% 95%, rgba(255,255,255,1), transparent 70%),
      radial-gradient(3px 3px at 15% 5%, rgba(255,255,255,0.95), transparent 70%),
      radial-gradient(3px 3px at 35% 15%, rgba(255,255,255,0.9), transparent 70%),
      radial-gradient(3px 3px at 55% 25%, rgba(255,255,255,1), transparent 70%),
      radial-gradient(3px 3px at 75% 35%, rgba(255,255,255,0.95), transparent 70%),
      radial-gradient(3px 3px at 95% 45%, rgba(255,255,255,0.9), transparent 70%),
      radial-gradient(3px 3px at 25% 55%, rgba(255,255,255,1), transparent 70%),
      radial-gradient(3px 3px at 45% 65%, rgba(255,255,255,0.95), transparent 70%),
      radial-gradient(3px 3px at 65% 75%, rgba(255,255,255,0.9), transparent 70%),
      radial-gradient(3px 3px at 85% 85%, rgba(255,255,255,1), transparent 70%),
      /* √âtoiles grandes brillantes */
      radial-gradient(4px 4px at 5% 10%, rgba(255,255,255,0.8), transparent 60%),
      radial-gradient(4px 4px at 25% 20%, rgba(255,255,255,0.85), transparent 60%),
      radial-gradient(4px 4px at 45% 30%, rgba(255,255,255,0.8), transparent 60%),
      radial-gradient(4px 4px at 65% 40%, rgba(255,255,255,0.85), transparent 60%),
      radial-gradient(4px 4px at 85% 50%, rgba(255,255,255,0.8), transparent 60%),
      radial-gradient(4px 4px at 15% 60%, rgba(255,255,255,0.85), transparent 60%),
      radial-gradient(4px 4px at 35% 70%, rgba(255,255,255,0.8), transparent 60%),
      radial-gradient(4px 4px at 55% 80%, rgba(255,255,255,0.85), transparent 60%),
      radial-gradient(4px 4px at 75% 90%, rgba(255,255,255,0.8), transparent 60%),
      radial-gradient(4px 4px at 95% 100%, rgba(255,255,255,0.85), transparent 60%),
      /* √âtoiles tr√®s brillantes (points focaux) */
      radial-gradient(5px 5px at 20% 30%, rgba(255,255,255,0.7), transparent 50%),
      radial-gradient(5px 5px at 60% 50%, rgba(255,255,255,0.75), transparent 50%),
      radial-gradient(5px 5px at 80% 70%, rgba(255,255,255,0.7), transparent 50%),
      radial-gradient(5px 5px at 40% 80%, rgba(255,255,255,0.75), transparent 50%);
    background-size: 300px 300px;
    background-repeat: repeat;
    opacity: 1;
    animation: starsAnimated 15s linear infinite;
    /* Optimisation batterie : pause les animations quand la page n'est pas visible */
    animation-play-state: running;
  }

  /* Pause les animations quand la page n'est pas visible (√©conomie batterie) */
  body[data-page-hidden="true"]::after {
    animation-play-state: paused;
  }

  @keyframes starsAnimated {
    0% {
      background-position: 0% 0%;
      opacity: 0.9;
    }
    25% {
      opacity: 1;
    }
    50% {
      background-position: 100% 100%;
      opacity: 0.95;
    }
    75% {
      opacity: 1;
    }
    100% {
      background-position: 0% 0%;
      opacity: 0.9;
    }
  }

  .app {
    max-width: 740px;
    margin: 0 auto;
    padding: 0 16px 32px;
  }

  .header {
    margin-bottom: 14px;
    text-align: center;
  }

  .title-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin: 0 auto;
    width: fit-content;
  }

  .gyrophare-gif {
    width: 40px;
    height: 40px;
    object-fit: contain;
    flex-shrink: 0;
  }

  .title-pill {
    display: inline-block;
    padding: 12px 22px;
    border-radius: 999px;
    background: radial-gradient(circle at 0% 0%, #ff9f7b 0%, #ff4b6b 24%, #3d7bff 70%, #1a1b3a 100%);
    box-shadow: 0 10px 30px rgba(0,0,0,0.6), 0 0 40px rgba(61, 123, 255, 0.2);
    border: 1px solid rgba(255,255,255,0.2);
    margin: 0;
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
  }

  .title-pill::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: shimmer 3s ease-in-out infinite;
  }

  @keyframes shimmer {
    0%, 100% { transform: translate(-50%, -50%) rotate(0deg); opacity: 0; }
    50% { transform: translate(-50%, -50%) rotate(180deg); opacity: 1; }
  }

  .title-main {
    font-size: 1.3rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: #fff;
    text-align: center;
  }

  .title-sub {
    font-size: 1.05rem; /* RER A un peu plus gros */
    font-weight: 600;
    margin-top: 2px;
    color: #f3f2ff;
    text-align: center;
  }

  .subtitle {
    color: var(--muted);
    font-size: 0.9rem;
    margin: 8px 0 4px;
    line-height: 1.5;
    font-weight: 500;
  }

  .note {
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.4;
    margin-top: 6px;
    opacity: 0.85;
  }

  .card {
    background: linear-gradient(145deg, #121522, #0d0f18);
    border-radius: 20px;
    padding: 20px 20px 16px;
    border: 1px solid rgba(255,255,255,0.08);
    margin-bottom: 16px;
    box-shadow: var(--shadow-md);
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(61, 123, 255, 0.3), transparent);
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .card:hover::before {
    opacity: 1;
  }

  .card:hover {
    border-color: rgba(255,255,255,0.12);
    box-shadow: var(--shadow-lg);
    transform: translateY(-1px);
  }

  .card-soft {
    background: var(--card-soft);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .card-title {
    font-size: 0.9rem;
    font-weight: 650;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
    transition: color var(--transition-fast);
  }

  .card:hover .card-title {
    color: rgba(255, 255, 255, 0.7);
  }

  .big-value {
    font-size: 1.7rem;
    font-weight: 700;
    margin: 6px 0 4px;
    color: #fff;
    line-height: 1.2;
    letter-spacing: -0.02em;
    transition: color var(--transition-normal);
  }

  .big-sub {
    font-size: 0.95rem;
    color: var(--muted);
  }

  .muted {
    color: var(--muted);
    font-size: 0.9rem;
  }

  .badge {
    font-size: 0.8rem;
    padding: 5px 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
    color: var(--muted);
    background: #181b2a;
    font-weight: 600;
    letter-spacing: 0.03em;
    transition: all var(--transition-fast);
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .badge::before {
    content: "";
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
    opacity: 0.6;
    display: inline-block;
  }

  .badge-good {
    color: var(--good);
    background: var(--good-soft);
  }

  .badge-danger {
    color: var(--danger);
    background: var(--danger-soft);
  }

  .badge-warn {
    color: var(--warning);
    background: rgba(255,184,77,0.12);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 13px 20px;
    border-radius: 16px;
    border: none;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: center;
    position: relative;
    overflow: hidden;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  .btn::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.4s, height 0.4s;
  }

  .btn:active::before {
    width: 300px;
    height: 300px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #6fa3ff);
    color: white;
    box-shadow: 0 4px 12px rgba(61, 123, 255, 0.3);
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, var(--accent-hover), #7fb3ff);
    box-shadow: 0 6px 16px rgba(61, 123, 255, 0.4);
    transform: translateY(-1px);
  }

  .btn-primary:active {
    background: linear-gradient(135deg, var(--accent-active), #5f9fff);
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(61, 123, 255, 0.3);
  }

  .btn-secondary {
    background: #1a1d2b;
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: #222533;
    border-color: rgba(255, 255, 255, 0.15);
    transform: translateY(-1px);
  }

  .btn-secondary:active {
    background: #151824;
    transform: translateY(0);
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--danger), #ff7592);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 75, 107, 0.3);
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, var(--danger-hover), #ff859a);
    box-shadow: 0 6px 16px rgba(255, 75, 107, 0.4);
    transform: translateY(-1px);
  }

  .btn-danger:active {
    background: linear-gradient(135deg, var(--danger-active), #ff6590);
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(255, 75, 107, 0.3);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }

  .btn-icon {
    display:inline-flex;
    align-items:center;
    gap:6px;
  }

  .field {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .field:first-child {
    margin-top: 0;
  }

  .field label {
    font-size: 0.87rem;
    color: var(--muted);
    font-weight: 500;
    line-height: 1.4;
    transition: color var(--transition-fast);
  }

  .field:focus-within label {
    color: rgba(255, 255, 255, 0.8);
  }

  .pk-lookup-section {
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    padding: 16px;
    margin: 12px 0;
    background: rgba(255, 255, 255, 0.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .pk-lookup-section .field label {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
  }

  .pk-calibration-section {
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    padding: 16px;
    margin: 12px 0;
    background: rgba(255, 255, 255, 0.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .pk-calibration-section .field label {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
  }

  .sensitivity-section {
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    padding: 16px;
    margin: 12px 0;
    background: rgba(255, 255, 255, 0.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .sensitivity-section .field label {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
  }

  input, select, textarea {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid #303047;
    background: #0a0c12;
    color: var(--text);
    font-size: 0.95rem;
    outline: none;
    transition: all var(--transition-fast);
  }

  input:hover, select:hover, textarea:hover {
    border-color: rgba(255, 255, 255, 0.2);
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(61, 123, 255, 0.15), 0 0 8px rgba(61, 123, 255, 0.3);
    background: #0d0f15;
  }

  input:invalid, select:invalid, textarea:invalid {
    border-color: var(--danger);
  }

  textarea {
    resize: vertical;
    min-height: 80px;
  }

  .access-item {
    margin-bottom: 6px;
  }

  .bottom-bar {
    margin-top: 10px;
    display:flex;
    justify-content:center;
  }

  .settings-footer {
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--muted);
  }

  /* Signature en bas de page */
  .app-footer {
    text-align: center;
    padding: 20px 0;
    margin-top: 30px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 0.75rem;
    color: var(--muted);
    letter-spacing: 0.2em;
  }

  .divider {
    margin: 10px 0;
    height: 1px;
    background: rgba(255,255,255,0.04);
  }

.signalement-block {
    background: linear-gradient(145deg, #221015, #170b0e);
    border: 1px solid rgba(255, 75, 107, 0.4);
    border-radius: 18px;
    padding: 16px;
    margin: 14px 0 6px;
    box-shadow: 0 0 20px rgba(255, 75, 107, 0.12);
  }

  /* √âtats de chargement */
  .loading {
    position: relative;
    color: transparent !important;
    pointer-events: none;
  }

  .loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 16px;
    height: 16px;
    margin: -8px 0 0 -8px;
    border: 2px solid var(--accent);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Feedback visuel pour les actions r√©ussies */
  .success-feedback {
    animation: successPulse 0.4s ease;
  }

  @keyframes successPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); background-color: var(--good-soft); }
    100% { transform: scale(1); }
  }

  @media (max-width: 640px) {
    .app {
      padding: 0 12px 24px;
    }
    .card {
      padding: 16px 16px 14px;
      border-radius: 18px;
      margin-bottom: 14px;
    }
    .big-value {
      font-size: 1.5rem;
    }
    .btn {
      width: 100%;
      border-radius: 14px;
      padding: 14px 20px;
    }
    .title-pill {
      padding: 10px 18px;
    }
    .card-header {
      margin-bottom: 10px;
      padding-bottom: 6px;
    }
  }
  .orientation-block {
  margin-top: 10px;
  padding-top: 4px;
}

/* Carte interactive Leaflet avec th√®me sombre */
#orientationMap {
  width: 100%;
  height: 400px;
  border-radius: 12px;
  overflow: hidden;
  margin-top: 12px;
  background: #0a0c12;
}

/* Style personnalis√© pour Leaflet avec th√®me sombre */
.leaflet-container {
  background: #0a0c12;
  color: #fff;
}

/* Marqueur PK actuel (point central) */
.leaflet-marker-pk-actuel {
  background: #3d7bff;
  border: 3px solid #fff;
  border-radius: 50%;
  width: 20px !important;
  height: 20px !important;
  box-shadow: 0 0 15px rgba(61, 123, 255, 0.8);
  animation: pkPulse 2s ease-in-out infinite;
  /* Optimisation batterie : pause les animations quand la page n'est pas visible */
  animation-play-state: running;
}

/* Pause les animations quand la page n'est pas visible */
body[data-page-hidden="true"] .leaflet-marker-pk-actuel {
  animation-play-state: paused;
}

@keyframes pkPulse {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 0 15px rgba(61, 123, 255, 0.8);
  }
  50% {
    transform: scale(1.1);
    box-shadow: 0 0 25px rgba(61, 123, 255, 1);
  }
}

/* Ic√¥ne de gare */
.leaflet-marker-gare {
  background: #ff4b6b;
  border: 2px solid #fff;
  border-radius: 50%;
  width: 24px !important;
  height: 24px !important;
  box-shadow: 0 0 10px rgba(255, 75, 107, 0.6);
}

/* Ic√¥ne d'acc√®s (porte) */
.leaflet-marker-acces {
  background: #ff9f7b;
  border: 2px solid #fff;
  border-radius: 4px;
  width: 18px !important;
  height: 18px !important;
  box-shadow: 0 0 8px rgba(255, 159, 123, 0.6);
}

/* Ic√¥ne PK cible (croix rouge) */
.leaflet-marker-pk-target {
  background: transparent;
  width: 30px !important;
  height: 30px !important;
  position: relative;
}

.leaflet-marker-pk-target::before,
.leaflet-marker-pk-target::after {
  content: "";
  position: absolute;
  background: #ff0000;
  box-shadow: 0 0 8px rgba(255, 0, 0, 0.8), 0 0 15px rgba(255, 0, 0, 0.6);
}

.leaflet-marker-pk-target::before {
  width: 3px;
  height: 100%;
  left: 50%;
  top: 0;
  transform: translateX(-50%);
}

.leaflet-marker-pk-target::after {
  width: 100%;
  height: 3px;
  top: 50%;
  left: 0;
  transform: translateY(-50%);
}

/* Ic√¥ne SAM (feu rouge) */
.leaflet-marker-sam {
  background: #ff0000;
  border: 2px solid #fff;
  border-radius: 50%;
  width: 20px !important;
  height: 20px !important;
  box-shadow: 0 0 10px rgba(255, 0, 0, 0.8), 0 0 20px rgba(255, 0, 0, 0.6);
}

/* Ic√¥ne p√©tard (carr√© vert) */
.leaflet-marker-petard {
  background: #00ff00;
  border: 2px solid #fff;
  border-radius: 2px;
  width: 16px !important;
  height: 16px !important;
  box-shadow: 0 0 8px rgba(0, 255, 0, 0.8), 0 0 15px rgba(0, 255, 0, 0.6);
}

/* Fl√®che de direction */
.leaflet-marker-direction {
  background: transparent;
  border: none;
  width: 40px !important;
  height: 40px !important;
}

.direction-arrow {
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-bottom: 25px solid #3d7bff;
  filter: drop-shadow(0 0 8px rgba(61, 123, 255, 0.8));
}

.direction-arrow-moving {
  animation: arrowMoveForward 2s ease-in-out infinite;
  /* Optimisation batterie : pause les animations quand la page n'est pas visible */
  animation-play-state: running;
}

/* Pause les animations quand la page n'est pas visible */
body[data-page-hidden="true"] .direction-arrow-moving {
  animation-play-state: paused;
}

.direction-arrow-indetermine {
  border-bottom-color: #666;
  filter: drop-shadow(0 0 4px rgba(102, 102, 102, 0.4));
  animation: none;
}

/* Animation de la fl√®che qui avance en temps r√©el */
@keyframes arrowMoveForward {
  0% {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  50% {
    transform: translateY(-8px) scale(1.1);
    opacity: 0.9;
  }
  100% {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

/* Panneau d'information sur la carte */
.orientation-info-panel {
  position: relative;
  margin-top: 12px;
  background: rgba(10, 12, 18, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  padding: 12px;
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.orientation-info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 0.85rem;
}

.orientation-info-label {
  color: var(--muted);
  font-weight: 600;
}

.orientation-info-value {
  color: #fff;
  font-weight: 600;
}

</style>

</head>
<body>
  <div id="accessOverlay" style="
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top, #251c4a 0%, #050510 60%, #010106 100%);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
">
  <div class="card" style="max-width:320px;width:90%;text-align:center;">
    <div class="card-title" style="width:100%;text-align:center;">Code d'acc√®s</div>
    <div class="muted" style="margin-top:6px;">
      Application interne ‚Äì acc√®s r√©serv√©.<br>
      Saisis le code d'acc√®s.
    </div>

    <div class="field" style="margin-top:12px;">
      <input id="accessCodeInput"
             type="password"
             inputmode="numeric"
             maxlength="6"
             placeholder="Code"
             style="text-align:center;font-size:1.1rem;letter-spacing:0.2em;">
    </div>

    <div class="field">
      <button id="btnAccessCode" class="btn btn-primary btn-icon" type="button">
        <span>üîì</span><span>D√©verrouiller</span>
      </button>
    </div>

    <div id="accessError" class="muted" style="color:var(--danger);display:none;">
      Code incorrect.
    </div>
  </div>
</div>

  <div class="app">
    <div class="header">
      <div class="title-wrapper">
        <img src="https://www.gifsgratuits.fr/gyrophares/g%20%2831%29.gif" alt="Gyrophare" class="gyrophare-gif" />
        <div class="title-pill">
          <div class="title-main">PK ASSISTANT</div>
          <div class="title-sub">RER A</div>
        </div>
        <img src="https://www.gifsgratuits.fr/gyrophares/g%20%2831%29.gif" alt="Gyrophare" class="gyrophare-gif" />
      </div>
      <div class="subtitle">Estimation du PK en temps r√©el √† partir de la g√©olocalisation.</div>
      <div class="note">
        Toujours v√©rifier une borne quand c‚Äôest critique.
      </div>
    </div>

    <!-- G√âOLOCALISATION -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">G√©olocalisation</div>
        <span id="gpsStatusBadge" class="badge badge-danger">GPS inactif</span>
      </div>
      <div id="geolocText" class="muted">Position non encore re√ßue.</div>
      <div class="field">
        <button id="btnToggleGeoloc" class="btn btn-primary btn-icon" type="button">
          <span>üìç</span><span>D√©marrer la g√©oloc</span>
        </button>
      </div>
    </div>

    <!-- PK ACTUEL -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">PK actuel</div>
      </div>
      <div id="pkCurrentValue" class="big-value">‚Äî</div>
      <div id="pkCurrentDetails" class="big-sub">En attente de position GPS‚Ä¶</div>
    </div>

    <!-- GARE LA PLUS PROCHE -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Gare la plus proche (en PK)</div>
      </div>
      <div id="nearestStationName" class="big-value">Aucune</div>
      <div id="nearestStationInfo" class="big-sub">En attente de position GPS‚Ä¶</div>
    </div>

    <!-- SENS / MOUVEMENT -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Sens / mouvement</div>
      </div>
      <div id="movementTitle" class="big-value">En attente d‚Äôun deuxi√®me point‚Ä¶</div>
      <div id="movementDetails" class="big-sub">‚Äî</div>
    </div>

    <!-- PROCHAINE GARE -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Prochaine gare (en PK)</div>
      </div>
      <div id="nextStationName" class="big-value">Aucune</div>
      <div id="nextStationInfo" class="big-sub">En attente de position GPS‚Ä¶</div>
    </div>

    <!-- PLAN / PK CIBLE / GARES / ACC√àS -->
<div id="orientationCard" class="card orientation-block" style="display:none;">
  <div class="card-header">
    <div class="card-title">Plan ‚Äì PK / gares / acc√®s</div>
  </div>

  <!-- Carte interactive Leaflet -->
  <div id="orientationMap"></div>
  
  <!-- Panneau d'information -->
  <div id="orientationInfoPanel" class="orientation-info-panel" style="display: none;">
    <div class="orientation-info-item">
      <span class="orientation-info-label">PK actuel :</span>
      <span id="orientPkValue" class="orientation-info-value">‚Äî</span>
    </div>
    <div class="orientation-info-item">
      <span class="orientation-info-label">Sens :</span>
      <span id="orientDirValue" class="orientation-info-value">En attente de GPS‚Ä¶</span>
    </div>
    <div class="orientation-info-item">
      <span class="orientation-info-label">Gare la plus proche :</span>
      <span id="orientGareValue" class="orientation-info-value">‚Äî</span>
    </div>
    <div class="orientation-info-item">
      <span class="orientation-info-label">Acc√®s les plus proches :</span>
      <span id="orientAccessValue" class="orientation-info-value">‚Äî</span>
    </div>
  </div>
</div>

    <!-- Case √† cocher Plan -->
    <div class="card" style="margin-bottom: 12px;">
      <div class="field" style="margin: 0; padding: 12px;">
        <label style="display: flex; align-items: center; cursor: pointer; width: 100%; margin: 0; position: relative;">
          <input id="toggleOrientation" type="checkbox" style="margin: 0; width: 18px; height: 18px; flex-shrink: 0;">
          <span style="position: absolute; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; pointer-events: none; font-size: 1.1rem; font-weight: 600; color: #fff;">Plan ‚Äì PK / gares / acc√®s</span>
        </label>
      </div>
    </div>

    <!-- PK CIBLE -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">PK cible</div>
      </div>
      <div id="pkTargetLabel" class="big-value">Aucun</div>
      <div id="pkTargetInfo" class="big-sub">
        Saisis un PK puis clique sur ¬´ D√©finir ce PK comme cible ¬ª.
      </div>
      <div class="field">
        <input id="inputPkTarget" type="text" placeholder="ex : 32400 ou 32+400" />
        <button id="btnSetPkTarget" class="btn btn-primary" type="button">D√©finir ce PK comme cible</button>
      </div>
    </div>

    <!-- ACC√àS / GARes LES PLUS PROCHES -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Acc√®s / gares les plus proches (en PK)</div>
      </div>
      <div class="big-sub">Acc√®s les plus proches</div>
      <div id="accessList" class="muted" style="margin-top:8px;">
        En attente de position GPS‚Ä¶
      </div>
    </div>

    <!-- URGENCE / SMS -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Urgence / partage position</div>
      </div>
      <div id="smsPreview" class="muted">
        En attente de position GPS pour pr√©parer le SMS.
      </div>
      <div class="field">
        <button id="btnSms" class="btn btn-danger btn-icon" type="button">
          <span>‚úâÔ∏è</span><span>SMS d‚Äôurgence</span>
        </button>
      </div>
    </div>

    <!-- BOUTON PARAM√àTRES EN BAS -->
    <div class="bottom-bar">
      <button id="btnSettingsToggle" class="btn btn-secondary btn-icon" type="button">
        <span>‚öôÔ∏è</span><span>Param√®tres</span>
      </button>
    </div>

    <!-- PARAM√àTRES -->
    <div id="settingsPanel" class="card card-soft" style="display:none; margin-top:10px;">
      <div class="card-header">
      </div>

      <div class="divider"></div>

      <!-- Num√©ro SOS -->
      <div class="field">
        <label for="inputSosPhone">Num√©ro SOS pour le SMS d'urgence</label>
        <input id="inputSosPhone" type="tel" placeholder="ex : 0612345678 ou +33612345678" />
        <div style="margin-top: 8px;">
          <button id="btnSavePhone" class="btn btn-primary btn-icon" type="button">
            <span>üíæ</span><span>Sauvegarder</span>
          </button>
        </div>
        <div class="muted">Ce num√©ro sera utilis√© par le bouton ¬´ SMS d'urgence ¬ª.</div>
      </div>

      <div class="divider"></div>

      <!-- Sensibilit√© mouvement -->
      <div class="sensitivity-section">
        <div class="field">
          <label for="selectSensitivity">Sensibilit√© au mouvement</label>
          <select id="selectSensitivity">
            <option value="slow">Marche lente</option>
            <option value="normal">Normal</option>
            <option value="train">Train</option>
          </select>
          <div class="muted">¬´ Marche lente ¬ª d√©tecte plus facilement un d√©placement √† pied.</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Recalage PK -->
      <div class="pk-calibration-section">
        <div class="field">
          <label>Recalage PK</label>
          <div id="pkOffsetInfo" class="muted">Offset actuel : ¬±0 m appliqu√©s √† tous les PK.</div>
        </div>

        <div class="field">
          <label>Position PK estim√©e (lecture seule)</label>
          <div id="pkEstimateText" class="muted">En attente de position GPS‚Ä¶</div>
        </div>

        <div class="field">
          <label for="inputPkRecal">PK exact ici (pour recaler l'appli)</label>
          <input id="inputPkRecal" type="text" placeholder="ex : 52700 ou 52+700" />
          <button id="btnApplyRecal" class="btn btn-primary" type="button">Recaler l'appli sur ce PK</button>
        </div>

        <div class="field">
          <button id="btnResetOffset" class="btn btn-secondary" type="button">
            R√©initialiser le recalage PK
          </button>
        </div>

        <!-- AJOUT CALIBRAGE : bouton d'export -->
        <div class="field">
          <button id="btnExportCalibrations" class="btn btn-secondary btn-icon" type="button">
            <span>üì§</span><span>Exporter mes recalages (JSON)</span>
          </button>
          <div class="muted">
            Exporte les recalages que tu as faits (PK exact + GPS) pour les d√©poser ensuite dans GitHub.
          </div>
        </div>
        <!-- FIN AJOUT CALIBRAGE -->
      </div>

      <div class="divider"></div>

      <!-- Calcul couverture travaux (feux rouges et p√©tards) -->
      <div class="card" style="margin-top: 20px;">
        <div class="card-header">
          <div class="card-title">üö¶ Calcul couverture travaux</div>
        </div>
        <div class="field">
          <label for="inputCoveragePkStart">PK d√©but chantier (m)</label>
          <input id="inputCoveragePkStart" type="number" placeholder="ex : 48000" />
        </div>
        <div class="field">
          <label for="inputCoveragePkEnd">PK fin chantier (m)</label>
          <input id="inputCoveragePkEnd" type="number" placeholder="ex : 49000" />
        </div>
        <div class="field">
          <button id="btnComputeCoverage" class="btn btn-primary btn-icon" type="button">
            <span>üö¶</span><span>Calculer rouges & p√©tards</span>
          </button>
        </div>
        <div class="field" style="margin-top: 15px;">
          <label style="font-weight: 600; margin-bottom: 8px;">R√©sultats du calcul :</label>
          <div id="coverageResultsLine" style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; min-height: 40px; display: flex; align-items: center;">
            <span style="color: rgba(255, 255, 255, 0.5);">Cliquez sur ¬´ Calculer rouges & p√©tards ¬ª pour voir les r√©sultats</span>
          </div>
        </div>
        <div id="coverageResult" class="field" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
          <div id="coverageResultText" style="color: #fff; line-height: 1.6;"></div>
        </div>
        <div class="field">
          <button id="btnClearCoverage" class="btn btn-secondary" type="button" style="display: none;">
            Effacer les marqueurs
          </button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Recherche par PK -> acc√®s -->
      <div class="pk-lookup-section">
        <div class="field">
          <label for="inputPkLookup">Recherche par PK et GPS (acc√®s le plus proche)</label>
          <input id="inputPkLookup" type="text" placeholder="ex : 32400 ou 32+400" />
          <button id="btnPkLookup" class="btn btn-secondary btn-icon" type="button">
            <span>üîé</span><span>Rechercher l'acc√®s</span>
          </button>
        </div>

        <div class="field" id="pkLookupResultField" style="display:none;">
          <div id="pkLookupResult" class="muted"></div>

          <div class="field">
            <button id="btnPkLookupOpenMaps" class="btn btn-primary btn-icon" type="button">
              <span>üìç</span><span>Google Maps</span>
            </button>
            <button id="btnPkLookupOpenWaze" class="btn btn-secondary btn-icon" type="button">
              <span>üöó</span><span>Waze</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Signalement d‚Äôavarie -->
      <div class="signalement-block">
        <label for="selectIncidentType" style="font-weight: 700;">üö® Signalement d'avarie / incident</label>
        <select id="selectIncidentType">
          <option value="">-- Choisir un type d‚Äôincident --</option>
          <option value="Cheminement endommag√©">Cheminement endommag√©</option>
          <option value="Rail cass√©">Rail cass√©</option>
          <option value="Animal mort">Animal mort</option>
          <option value="Autre">Autre (saisir ci-dessous)</option>
        </select>

        <div class="field" id="incidentOtherField" style="display:none;">
          <label for="inputIncidentOther">Pr√©cisez l‚Äôincident :</label>
          <input id="inputIncidentOther" type="text" placeholder="ex : c√¢ble arrach√©, signal d√©t√©rior√©..." />
        </div>

        <div class="field">
          <label for="incidentPhoto">Photo (optionnel)</label>
          <input id="incidentPhoto" type="file" accept="image/*" />
        </div>

        <div class="field">
          <button id="btnGenerateIncident" class="btn btn-danger btn-icon" type="button">
            <span>üì£</span><span>G√©n√©rer le message de signalement</span>
          </button>
        </div>

        <div class="field" id="incidentResultField" style="display:none;">
          <label>Message g√©n√©r√© :</label>
          <textarea id="incidentResultText" rows="4" readonly></textarea>
          <button id="btnCopyIncident" class="btn btn-secondary btn-icon" type="button">
            <span>üìã</span><span>Copier le texte</span>
          </button>
        </div>
      </div>

      <div class="settings-footer">
        Ces r√©glages restent stock√©s dans ton navigateur (localStorage).  
        Ils ne sont pas effac√©s quand on met √† jour l‚Äôapplication.
      </div>
    </div>
  </div>

  <script>

    const ORIENT_ENABLED_KEY = "orientationEnabled";

    const ACCESS_CODE_KEY = "pkAssistantAccessGranted";
// ‚ö†Ô∏è Mets le code que tu veux ici (4 chiffres par ex.)
const ACCESS_CODE = "3615";

  // === DONN√âES DE LIGNE AVEC BIFURCATION ================================

  const troncCommun = [
    { name: "St-Germain-en-Laye",          lat: 48.8984745677, lon: 2.0946251970, pk:     0 },
    { name: "Le V√©sinet ‚Äì Le Pecq",        lat: 48.8984530458, lon: 2.1222846835, pk:  2000 },
    { name: "Le V√©sinet ‚Äì Centre",         lat: 48.8901555110, lon: 2.1347027835, pk:  4000 },
    { name: "Chatou ‚Äì Croissy",            lat: 48.8854638305, lon: 2.1564040970, pk:  6000 },
    { name: "Rueil-Malmaison",             lat: 48.8877403423, lon: 2.1725468932, pk:  7000 },
    { name: "Nanterre-Ville",              lat: 48.8952086355, lon: 2.1957210472, pk:  8000 },
    { name: "Nanterre-Universit√©",         lat: 48.9009541230, lon: 2.2128683712, pk: 11000 },
    { name: "Nanterre-Pr√©fecture",         lat: 48.8958449352, lon: 2.2230702306, pk: 12000 },
    { name: "La D√©fense ‚Äì Grande Arche",   lat: 48.8919045058, lon: 2.2385616258, pk: 13000 },
    { name: "Charles-de-Gaulle ‚Äì √âtoile",  lat: 48.8742900059, lon: 2.2948848393, pk: 18000 },
    { name: "Auber",                       lat: 48.8725358497, lon: 2.3298119681, pk: 20000 },
    { name: "Ch√¢telet ‚Äì Les Halles",       lat: 48.8619752528, lon: 2.3469363528, pk: 22000 },
    { name: "Gare de Lyon",                lat: 48.8444873499, lon: 2.3743558393, pk: 25000 },
    { name: "Nation",                      lat: 48.8488218026, lon: 2.3970239229, pk: 27000 },
    { name: "Vincennes",                   lat: 48.8475419027, lon: 2.4332766909, pk: 30000 },
    { name: "Fontenay-sous-Bois",          lat: 48.8457834716, lon: 2.4641534958, pk: 31500 },
    { name: "Val de Fontenay",             lat: 48.8544183594, lon: 2.4890884591, pk: 34000 }
  ];

  const brancheBoissy = [
    { name: "Nogent-sur-Marne",            lat: 48.8353972244, lon: 2.4716593319, pk: 35500 },
    { name: "Joinville-le-Pont",           lat: 48.8211820545, lon: 2.4641431755, pk: 37000 },
    { name: "Saint-Maur ‚Äì Cr√©teil",        lat: 48.8088207060, lon: 2.4708026167, pk: 38500 },
    { name: "La Varenne ‚Äì Chennevi√®res",   lat: 48.7941968899, lon: 2.5135124577, pk: 40000 },
    { name: "Sucy ‚Äì Bonneuil",             lat: 48.7709911746, lon: 2.5083777258, pk: 41500 },
    { name: "Boissy-Saint-L√©ger",          lat: 48.7539872386, lon: 2.5059802969, pk: 43000 }
  ];

  const brancheChessy = [
    { name: "Neuilly-Plaisance",           lat: 48.8534646981, lon: 2.5138398779, pk: 35500 },
    { name: "Bry-sur-Marne",               lat: 48.8442657465, lon: 2.5261924528, pk: 37000 },
    { name: "Noisy-le-Grand ‚Äì Mont d‚ÄôEst", lat: 48.8410135149, lon: 2.5527359297, pk: 39000 },
    { name: "Noisy ‚Äì Champs",              lat: 48.8429502416, lon: 2.5788366796, pk: 41000 },
    { name: "Noisiel",                     lat: 48.8437650426, lon: 2.6160790153, pk: 43000 },
    { name: "Lognes",                      lat: 48.8393611271, lon: 2.6335250335, pk: 45000 },
    { name: "Torcy",                       lat: 48.8390276009, lon: 2.6550584298, pk: 47000 },
    { name: "Bussy-Saint-Georges",         lat: 48.8371826388, lon: 2.7125386010, pk: 52000 },
    { name: "Val d‚ÄôEurope",                lat: 48.8561684149, lon: 2.7738274672, pk: 57000 },
    { name: "Marne-la-Vall√©e ‚Äì Chessy",    lat: 48.8707237150, lon: 2.7826307507, pk: 59000 }
  ];

  // Tous les points de gare (pour recherche la plus proche, tri, etc.)
  const stations = troncCommun.concat(brancheBoissy, brancheChessy);

  // Pour les acc√®s : un acc√®s par gare pour l‚Äôinstant
const accessPoints = [
  {
    name: "Gare de St Germain en Laye",
    address: "Gare de St Germain en Laye",
    pk: 0,
    lat: 48.90389600,
    lon: 2.10413400
  },
  {
    name: "¬´ P√®re Igor ¬ª, 39 all√©e de la capitainerie / all√©e des gas Le Pecq",
    address: "¬´ P√®re Igor ¬ª, 39 all√©e de la capitainerie / all√©e des gas Le Pecq",
    pk: 1050,
    lat: 48.90389410,
    lon: 2.10404180
  },
  {
    name: "Entre le 8 et le 10 all√©e des berceaux, Le Pecq (Acc√®s difficile)",
    address: "Entre le 8 et le 10 all√©e des berceaux, Le Pecq (Acc√®s difficile)",
    pk: 1100,
    lat: 48.90419444,
    lon: 2.10502778
  },
  {
    name: "1 all√©e des Gas (acc√®s difficile), Le Pecq",
    address: "1 all√©e des Gas (acc√®s difficile), Le Pecq",
    pk: 1200,
    lat: 48.90389890,
    lon: 2.10613190
  },
  {
    name: "21 bvd Folke Bernadotte, Le Pecq (2 acc√®s chaque c√¥t√© du pont RER)",
    address: "21 bvd Folke Bernadotte, Le Pecq (2 acc√®s chaque c√¥t√© du pont RER)",
    pk: 1750,
    lat: 48.90280760,
    lon: 2.11312440
  },
  {
    name: "47 av. du centre (fin de route, cul-de-sac), Le Pecq",
    address: "47 av. du centre (fin de route, cul-de-sac), Le Pecq",
    pk: 1800,
    lat: 48.90266080,
    lon: 2.11381940
  },
  {
    name: "63 route de Sartrouville, Le Pecq / 31 rue de Seine, Le V√©sinet (de chaque c√¥t√© du pont)",
    address: "63 route de Sartrouville, Le Pecq / 31 rue de Seine, Le V√©sinet (de chaque c√¥t√© du pont)",
    pk: 1855,
    lat: 48.90248620,
    lon: 2.11445710
  },
  {
    name: "23 rue de seine, Le Vesinet",
    address: "23 rue de seine, Le Vesinet",
    pk: 1950,
    lat: 48.90208930,
    lon: 2.11583780
  },
  {
    name: "5 ter rue de seine, Le Vesinet",
    address: "5 ter rue de seine, Le Vesinet",
    pk: 2300,
    lat: 48.90016667,
    lon: 2.11961111
  },
  {
    name: "Sq. Watteau, Le V√©sinet",
    address: "Sq. Watteau, Le V√©sinet",
    pk: 2365,
    lat: 48.89975000,
    lon: 2.12088889
  },
  {
    name: "Gare de Le Vesinet-Le Pecq",
    address: "Gare de Le Vesinet-Le Pecq",
    pk: 2505,
    lat: null,
    lon: null
  },
  {
    name: "Le Vesinet PR, 8 rue Alexandre Dumas, Le Vesinet (grand portail)",
    address: "Le Vesinet PR, 8 rue Alexandre Dumas, Le Vesinet (grand portail)",
    pk: 2750,
    lat: 48.89669444,
    lon: 2.12341667
  },
  {
    name: "100 av. Gallieni, Le V√©sinet",
    address: "100 av. Gallieni, Le V√©sinet",
    pk: 3100,
    lat: null,
    lon: null
  },
  {
    name: "54 av. Galli√©ni, 77 av. Emile Thi√©bault, Le V√©sinet",
    address: "54 av. Galli√©ni, 77 av. Emile Thi√©bault, Le V√©sinet",
    pk: 3460,
    lat: 48.89200130,
    lon: 2.12871240
  },
  {
    name: "32 av. Galli√©ni, Le V√©sinet",
    address: "32 av. Galli√©ni, Le V√©sinet",
    pk: 3750,
    lat: 48.89094210,
    lon: 2.13186570
  },
  {
    name: "Bout de quai de V√©sinet Centre, 61 av. Emile Thi√©bault, Le V√©sinet",
    address: "Bout de quai de V√©sinet Centre, 61 av. Emile Thi√©bault, Le V√©sinet",
    pk: 3808,
    lat: 48.89060440,
    lon: 2.13286440
  },
  {
    name: "Gare de Le V√©sinet Centre (c√¥t√© V2 : 53 av. Maurice Berteaux, Le V√©sinet)",
    address: "Gare de Le V√©sinet Centre (c√¥t√© V2 : 53 av. Maurice Berteaux, Le V√©sinet)",
    pk: 3808,
    lat: null,
    lon: null
  },
  {
    name: "Parking au croisement de av. Galli√©ni et rue Du Gal Clavery, Le V√©sinet",
    address: "Parking au croisement de av. Galli√©ni et rue Du Gal Clavery, Le V√©sinet",
    pk: 4060,
    lat: 48.88966667,
    lon: 2.13625000
  },
  {
    name: "27 av. du Gal De Gaulle, Le V√©sinet",
    address: "27 av. du Gal De Gaulle, Le V√©sinet",
    pk: 4150,
    lat: 48.88910410,
    lon: 2.13773730
  },
  {
    name: "2 bvd des √âtats-Unis, Le V√©sinet",
    address: "2 bvd des √âtats-Unis, Le V√©sinet",
    pk: 4400,
    lat: 48.88791667,
    lon: 2.14166667
  },
  {
    name: "25 av. Maurice Bertaux, Le V√©sinet",
    address: "25 av. Maurice Bertaux, Le V√©sinet",
    pk: 4500,
    lat: 48.88808333,
    lon: 2.14105556
  },
  {
    name: "29 avenue Charles Lambert, Ch√¢tou",
    address: "29 avenue Charles Lambert, Ch√¢tou",
    pk: 4890,
    lat: 48.88650000,
    lon: 2.14630556
  },
  {
    name: "5 av. Charles Lambert, Ch√¢tou",
    address: "5 av. Charles Lambert, Ch√¢tou",
    pk: 5100,
    lat: 48.88593117,
    lon: 2.14874668
  },
  {
    name: "25 av. du Mar√©chal Joffre, Ch√¢tou",
    address: "25 av. du Mar√©chal Joffre, Ch√¢tou",
    pk: 5250,
    lat: 48.88558159,
    lon: 2.15111261
  },
  {
    name: "Gare de Ch√¢tou ‚Äì Croissy",
    address: "Gare de Ch√¢tou ‚Äì Croissy",
    pk: 5502,
    lat: null,
    lon: null
  },
  {
    name: "Bout de quai V2 c√¥t√© Paris : 2 av des Tilleuls, Ch√¢tou (fond de l‚Äôimpasse)",
    address: "Bout de quai V2 c√¥t√© Paris : 2 av des Tilleuls, Ch√¢tou (fond de l‚Äôimpasse)",
    pk: 5727,
    lat: 48.88516352,
    lon: 2.15757085
  },
  {
    name: "Mail des impressionnistes, Chatou (√éle de Chatou,",
    address: "Mail des impressionnistes, Chatou (√éle de Chatou,",
    pk: 5950,
    lat: 48.88522222,
    lon: 2.16013889
  },
  {
    name: "Mail des impressionnistes, Chatou (√éle de Chatou,",
    address: "Mail des impressionnistes, Chatou (√éle de Chatou,",
    pk: 6070,
    lat: 48.88547222,
    lon: 2.16219444
  },
  {
    name: "38 rue des Martinets, Rueil-Malmaison / 19 av. de Seine, Rueil-Malmaison",
    address: "38 rue des Martinets, Rueil-Malmaison / 19 av. de Seine, Rueil-Malmaison",
    pk: 6250,
    lat: 48.88586272,
    lon: 2.16488900
  },
  {
    name: "27 av. de Seine, Rueil Malmaison",
    address: "27 av. de Seine, Rueil Malmaison",
    pk: 6430,
    lat: null,
    lon: null
  },
  {
    name: "PR de Rueil, Avenue de Colmar, Rueil-Malmaison",
    address: "PR de Rueil, Avenue de Colmar, Rueil-Malmaison",
    pk: 6570,
    lat: 48.88666667,
    lon: 2.16883333
  },
  {
    name: "Gare de Rueil-Malmaison, 2 rue des 2 gares, Rueil-Malmaison",
    address: "Gare de Rueil-Malmaison, 2 rue des 2 gares, Rueil-Malmaison",
    pk: 6758,
    lat: null,
    lon: null
  },
  {
    name: "Faisceau de Rueil, 143 bvd National, Rueil-Malmaison",
    address: "Faisceau de Rueil, 143 bvd National, Rueil-Malmaison",
    pk: 7500,
    lat: 48.89034072,
    lon: 2.17954308
  },
  {
    name: "CAT Nanterre (acc√®s par badge), 33 av. Henri Martin, Nanterre",
    address: "CAT Nanterre (acc√®s par badge), 33 av. Henri Martin, Nanterre",
    pk: 8250,
    lat: 48.89291667,
    lon: 2.18800000
  },
  {
    name: "Croisement 55 rue de Stalingrad / 57 bvd du Couchant, Nanterre",
    address: "Croisement 55 rue de Stalingrad / 57 bvd du Couchant, Nanterre",
    pk: 8500,
    lat: 48.89447222,
    lon: 2.19358333
  },
  {
    name: "Gare de Nanterre Ville",
    address: "Gare de Nanterre Ville",
    pk: 8600,
    lat: null,
    lon: null
  },
  {
    name: "10 all√©e des Parfumeurs (fond de l‚Äôimpasse), Nanterre (Parking difficile)",
    address: "10 all√©e des Parfumeurs (fond de l‚Äôimpasse), Nanterre (Parking difficile)",
    pk: 9000,
    lat: 48.89619076,
    lon: 2.19848833
  },
  {
    name: "Rd-pt 56 rue Pascal / 1 rue Paul Bert, Nanterre",
    address: "Rd-pt 56 rue Pascal / 1 rue Paul Bert, Nanterre",
    pk: 9200,
    lat: 48.89711102,
    lon: 2.20139055
  },
  {
    name: "Cabane des signaux, 94 rue Pascal Nanterre",
    address: "Cabane des signaux, 94 rue Pascal Nanterre",
    pk: 9400,
    lat: 48.89805290,
    lon: 2.20437687
  },
  {
    name: "118 rue Pascal Nanterre",
    address: "118 rue Pascal Nanterre",
    pk: 9650,
    lat: 48.89871930,
    lon: 2.20627078
  },
  {
    name: "Passerelle Nanterre-Ville (2 acc√®s de chaque c√¥t√© de la passerelle), bvd Blaise Pascal, face au 1 all√©e Georges Courteline, Nanterre",
    address: "Passerelle Nanterre-Ville (2 acc√®s de chaque c√¥t√© de la passerelle), bvd Blaise Pascal, face au 1 all√©e Georges Courteline, Nanterre",
    pk: 9800,
    lat: 48.89956965,
    lon: 2.20894508
  },
  {
    name: "1C / 2C (branche Cergy) (2 acc√®s de chaque c√¥t√© du pont), 83 bvd des Provinces Fran√ßaises, Nanterre",
    address: "1C / 2C (branche Cergy) (2 acc√®s de chaque c√¥t√© du pont), 83 bvd des Provinces Fran√ßaises, Nanterre",
    pk: 10050,
    lat: 48.89977146,
    lon: 2.21360501
  },
  {
    name: "Gare de Nanterre Universit√©",
    address: "Gare de Nanterre Universit√©",
    pk: 10111,
    lat: null,
    lon: null
  },
  {
    name: "Courbe de la Folie, Croisement 521 Bd des Provinces Fran√ßaises / all√©e d‚ÄôAquitaine, Nanterre",
    address: "Courbe de la Folie, Croisement 521 Bd des Provinces Fran√ßaises / all√©e d‚ÄôAquitaine, Nanterre",
    pk: 10450,
    lat: 48.90204234,
    lon: 2.21802275
  },
  {
    name: "Gare de Nanterre Pr√©fecture",
    address: "Gare de Nanterre Pr√©fecture",
    pk: 11638,
    lat: null,
    lon: null
  },
  {
    name: "ADV 710 / 712 : passage par √©chelle au niveau de la baie de ventilation",
    address: "ADV 710 / 712 : passage par √©chelle au niveau de la baie de ventilation",
    pk: 12100,
    lat: null,
    lon: null
  },
  {
    name: "Baie de ventilation, 26 rue des Longues Raies, Nanterre (acc√®s avec la PP)",
    address: "Baie de ventilation, 26 rue des Longues Raies, Nanterre (acc√®s avec la PP)",
    pk: 12430,
    lat: null,
    lon: null
  },
  {
    name: "Bout de VA / VB √† D√©fense",
    address: "Bout de VA / VB √† D√©fense",
    pk: 12650,
    lat: null,
    lon: null
  },
  {
    name: "Passage V2 / VB √† D√©fense",
    address: "Passage V2 / VB √† D√©fense",
    pk: 12730,
    lat: null,
    lon: null
  },
  {
    name: "Gare de La D√©fense",
    address: "Gare de La D√©fense",
    pk: 12990,
    lat: null,
    lon: null
  },
  {
    name: "Aire de stockage VA / VB de D√©fense",
    address: "Aire de stockage VA / VB de D√©fense",
    pk: 13280,
    lat: null,
    lon: null
  },
  {
    name: "Musoir de D√©fense >‚Äì",
    address: "Musoir de D√©fense >‚Äì",
    pk: 13420,
    lat: null,
    lon: null
  },
  {
    name: "Pont de Neuilly, 191 av. Ch. De Gaulle, Neuilly via la station de m√©tro Pont de Neuilly (milieu de Quai dir. Ch√¢teau de Vincennes)",
    address: "Pont de Neuilly, 191 av. Ch. De Gaulle, Neuilly via la station de m√©tro Pont de Neuilly (milieu de Quai dir. Ch√¢teau de Vincennes)",
    pk: 14934,
    lat: 48.88446330,
    lon: 2.26128519
  },
  {
    name: "Nordling, Place Nordling, Neuilly sur Seine (entr√©e face au 5 rue Raoul Nordling)",
    address: "Nordling, Place Nordling, Neuilly sur Seine (entr√©e face au 5 rue Raoul Nordling)",
    pk: 16350,
    lat: null,
    lon: null
  },
  {
    name: "Gare de Charles De Gaulle - √âtoile",
    address: "Gare de Charles De Gaulle - √âtoile",
    pk: 17563,
    lat: null,
    lon: null
  },
  {
    name: "Acc√®s pompier ¬´ Friedland ¬ª, 147 bvd Haussmann, Paris 8e (entr√©e pi√©ton du parking sur la rue)",
    address: "Acc√®s pompier ¬´ Friedland ¬ª, 147 bvd Haussmann, Paris 8e (entr√©e pi√©ton du parking sur la rue)",
    pk: 18895,
    lat: 48.87495190,
    lon: 2.31164272
  },
  {
    name: "Gare de Auber, 17 rue Scribe, 5 Rue des Mathurins",
    address: "Gare de Auber, 17 rue Scribe, 5 Rue des Mathurins",
    pk: 20201,
    lat: 48.87290641,
    lon: 2.32995737
  },
  {
    name: "Musoir de Ch√¢telet ‚Äì<",
    address: "Musoir de Ch√¢telet ‚Äì<",
    pk: 21626,
    lat: null,
    lon: null
  },
  {
    name: "Gare de Ch√¢telet les Halles. Via souterrain des Halles (suivre ¬´ forum Nord ¬ª). Via station Les Halles L4 : 103 rue Rambuteau",
    address: "Gare de Ch√¢telet les Halles. Via souterrain des Halles (suivre ¬´ forum Nord ¬ª). Via station Les Halles L4 : 103 rue Rambuteau",
    pk: 22077,
    lat: 48.86269354,
    lon: 2.34661165
  },
  {
    name: "¬´ Nicolas Flamel ¬ª (trappe) (√Ä CONFIRMER), Angle 39 rue de Rivoli / 10 rue St Martin √Ä c√¥t√© du square de la tour St Jacques. Acc√®s commun ligne A et B",
    address: "¬´ Nicolas Flamel ¬ª (trappe) (√Ä CONFIRMER), Angle 39 rue de Rivoli / 10 rue St Martin √Ä c√¥t√© du square de la tour St Jacques. Acc√®s commun ligne A et B",
    pk: 22650,
    lat: 48.85795843,
    lon: 2.34956165
  },
  {
    name: "‚Üê V1 / ‚Üê V2 (REDAN √Ä CONFIRMER)",
    address: "‚Üê V1 / ‚Üê V2 (REDAN √Ä CONFIRMER)",
    pk: 23180,
    lat: null,
    lon: null
  },
  {
    name: "Par escaliers acc√®s pompiers, Nonnains d'Hy√®res (trappe) 10-12 rue Nonnains d'Hy√®res, Paris 4e",
    address: "Par escaliers acc√®s pompiers, Nonnains d'Hy√®res (trappe) 10-12 rue Nonnains d'Hy√®res, Paris 4e",
    pk: 23420,
    lat: 48.85404139,
    lon: 2.35854652
  },
  {
    name: "Gare de Lyon, Acc√®s face au 164 rue de Bercy, Paris 12e",
    address: "Gare de Lyon, Acc√®s face au 164 rue de Bercy, Paris 12e",
    pk: 24902,
    lat: 48.84319067,
    lon: 2.37499372
  },
  {
    name: "Les ruches (entr√©e du tunnel), 5 av. Gambetta, Saint-Mand√©",
    address: "Les ruches (entr√©e du tunnel), 5 av. Gambetta, Saint-Mand√©",
    pk: 28900,
    lat: 48.84430170,
    lon: 2.42007197
  },
  {
    name: "Rampe en terre, 102 av. Aubert, Vincennes",
    address: "Rampe en terre, 102 av. Aubert, Vincennes",
    pk: 29350,
    lat: 48.84620131,
    lon: 2.42424566
  },
  {
    name: "Gare de Vincennes",
    address: "Gare de Vincennes",
    pk: 29894,
    lat: null,
    lon: null
  },
  {
    name: "Mairie de St-Mand√©, 16 av. Pierre Brossolette, Vincennes",
    address: "Mairie de St-Mand√©, 16 av. Pierre Brossolette, Vincennes",
    pk: 30660,
    lat: 48.84694709,
    lon: 2.44195127
  },
  {
    name: "28 bvd de la lib√©ration, Vincennes",
    address: "28 bvd de la lib√©ration, Vincennes",
    pk: 31250,
    lat: 48.84663889,
    lon: 2.44977778
  },
  {
    name: "Acc√®s Pompiers, 1 Place du Mar√©chal-Lyautey, Vincennes",
    address: "Acc√®s Pompiers, 1 Place du Mar√©chal-Lyautey, Vincennes",
    pk: 31400,
    lat: 48.84619098,
    lon: 2.45189408
  },
  {
    name: "49 av. des Charmes, Fontenay sous Bois",
    address: "49 av. des Charmes, Fontenay sous Bois",
    pk: 31795,
    lat: 48.84551317,
    lon: 2.45553573
  },
  {
    name: "Via la gare de Fontenay",
    address: "Via la gare de Fontenay",
    pk: 32460,
    lat: null,
    lon: null
  },
  {
    name: "Gare de Val de Fontenay",
    address: "Gare de Val de Fontenay",
    pk: 34421,
    lat: null,
    lon: null
  },
  {
    name: "CAT VDF (acc√®s par badge), 199 rue Carnot, Fontenay sous Bois",
    address: "CAT VDF (acc√®s par badge), 199 rue Carnot, Fontenay sous Bois",
    pk: 34660,
    lat: 48.85463889,
    lon: 2.48977778
  },
  {
    name: "¬´ Le bateau ¬ª, Chemin de la Prairie, Neuilly Plaisance",
    address: "¬´ Le bateau ¬ª, Chemin de la Prairie, Neuilly Plaisance",
    pk: 35200,
    lat: 48.85713889,
    lon: 2.49594444
  },
  {
    name: "18 rue Pasteur Neuilly Plaisance",
    address: "18 rue Pasteur Neuilly Plaisance",
    pk: 35500,
    lat: 48.85746827,
    lon: 2.49998451
  },
  {
    name: "Gare de Neuilly Plaisance",
    address: "Gare de Neuilly Plaisance",
    pk: 36630,
    lat: null,
    lon: null
  },
  {
    name: "PR de Bry (fin du viaduc)",
    address: "PR de Bry (fin du viaduc)",
    pk: 37050,
    lat: null,
    lon: null
  },
  {
    name: "30 rue du G√©n√©ral Leclerc, Bry-sur-Marne",
    address: "30 rue du G√©n√©ral Leclerc, Bry-sur-Marne",
    pk: 37100,
    lat: 48.83272275,
    lon: 2.52168104
  },
  {
    name: "145 bvd de la Libert√©, Bry-sur-Marne",
    address: "145 bvd de la Libert√©, Bry-sur-Marne",
    pk: 37300,
    lat: 48.83562965,
    lon: 2.49469926
  },
  {
    name: "Gare de Bry-sur-Marne",
    address: "Gare de Bry-sur-Marne",
    pk: 37892,
    lat: null,
    lon: null
  },
  {
    name: "121 bvd de la Libert√© (Acc√®s difficile), Bry-sur-Marne",
    address: "121 bvd de la Libert√© (Acc√®s difficile), Bry-sur-Marne",
    pk: 38130,
    lat: 48.84838889,
    lon: 2.53066667
  },
  {
    name: "Parking 23 bvd G. Cl√©menceau, Bry-sur-Marne",
    address: "Parking 23 bvd G. Cl√©menceau, Bry-sur-Marne",
    pk: 38500,
    lat: 48.84262630,
    lon: 2.52663406
  },
  {
    name: "Rue des P√¢tis, Bry-sur-Marne",
    address: "Rue des P√¢tis, Bry-sur-Marne",
    pk: 38800,
    lat: 48.84436111,
    lon: 2.53772222
  },
  {
    name: "Parking du RER (4 acc√®s), 3 av. Jean Kiffer, Champigny-sur-Marne",
    address: "Parking du RER (4 acc√®s), 3 av. Jean Kiffer, Champigny-sur-Marne",
    pk: 39400,
    lat: 48.84175000,
    lon: 2.54502778
  },
  {
    name: "Gare de Champigny",
    address: "Gare de Champigny",
    pk: 39529,
    lat: null,
    lon: null
  },
  {
    name: "39 av. J. Baptiste Cl√©ment, Champigny-sur-Marne",
    address: "39 av. J. Baptiste Cl√©ment, Champigny-sur-Marne",
    pk: 39950,
    lat: null,
    lon: null
  },
  {
    name: "13 av. Foch, Champigny-sur-Marne",
    address: "13 av. Foch, Champigny-sur-Marne",
    pk: 40200,
    lat: null,
    lon: null
  },
  {
    name: "19 av. du Mar√©chal Leclerc, La Varenne",
    address: "19 av. du Mar√©chal Leclerc, La Varenne",
    pk: 40500,
    lat: null,
    lon: null
  },
  {
    name: "37 av. Foch, La Varenne",
    address: "37 av. Foch, La Varenne",
    pk: 40850,
    lat: 48.83088889,
    lon: 2.56069444
  },
  {
    name: "Gare de La Varenne - Chennevi√®res",
    address: "Gare de La Varenne - Chennevi√®res",
    pk: 41229,
    lat: null,
    lon: null
  },
  {
    name: "60 av. du Mar√©chal Leclerc, La Varenne",
    address: "60 av. du Mar√©chal Leclerc, La Varenne",
    pk: 41700,
    lat: null,
    lon: null
  },
  {
    name: "118 av. du Mar√©chal Leclerc, La Varenne",
    address: "118 av. du Mar√©chal Leclerc, La Varenne",
    pk: 42150,
    lat: null,
    lon: null
  },
  {
    name: "150 av. du Mar√©chal Leclerc, La Varenne",
    address: "150 av. du Mar√©chal Leclerc, La Varenne",
    pk: 42600,
    lat: null,
    lon: null
  },
  {
    name: "102 av. du G√©n√©ral De Gaulle, Sucy-en-Brie",
    address: "102 av. du G√©n√©ral De Gaulle, Sucy-en-Brie",
    pk: 42750,
    lat: 48.81308333,
    lon: 2.57508333
  },
  {
    name: "191 av. du G√©n√©ral De Gaulle, Sucy-en-Brie",
    address: "191 av. du G√©n√©ral De Gaulle, Sucy-en-Brie",
    pk: 43500,
    lat: 48.80919444,
    lon: 2.58255556
  },
  {
    name: "Gare de Sucy-Bonneuil",
    address: "Gare de Sucy-Bonneuil",
    pk: 44577,
    lat: null,
    lon: null
  },
  {
    name: "¬´ La cantine ¬ª 11 chemin vert (acc√®s au niveau du pont), Sucy en Brie",
    address: "¬´ La cantine ¬ª 11 chemin vert (acc√®s au niveau du pont), Sucy en Brie",
    pk: 45150,
    lat: 48.76594444,
    lon: 2.50536111
  },
  {
    name: "Voie Mexico, Rue de Villeneuve, Boissy St L√©ger",
    address: "Voie Mexico, Rue de Villeneuve, Boissy St L√©ger",
    pk: 45800,
    lat: 48.75961111,
    lon: 2.50802778
  },
  {
    name: "Atelier MRF Sucy, 13 chemin vert, Sucy en brie",
    address: "Atelier MRF Sucy, 13 chemin vert, Sucy en brie",
    pk: 46200,
    lat: 48.76529003,
    lon: 2.50217879
  },
  {
    name: "Gare de Boissy-Saint-L√©ger",
    address: "Gare de Boissy-Saint-L√©ger",
    pk: 47795,
    lat: null,
    lon: null
  },
  {
    name: "PST Sucy",
    address: "PST Sucy",
    pk: 47780,
    lat: null,
    lon: null
  },
  {
    name: "Bvd Georges Cl√©menceau",
    address: "Bvd Georges Cl√©menceau",
    pk: 47380,
    lat: null,
    lon: null
  },
  {
    name: "20 av. de l'hippodrome, La Varenne",
    address: "20 av. de l'hippodrome, La Varenne",
    pk: 44050,
    lat: 48.86168940,
    lon: 2.21708690
  },
  {
    name: "17 route de Br√©tigny, Bonneuil sur marne (Portail √† droite avant le pont)",
    address: "17 route de Br√©tigny, Bonneuil sur marne (Portail √† droite avant le pont)",
    pk: 43160,
    lat: 48.78379361,
    lon: 2.50701747
  },
  {
    name: "253 bvd de Cr√©teil, St Maur des foss√©s",
    address: "253 bvd de Cr√©teil, St Maur des foss√©s",
    pk: 42500,
    lat: 48.78880556,
    lon: 2.49950000
  },
  {
    name: "PR de St Maur (3 acc√®s), bvd de Cr√©teil St Maur des foss√©s",
    address: "PR de St Maur (3 acc√®s), bvd de Cr√©teil St Maur des foss√©s",
    pk: 41500,
    lat: null,
    lon: null
  },
  {
    name: "16 all√©e du Petit Parc, St Maur des foss√©s",
    address: "16 all√©e du Petit Parc, St Maur des foss√©s",
    pk: 41200,
    lat: null,
    lon: null
  },
  {
    name: "20 bvd de Cr√©teil, St Maur des foss√©s",
    address: "20 bvd de Cr√©teil, St Maur des foss√©s",
    pk: 40850,
    lat: 48.80272222,
    lon: 2.48561111
  },
  {
    name: "Gare de St-Maur - Cr√©teil",
    address: "Gare de St-Maur - Cr√©teil",
    pk: 40750,
    lat: null,
    lon: null
  },
  {
    name: "50 av. du Bac, St Maur des foss√©s",
    address: "50 av. du Bac, St Maur des foss√©s",
    pk: 39500,
    lat: 48.79488373,
    lon: 2.51269474
  },
  {
    name: "86 av. du Bac, St Maur des foss√©s",
    address: "86 av. du Bac, St Maur des foss√©s",
    pk: 39150,
    lat: 48.79407368,
    lon: 2.51247564
  },
  {
    name: "Gare de Le Parc de St-Maur",
    address: "Gare de Le Parc de St-Maur",
    pk: 38623,
    lat: null,
    lon: null
  },
  {
    name: "76 av. du Mar√©chal Lyautey, St Maur des foss√©s",
    address: "76 av. du Mar√©chal Lyautey, St Maur des foss√©s",
    pk: 38450,
    lat: 48.81013889,
    lon: 2.47586111
  },
  {
    name: "3 av. de la Terrasse, St Maur des foss√©s",
    address: "3 av. de la Terrasse, St Maur des foss√©s",
    pk: 37950,
    lat: 48.81394444,
    lon: 2.46969444
  },
  {
    name: "20 av. de Cond√©, St Maur des foss√©s",
    address: "20 av. de Cond√©, St Maur des foss√©s",
    pk: 37550,
    lat: 48.81722222,
    lon: 2.46483333
  },
  {
    name: "Gare de St-Maur - L'√âcluse",
    address: "Gare de St-Maur - L'√âcluse",
    pk: 37476,
    lat: null,
    lon: null
  },
  {
    name: "3 av. Jean Brossolette, St Maur des foss√©s",
    address: "3 av. Jean Brossolette, St Maur des foss√©s",
    pk: 37200,
    lat: 48.80636689,
    lon: 2.49329289
  },
  {
    name: "1 av. de Cond√©, St Maur des foss√©s",
    address: "1 av. de Cond√©, St Maur des foss√©s",
    pk: 37050,
    lat: null,
    lon: null
  },
  {
    name: "Gare de Joinville-le-Pont",
    address: "Gare de Joinville-le-Pont",
    pk: 35800,
    lat: null,
    lon: null
  },
  {
    name: "32 av. Foch, Joinville-le-Pont",
    address: "32 av. Foch, Joinville-le-Pont",
    pk: 35600,
    lat: null,
    lon: null
  },
  {
    name: "16 quai de Polangis, Joinville-le-Pont",
    address: "16 quai de Polangis, Joinville-le-Pont",
    pk: 35300,
    lat: 48.82212116,
    lon: 2.46435795
  },
  {
    name: "47 bvd de l'Europe, Joinville-le-Pont",
    address: "47 bvd de l'Europe, Joinville-le-Pont",
    pk: 35150,
    lat: 48.81500797,
    lon: 2.46438259
  },
  {
    name: "4 rue de l'Esp√©rance, Joinville-le-Pont",
    address: "4 rue de l'Esp√©rance, Joinville-le-Pont",
    pk: 35000,
    lat: null,
    lon: null
  },
  {
    name: "6 av. des Tilleuls, Nogent-sur-Marne",
    address: "6 av. des Tilleuls, Nogent-sur-Marne",
    pk: 34800,
    lat: 48.83143509,
    lon: 2.47019678
  },
  {
    name: "20 bvd de la Marne, Nogent-sur-Marne",
    address: "20 bvd de la Marne, Nogent-sur-Marne",
    pk: 34650,
    lat: 48.83182648,
    lon: 2.47057077
  },
  {
    name: "Gare de Nogent-sur-Marne",
    address: "Gare de Nogent-sur-Marne",
    pk: 34020,
    lat: null,
    lon: null
  },
  {
    name: "60 bvd de la R√©publique, Nogent-sur-Marne",
    address: "60 bvd de la R√©publique, Nogent-sur-Marne",
    pk: 33700,
    lat: null,
    lon: null
  },
  {
    name: "20 bvd de la Marne, Nogent-sur-Marne",
    address: "20 bvd de la Marne, Nogent-sur-Marne",
    pk: 33550,
    lat: null,
    lon: null
  },
  {
    name: "155 av. du G√©n√©ral Leclerc, Nogent-sur-Marne",
    address: "155 av. du G√©n√©ral Leclerc, Nogent-sur-Marne",
    pk: 33450,
    lat: null,
    lon: null
  },
  {
    name: "5 rue des Hautes Plainses, Fontenay (Acc√®s difficile)",
    address: "5 rue des Hautes Plainses, Fontenay (Acc√®s difficile)",
    pk: 33200,
    lat: null,
    lon: null
  },
  {
    name: "Gare de Fontenay",
    address: "Gare de Fontenay",
    pk: 32890,
    lat: null,
    lon: null
  },
  {
    name: "5 av. Gambetta, Saint-Mand√©",
    address: "5 av. Gambetta, Saint-Mand√©",
    pk: 32200,
    lat: 48.84437790,
    lon: 2.42016489
  },
  {
    name: "145 av. du G√©n√©ral Leclerc, St Mand√©",
    address: "145 av. du G√©n√©ral Leclerc, St Mand√©",
    pk: 31950,
    lat: null,
    lon: null
  },
  {
    name: "PR de Bry (fin du viaduc) / 8 Rue du Vingt Six Ao√ªt 1944, Bry-sur-Marne",
    address: "PR de Bry (fin du viaduc) / 8 Rue du Vingt Six Ao√ªt 1944, Bry-sur-Marne",
    pk: 37100,
    lat: null,
    lon: null
  },
  {
    name: "Sortie du parc de Bry / 86 av. de Rigny, Bry-sur-Marne",
    address: "Sortie du parc de Bry / 86 av. de Rigny, Bry-sur-Marne",
    pk: 37700,
    lat: 48.84683028,
    lon: 2.52364667
  },
  {
    name: "Gare de Bry-sur-Marne",
    address: "Gare de Bry-sur-Marne",
    pk: 37835,
    lat: null,
    lon: null
  },
  {
    name: "Parc de Bry / 127 bvd Gallieni, Bry-sur-Marne",
    address: "Parc de Bry / 127 bvd Gallieni, Bry-sur-Marne",
    pk: 38050,
    lat: 48.84528599,
    lon: 2.52629374
  },
  {
    name: "66 av Georges Cl√©menceau, Bry-sur-Marne",
    address: "66 av Georges Cl√©menceau, Bry-sur-Marne",
    pk: 38200,
    lat: 48.84301133,
    lon: 2.52677550
  },
  {
    name: "11 rue des Templiers / 14 rue de la Croix aux Biches, Bry-sur-Marne",
    address: "11 rue des Templiers / 14 rue de la Croix aux Biches, Bry-sur-Marne",
    pk: 38380,
    lat: null,
    lon: null
  },
  {
    name: "¬´ Razel ¬ª / 1 rue des Vignes, Bry-sur-Marne",
    address: "¬´ Razel ¬ª / 1 rue des Vignes, Bry-sur-Marne",
    pk: 38600,
    lat: 48.84108994,
    lon: 2.53137569
  },
  {
    name: "Gare de Noisy le Gd ‚Äì Mt d'Est (Acc√®s ascenseur bout de quai 2)",
    address: "Gare de Noisy le Gd ‚Äì Mt d'Est (Acc√®s ascenseur bout de quai 2)",
    pk: 39749,
    lat: 48.84177778,
    lon: 2.54927778
  },
  {
    name: "Escalier m√©tallique / Face au 14 av. du Pav√© Neuf, Noisy-le-Grand",
    address: "Escalier m√©tallique / Face au 14 av. du Pav√© Neuf, Noisy-le-Grand",
    pk: 40200,
    lat: 48.84055556,
    lon: 2.55380556
  },
  {
    name: "1 Rue du Marnois Noisy-le-Grand",
    address: "1 Rue du Marnois Noisy-le-Grand",
    pk: 40680,
    lat: 48.84092116,
    lon: 2.56042493
  },
  {
    name: "A proximit√© du 120 rue Malnoue, Noisy-le-Grand",
    address: "A proximit√© du 120 rue Malnoue, Noisy-le-Grand",
    pk: 41350,
    lat: 48.84144444,
    lon: 2.56930556
  },
  {
    name: "(Acc√®s √† confirmer) / A proximit√© du 21 rue du Mar√©chal Juin (Acc√®s difficile), Noisy-le-Grand",
    address: "(Acc√®s √† confirmer) / A proximit√© du 21 rue du Mar√©chal Juin (Acc√®s difficile), Noisy-le-Grand",
    pk: 41530,
    lat: 48.84204558,
    lon: 2.57206337
  },
  {
    name: "Rue des Hauts Ch√¢teaux / Noisy-le-Grand",
    address: "Rue des Hauts Ch√¢teaux / Noisy-le-Grand",
    pk: 41725,
    lat: 48.84252778,
    lon: 2.57372222
  },
  {
    name: "Gare de Noisy-Champs",
    address: "Gare de Noisy-Champs",
    pk: 42058,
    lat: null,
    lon: null
  },
  {
    name: "Fin de quai / Avant le 1 bvd Archim√®de, Champs-sur-Marne",
    address: "Fin de quai / Avant le 1 bvd Archim√®de, Champs-sur-Marne",
    pk: 42340,
    lat: 48.84309131,
    lon: 2.58204106
  },
  {
    name: "¬´ Les sangliers ¬ª / Route de Malnoue (PR Noisiel), Champs-sur-Marne",
    address: "¬´ Les sangliers ¬ª / Route de Malnoue (PR Noisiel), Champs-sur-Marne",
    pk: 43750,
    lat: 48.84188889,
    lon: 2.60125000
  },
  {
    name: "42 cours du Luzard (acc√®s de chaque c√¥t√© du pont), Champs-sur-Marne",
    address: "42 cours du Luzard (acc√®s de chaque c√¥t√© du pont), Champs-sur-Marne",
    pk: 44050,
    lat: 48.84247222,
    lon: 2.60525000
  },
  {
    name: "Gare de Noisiel (Le Luzard)",
    address: "Gare de Noisiel (Le Luzard)",
    pk: 44754,
    lat: null,
    lon: null
  },
  {
    name: "2 all√©e Jean Paul Sartre / Cours du Buisson (2 acc√®s Rdpt Bvd Salvador Allend√©), Noisiel",
    address: "2 all√©e Jean Paul Sartre / Cours du Buisson (2 acc√®s Rdpt Bvd Salvador Allend√©), Noisiel",
    pk: 45080,
    lat: 48.84366667,
    lon: 2.61972222
  },
  {
    name: "¬´ Chocolaterie ¬ª / 111 grande all√©e du 12 f√©vrier 1934, Noisiel",
    address: "¬´ Chocolaterie ¬ª / 111 grande all√©e du 12 f√©vrier 1934, Noisiel",
    pk: 45490,
    lat: 48.84213889,
    lon: 2.62422222
  },
  {
    name: "Bv de la Malvoisine, Lognes",
    address: "Bv de la Malvoisine, Lognes",
    pk: 45900,
    lat: 48.84027778,
    lon: 2.62963889
  },
  {
    name: "Gare de Lognes / Acc√®s parking 18 rue Nicolas Appert",
    address: "Gare de Lognes / Acc√®s parking 18 rue Nicolas Appert",
    pk: 46107,
    lat: 48.83947222,
    lon: 2.63150000
  },
  {
    name: "¬´ Les paraboles ¬ª / Vers le 11 Bvd Fr√©d√©ric Chopin, Lognes",
    address: "¬´ Les paraboles ¬ª / Vers le 11 Bvd Fr√©d√©ric Chopin, Lognes",
    pk: 47100,
    lat: 48.83830556,
    lon: 2.64500000
  },
  {
    name: "Gare de Torcy (2 acc√®s : 2 av. Jean Moulin / 2 Rue L√©on Blum)",
    address: "Gare de Torcy (2 acc√®s : 2 av. Jean Moulin / 2 Rue L√©on Blum)",
    pk: 47757,
    lat: null,
    lon: null
  },
  {
    name: "Parking parc (c√¥t√© Torcy) / D128, Bussy-Saint-Martin",
    address: "Parking parc (c√¥t√© Torcy) / D128, Bussy-Saint-Martin",
    pk: 48150,
    lat: 48.84038889,
    lon: 2.65830556
  },
  {
    name: "MRF V19 (c√¥t√© Chessy) / Rd-pt de la grille noire, Bussy-Saint-Martin",
    address: "MRF V19 (c√¥t√© Chessy) / Rd-pt de la grille noire, Bussy-Saint-Martin",
    pk: 48700,
    lat: 48.84186111,
    lon: 2.66744444
  },
  {
    name: "1 Av. Michel Chartier, Bussy-Saint-Martin",
    address: "1 Av. Michel Chartier, Bussy-Saint-Martin",
    pk: 48850,
    lat: 48.84116667,
    lon: 2.66863889
  },
  {
    name: "¬´ Croix Blanche ¬ª (Acc√®s difficile) / Entr√©e parking √† c√¥t√© du 3 All. du Parc, Coll√©gien",
    address: "¬´ Croix Blanche ¬ª (Acc√®s difficile) / Entr√©e parking √† c√¥t√© du 3 All. du Parc, Coll√©gien",
    pk: 49550,
    lat: 48.83922222,
    lon: 2.67655556
  },
  {
    name: "¬´ Les Bordes ¬ª (Acc√®s difficile) / 41 rue de la brosse, Coll√©gien",
    address: "¬´ Les Bordes ¬ª (Acc√®s difficile) / 41 rue de la brosse, Coll√©gien",
    pk: 50250,
    lat: 48.83558333,
    lon: 2.68463889
  },
  {
    name: "¬´ Les gitans ¬ª / Rue de la Butte de Vaux, Coll√©gien",
    address: "¬´ Les gitans ¬ª / Rue de la Butte de Vaux, Coll√©gien",
    pk: 51150,
    lat: 48.83513889,
    lon: 2.69605556
  },
  {
    name: "Bvd de Lagny, Bussy-Saint-Georges",
    address: "Bvd de Lagny, Bussy-Saint-Georges",
    pk: 51850,
    lat: 48.83600000,
    lon: 2.70575000
  },
  {
    name: "Gare de Bussy-Saint-Georges",
    address: "Gare de Bussy-Saint-Georges",
    pk: 52099,
    lat: null,
    lon: null
  },
  {
    name: "¬´ La ferme ¬ª (Acc√®s pi√©ton et v√©hicule) / 7 all√©e Madame de Montespan, Bussy-Saint-Georges",
    address: "¬´ La ferme ¬ª (Acc√®s pi√©ton et v√©hicule) / 7 all√©e Madame de Montespan, Bussy-Saint-Georges",
    pk: 53350,
    lat: 48.83874883,
    lon: 2.72748201
  },
  {
    name: "Croisement av. du G√©n√©ral de Gaulle / 17 Bd des 100 Arpents, Bussy-Saint-Georges",
    address: "Croisement av. du G√©n√©ral de Gaulle / 17 Bd des 100 Arpents, Bussy-Saint-Georges",
    pk: 54100,
    lat: 48.84200000,
    lon: 2.73833333
  },
  {
    name: "¬´ PER Jossigny ¬ª (Acc√®s pi√©ton et v√©hicule) / Rd-pt sur av. de l'europe (D10), Jossigny",
    address: "¬´ PER Jossigny ¬ª (Acc√®s pi√©ton et v√©hicule) / Rd-pt sur av. de l'europe (D10), Jossigny",
    pk: 55100,
    lat: 48.84519444,
    lon: 2.74533333
  },
  {
    name: "(Acc√®s √† confirmer) / 77 Rue de la Charbonni√®re (derri√®re le pont), Mont√©vrain",
    address: "(Acc√®s √† confirmer) / 77 Rue de la Charbonni√®re (derri√®re le pont), Mont√©vrain",
    pk: 56560,
    lat: 48.85341667,
    lon: 2.76950000
  },
  {
    name: "¬´ Les lapins ¬ª (Acc√®s pi√©ton et v√©hicule) / D231, Jossigny",
    address: "¬´ Les lapins ¬ª (Acc√®s pi√©ton et v√©hicule) / D231, Jossigny",
    pk: 56650,
    lat: 48.85063889,
    lon: 2.76561111
  },
  {
    name: "Gare de Val d'Europe",
    address: "Gare de Val d'Europe",
    pk: 57150,
    lat: null,
    lon: null
  },
  {
    name: "PER Chessy (Acc√®s pi√©ton et v√©hicule) / Av. Herg√©, Chessy",
    address: "PER Chessy (Acc√®s pi√©ton et v√©hicule) / Av. Herg√©, Chessy",
    pk: 58500,
    lat: 48.86172222,
    lon: 2.78038889
  },
  {
    name: "Disney / Rue Morris, Chessy",
    address: "Disney / Rue Morris, Chessy",
    pk: 58800,
    lat: 48.86652778,
    lon: 2.78127778
  },
  {
    name: "Gare de Chessy / Via h√¥tel Disney's New York, Rue de la Marni√®re",
    address: "Gare de Chessy / Via h√¥tel Disney's New York, Rue de la Marni√®re",
    pk: 59078,
    lat: null,
    lon: null
  },
  {
    name: "(Acc√®s √† confirmer) Arri√®re gare de Chessy / Zone de service, Coupvray (parking)",
    address: "(Acc√®s √† confirmer) Arri√®re gare de Chessy / Zone de service, Coupvray (parking)",
    pk: 59700,
    lat: null,
    lon: null
  },
];

  // On ajoute automatiquement chaque gare comme un "acc√®s" suppl√©mentaire
  for (const st of stations) {
    accessPoints.push({
      name: "Gare de " + st.name,
      // Adresse √† affiner plus tard √† partir de ton fichier complet
      address: "Gare RER A " + st.name,
      pk: st.pk,
      lat: st.lat,
      lon: st.lon,
      nearestStation: st.name
    });
  }

   // Attribue une branche simple √† chaque acc√®s
  // (tronc commun = both, le reste on laissera null)
  for (const acc of accessPoints) {
    if (acc.pk <= 34000) {
      acc.branch = "both"; // tron√ßon commun
    } else {
      acc.branch = null;   // on d√©terminera la branche √† la vol√©e si besoin
    }
  }

  // Ligne courante utilis√©e pour la projection (tronc + branche selon o√π tu es)
let currentBranch = "chessy";
let linePoints = troncCommun.concat(brancheChessy);
// Polylignes calibr√©es (remplies √† partir des accessPoints + recalages)
let linePointsBoissy = null;
let linePointsChessy = null;



  const sensitivityProfiles = {
    slow:   { idle: 0.15, walk: 1.5 },
    normal: { idle: 0.30, walk: 2.5 },
    train:  { idle: 1.00, walk: 6.0 }
  };

  const state = {
    watchId: null,
    lastRawPk: null,
    lastPk: null,
    lastPkTime: null,
    lastLat: null,
    lastLon: null,
    lastDist: null,
    lastAccuracy: null, // AJOUT CALIBRAGE : pr√©cision GPS
    direction: null,
    nearestStation: null,
    nearestAccess: null
  };

  let pkOffset = 0;
  let sosPhone = "";
  let motionSensitivity = "normal";
  let pkTarget = null;
  let lastPkLookupAccess = null;

  // === AJOUT CALIBRAGE : stockage des recalages locaux + fichier partag√© ===
  const LOCAL_CAL_KEY = "pkCalibrations";
  let localCalibrations = [];
  let sharedCalibrations = [];

  function loadLocalCalibrations() {
    const raw = safeGetItem(LOCAL_CAL_KEY);
    if (!raw) {
      localCalibrations = [];
      return;
    }
    try {
      const parsed = JSON.parse(raw);
      localCalibrations = Array.isArray(parsed) ? parsed : [];
    } catch (e) {
      console.warn("Erreur de parsing pkCalibrations :", e);
      localCalibrations = [];
    }
  }

  function saveLocalCalibrations() {
    try {
      safeSetItem(LOCAL_CAL_KEY, JSON.stringify(localCalibrations));
    } catch (e) {
      console.warn("Erreur lors de la sauvegarde pkCalibrations :", e);
    }
  }

// === AJOUT CALIBRAGE : fichier partag√© optionnel =========================
async function loadSharedCalibrations() {
  try {
    const resp = await fetch("data/calibrations.json", { cache: "no-store" });
    if (!resp.ok) {
      console.log("Aucun calibrage partag√© (data/calibrations.json).");
      return;
    }
    const data = await resp.json();
    if (Array.isArray(data)) {
      sharedCalibrations = data;
      console.log("Calibrages partag√©s charg√©s :", sharedCalibrations.length);
    }
  } catch (e) {
    console.log("Impossible de charger les calibrages partag√©s :", e);
  }
}
// Laisse l‚Äôappel d√©sactiv√© tant que le fichier n‚Äôexiste pas :
// loadSharedCalibrations();


  function exportLocalCalibrationsForGitHub() {
    if (!localCalibrations.length) {
      alert("Tu n'as encore enregistr√© aucun recalage PK.");
      return;
    }

    const dataStr = JSON.stringify(localCalibrations, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const now = new Date();
    const stamp = now.toISOString().replace(/[:.]/g, "-");
    const filename = "pk-calibrations-local-" + stamp + ".json";

    // M√©thode pour mobile et desktop
    try {
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      // Sur mobile, afficher aussi le contenu pour copier
      setTimeout(() => {
        const copyText = "üìã Copie le contenu ci-dessous et colle-le dans un fichier .json :\n\n" + dataStr;
        const shouldCopy = confirm(
          "Fichier t√©l√©charg√© : " + filename + "\n\n" +
          "Sur mobile, tu peux aussi copier le contenu JSON pour le partager.\n\n" +
          "Clique sur OK pour voir le contenu √† copier."
        );
        
        if (shouldCopy) {
          // Cr√©er une zone de texte pour copier facilement
          const textarea = document.createElement("textarea");
          textarea.value = dataStr;
          textarea.style.position = "fixed";
          textarea.style.left = "-9999px";
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand("copy");
            alert("‚úÖ Contenu JSON copi√© dans le presse-papiers !\n\nTu peux maintenant le coller dans un message ou un fichier.");
          } catch (err) {
            // Si la copie √©choue, afficher le contenu
            const displayWindow = window.open("", "_blank");
            if (displayWindow) {
              displayWindow.document.write("<pre style='padding: 20px; font-family: monospace; white-space: pre-wrap;'>" + 
                JSON.stringify(localCalibrations, null, 2) + 
                "</pre>");
            } else {
              alert("Contenu JSON :\n\n" + dataStr.substring(0, 500) + "...\n\n(Contenu tronqu√©, utilise le t√©l√©chargement)");
            }
          }
          document.body.removeChild(textarea);
        }
      }, 100);
      
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error("Erreur lors de l'export :", error);
      // Fallback : afficher le JSON dans une alerte ou une nouvelle fen√™tre
      const displayWindow = window.open("", "_blank");
      if (displayWindow) {
        displayWindow.document.write("<pre style='padding: 20px; font-family: monospace; white-space: pre-wrap;'>" + 
          JSON.stringify(localCalibrations, null, 2) + 
          "</pre>");
      } else {
        alert("Erreur lors du t√©l√©chargement. Contenu JSON :\n\n" + dataStr.substring(0, 1000));
      }
    }
  }
  // === FIN AJOUT CALIBRAGE ===

  const gpsStatusBadge = document.getElementById("gpsStatusBadge");
  const geolocText = document.getElementById("geolocText");
  const btnToggleGeoloc = document.getElementById("btnToggleGeoloc");

  const nearestStationName = document.getElementById("nearestStationName");
  const nearestStationInfo = document.getElementById("nearestStationInfo");

  const movementTitle = document.getElementById("movementTitle");
  const movementDetails = document.getElementById("movementDetails");

  const nextStationName = document.getElementById("nextStationName");
  const nextStationInfo = document.getElementById("nextStationInfo");

  const pkTargetLabel = document.getElementById("pkTargetLabel");
  const pkTargetInfo = document.getElementById("pkTargetInfo");
  const inputPkTarget = document.getElementById("inputPkTarget");
  const btnSetPkTarget = document.getElementById("btnSetPkTarget");

  const accessList = document.getElementById("accessList");

  const smsPreview = document.getElementById("smsPreview");
  const btnSms = document.getElementById("btnSms");

  const pkCurrentValue = document.getElementById("pkCurrentValue");
  const pkCurrentDetails = document.getElementById("pkCurrentDetails");

  const toggleOrientation = document.getElementById("toggleOrientation");
  const orientationCard   = document.getElementById("orientationCard");

  const btnSettingsToggle = document.getElementById("btnSettingsToggle");
  const settingsPanel = document.getElementById("settingsPanel");

  const inputSosPhone = document.getElementById("inputSosPhone");
  const btnSavePhone = document.getElementById("btnSavePhone");
  const selectSensitivity = document.getElementById("selectSensitivity");
  const pkOffsetInfo = document.getElementById("pkOffsetInfo");
  const pkEstimateText = document.getElementById("pkEstimateText");
  const inputPkRecal = document.getElementById("inputPkRecal");
  const btnApplyRecal = document.getElementById("btnApplyRecal");
  const btnResetOffset = document.getElementById("btnResetOffset");
  const inputPkLookup = document.getElementById("inputPkLookup");
  const btnPkLookup = document.getElementById("btnPkLookup");
  const pkLookupResultField = document.getElementById("pkLookupResultField");
  const pkLookupResult = document.getElementById("pkLookupResult");
  const btnPkLookupOpenMaps = document.getElementById("btnPkLookupOpenMaps");
  const btnPkLookupOpenWaze = document.getElementById("btnPkLookupOpenWaze");

  const selectIncidentType = document.getElementById("selectIncidentType");
  const incidentOtherField = document.getElementById("incidentOtherField");
  const inputIncidentOther = document.getElementById("inputIncidentOther");
  const incidentPhotoInput = document.getElementById("incidentPhoto");
  const btnGenerateIncident = document.getElementById("btnGenerateIncident");
  const incidentResultField = document.getElementById("incidentResultField");
  const incidentResultText = document.getElementById("incidentResultText");
  const btnCopyIncident = document.getElementById("btnCopyIncident");

  // AJOUT CALIBRAGE : bouton d‚Äôexport
  const btnExportCalibrations = document.getElementById("btnExportCalibrations");

  function formatPk(pkMeters) {
    if (pkMeters == null || isNaN(pkMeters)) return "‚Äî";
    const m = Math.round(pkMeters);
    const km = Math.floor(m / 1000);
    const rest = m % 1000;
    return km + " " + rest.toString().padStart(3, "0");
  }

  function parsePkInput(str) {
    if (!str) return null;
    str = String(str).trim().replace(/\s+/g, "");
    if (/^\d+\+\d+$/.test(str)) {
      const [km, r] = str.split("+");
      return parseInt(km, 10) * 1000 + parseInt(r, 10);
    }
    if (/^\d+$/.test(str)) {
      return parseInt(str, 10);
    }
    return null;
  }

  function distanceMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function projectToSegment(lat, lon, a, b) {
    const meanLat = (a.lat + b.lat) / 2 * Math.PI/180;
    const cosLat = Math.cos(meanLat);

    const ax = a.lon * cosLat;
    const ay = a.lat;
    const bx = b.lon * cosLat;
    const by = b.lat;
    const px = lon * cosLat;
    const py = lat;

    const vx = bx - ax;
    const vy = by - ay;
    const wx = px - ax;
    const wy = py - ay;

    const c1 = vx * wx + vy * wy;
    const c2 = vx * vx + vy * vy;
    let t = c2 > 0 ? c1 / c2 : 0;
    if (t < 0) t = 0;
    if (t > 1) t = 1;

    const latProj = a.lat + (b.lat - a.lat) * t;
    const lonProj = a.lon + (b.lon - a.lon) * t;
    const pkProj = a.pk + (b.pk - a.pk) * t;
    const dist = distanceMeters(lat, lon, latProj, lonProj);

    return { latProj, lonProj, pkProj, dist };
  }

  function projectToLine(lat, lon) {
    let best = { dist: Infinity, pkProj: null, latProj: null, lonProj: null };
    
    // V√©rification de s√©curit√©
    if (!linePoints || linePoints.length < 2) {
      return best;
    }
    
    // M√©thode 1 : Projection sur les segments de la ligne (m√©thode classique)
    for (let i = 0; i < linePoints.length - 1; i++) {
      const a = linePoints[i];
      const b = linePoints[i+1];
      
      // Ignorer les points sans coordonn√©es GPS
      if (a.lat == null || a.lon == null || b.lat == null || b.lon == null) continue;
      
      const res = projectToSegment(lat, lon, a, b);
      if (res.dist < best.dist) {
        best = { dist: res.dist, pkProj: res.pkProj, latProj: res.latProj, lonProj: res.lonProj };
      }
    }
    
    // M√©thode 2 : Interpolation pond√©r√©e bas√©e sur TOUS les points GPS connus (affinage)
    // Utilise les accessPoints + les points de calibration pour am√©liorer la pr√©cision
    const nearbyPoints = [];
    
    // 1) Points issus des accessPoints (191 acc√®s + gares ajout√©es)
    for (const acc of accessPoints) {
      if (acc.lat == null || acc.lon == null || acc.pk == null) continue;
      const d = distanceMeters(lat, lon, acc.lat, acc.lon);
      // On garde les points dans un rayon de 500m pour l'interpolation
      if (d < 500) {
        nearbyPoints.push({ pk: acc.pk, lat: acc.lat, lon: acc.lon, dist: d, weight: 1.0 });
      }
    }
    
    // 2) Points issus des recalages PK (local + partag√©) - ces points sont plus pr√©cis
    const allCals = [];
    if (Array.isArray(sharedCalibrations)) allCals.push(...sharedCalibrations);
    if (Array.isArray(localCalibrations))  allCals.push(...localCalibrations);
    
    for (const c of allCals) {
      if (!c || c.lat == null || c.lon == null) continue;
      const pk = c.pkExact != null ? c.pkExact : c.pk;
      if (pk == null) continue;
      const d = distanceMeters(lat, lon, c.lat, c.lon);
      // Les points de calibration sont plus pr√©cis, on les garde dans un rayon de 1000m
      // et on leur donne un poids plus √©lev√© (1.5) car ce sont des mesures calibr√©es
      if (d < 1000) {
        nearbyPoints.push({ pk: pk, lat: c.lat, lon: c.lon, dist: d, weight: 1.5 });
      }
    }
    
    // Si on a des points GPS proches, on affine le calcul
    if (nearbyPoints.length >= 2) {
      // Tri par distance
      nearbyPoints.sort((a, b) => a.dist - b.dist);
      
      // Interpolation pond√©r√©e : on utilise jusqu'√† 5 points les plus proches
      // Plus on a de points GPS, plus la pr√©cision est grande
      const maxPoints = Math.min(5, nearbyPoints.length);
      const topPoints = nearbyPoints.slice(0, maxPoints);
      
      // Calcul du poids inverse de la distance (plus proche = plus de poids)
      let totalWeight = 0;
      let weightedPk = 0;
      
      for (const pt of topPoints) {
        // Poids = (weight * 1) / (distance + 1) pour √©viter division par z√©ro
        // Les points de calibration ont un poids plus √©lev√© (1.5 vs 1.0)
        const weight = (pt.weight || 1.0) / (pt.dist + 1);
        totalWeight += weight;
        weightedPk += pt.pk * weight;
      }
      
      if (totalWeight > 0) {
        const interpolatedPk = weightedPk / totalWeight;
        
        // On combine la projection sur la ligne (m√©thode 1) avec l'interpolation GPS (m√©thode 2)
        // Si on est tr√®s proche d'un point GPS connu (< 50m), on privil√©gie l'interpolation
        // Sinon, on fait une moyenne pond√©r√©e
        const minDist = topPoints[0].dist;
        
        if (minDist < 50) {
          // Tr√®s proche d'un point GPS connu : on utilise l'interpolation
          best.pkProj = interpolatedPk;
        } else if (best.dist < 200 && best.pkProj != null) {
          // On combine les deux m√©thodes avec un poids selon la distance
          const projectionWeight = best.dist < 100 ? 0.7 : 0.5;
          const interpolationWeight = 1 - projectionWeight;
          best.pkProj = best.pkProj * projectionWeight + interpolatedPk * interpolationWeight;
        }
      }
    } else if (nearbyPoints.length === 1) {
      // Un seul point proche : on l'utilise comme r√©f√©rence si on est tr√®s proche
      const closest = nearbyPoints[0];
      if (closest.dist < 30) {
        // Tr√®s proche d'un point GPS connu : on utilise son PK directement
        best.pkProj = closest.pk;
        best.dist = closest.dist;
      }
    }
    
    return best;
  }

  // üëáüëá AJOUTE TOUT CE BLOC ICI üëáüëá
function buildCalibrationPolylines() {
  const calibTronc  = [];
  const calibBoissy = [];
  const calibChessy = [];

  // Version am√©lior√©e pour s√©parer Boissy / Chessy / Tronc commun √† partir d'un point
  function roughBranchFromLatLon(lat, lon) {
    // D'abord, v√©rifier si on est sur le tronc commun (PK <= 34000)
    // On projette sur le tronc commun pour obtenir le PK estim√©
    let minTronc = Infinity;
    let pkTronc = null;
    
    for (let i = 0; i < troncCommun.length - 1; i++) {
      const a = troncCommun[i];
      const b = troncCommun[i + 1];
      if (a.lat == null || a.lon == null || b.lat == null || b.lon == null) continue;
      
      const proj = projectToSegment(lat, lon, a, b);
      if (proj.dist < minTronc) {
        minTronc = proj.dist;
        pkTronc = proj.pkProj;
      }
    }
    
    // Si on est proche du tronc commun (moins de 300m) ET que le PK est <= 34000, on est sur le tronc commun
    if (minTronc < 300 && pkTronc != null && pkTronc <= 34000) {
      return "both"; // Tronc commun
    }
    
    // Sinon, comparer la distance aux branches Boissy et Chessy
    // On utilise plusieurs points de r√©f√©rence pour plus de pr√©cision
    let dBoissy = Infinity;
    let dChessy = Infinity;
    
    // Pour Boissy : utiliser les 3 premiers points de la branche
    for (let i = 0; i < Math.min(3, brancheBoissy.length); i++) {
      const ref = brancheBoissy[i];
      if (ref.lat == null || ref.lon == null) continue;
      const d = distanceMeters(lat, lon, ref.lat, ref.lon);
      if (d < dBoissy) dBoissy = d;
    }
    
    // Pour Chessy : utiliser les 3 premiers points de la branche
    for (let i = 0; i < Math.min(3, brancheChessy.length); i++) {
      const ref = brancheChessy[i];
      if (ref.lat == null || ref.lon == null) continue;
      const d = distanceMeters(lat, lon, ref.lat, ref.lon);
      if (d < dChessy) dChessy = d;
    }
    
    // Si les distances sont tr√®s proches (< 100m de diff√©rence), on reste neutre
    if (Math.abs(dBoissy - dChessy) < 100) {
      return "both"; // Ind√©termin√©, on reste sur tronc commun
    }
    
    return dBoissy < dChessy ? "boissy" : "chessy";
  }

  // Ajoute un point de calibration dans les bons tableaux
  function addCalibPoint(pk, lat, lon, branchHint) {
    if (pk == null || lat == null || lon == null) return;
    const calPoint = { pk, lat, lon };

    // Tronc commun ‚Üí [0, 34000] comme pour les acc√®s
    if (pk <= 34000) {
      calibTronc.push(calPoint);
      return;
    }

    let branch = branchHint;
    if (!branch || branch === "both") {
      branch = roughBranchFromLatLon(lat, lon);
    }

    if (branch === "boissy") {
      calibBoissy.push(calPoint);
    } else if (branch === "chessy") {
      calibChessy.push(calPoint);
    }
  }

  // 1) Points issus des accessPoints eux-m√™mes (tes 191 acc√®s + les gares ajout√©es)
  for (const acc of accessPoints) {
    addCalibPoint(acc.pk, acc.lat, acc.lon, acc.branch);
  }

  // 2) Points issus des recalages PK (local + partag√©)
  const allCals = [];
  if (Array.isArray(sharedCalibrations)) allCals.push(...sharedCalibrations);
  if (Array.isArray(localCalibrations))  allCals.push(...localCalibrations);

  for (const c of allCals) {
    if (!c) continue;
    const pk = c.pkExact != null ? c.pkExact : c.pk;
    addCalibPoint(pk, c.lat, c.lon, c.branch);
  }

  // Tri par PK
  calibTronc.sort((a, b) => a.pk - b.pk);
  calibBoissy.sort((a, b) => a.pk - b.pk);
  calibChessy.sort((a, b) => a.pk - b.pk);

  // Poly-ligne calibr√©e Boissy = tronc commun + branche Boissy + points de calibration
  linePointsBoissy = troncCommun
    .concat(calibTronc, brancheBoissy, calibBoissy)
    .sort((a, b) => a.pk - b.pk);

  // Poly-ligne calibr√©e Chessy = tronc commun + branche Chessy + points de calibration
  linePointsChessy = troncCommun
    .concat(calibTronc, brancheChessy, calibChessy)
    .sort((a, b) => a.pk - b.pk);
}

  function findNearestStation(pk, branch) {
    if (pk == null) return null;
    let list;
    if (branch === "boissy") {
      list = troncCommun.concat(brancheBoissy);
    } else if (branch === "chessy") {
      list = troncCommun.concat(brancheChessy);
    } else {
      list = stations;
    }
    let best = null;
    let bestDiff = Infinity;
    for (const st of list) {
      const d = Math.abs(st.pk - pk);
      if (d < bestDiff) {
        bestDiff = d;
        best = st;
      }
    }
    return best;
  }

  // Constantes pour le calcul de couverture travaux
  const PETARD_SPACING = 30; // m
  const SAM_OFFSET = 100;    // m (SAM √† 100m du PK de chantier)
  const DISTANCE_RULE = 800;   // m (premier p√©tard √† 800m du SAM)

  // Cr√©e les 3 p√©tards espac√©s de 30 m
  function makePetards(basePk, direction) {
    // direction = "est" (PK augmente) ou "ouest" (PK diminue)
    const rails = ["gauche", "droite", "gauche"];
    return [0, 1, 2].map((i) => {
      const offset = i * PETARD_SPACING;
      const pk = direction === "est" ? basePk + offset : basePk - offset;
      return {
        order: i + 1,
        railFile: rails[i],
        pk: pk,
      };
    });
  }

  // Fonction principale pour calculer les marqueurs de couverture
  function computeCoverageMarkers(pkStart, pkEnd) {
    const results = [];

    // C√¥t√© PK d√©but : SAM √† 100m en direction St-Germain (PK diminue)
    // Exemple : PK chantier 48000 ‚Üí SAM √† 47900
    const pkSamStart = pkStart - SAM_OFFSET;
    // Premier p√©tard √† 800m du SAM (donc 800m en amont du SAM)
    // Exemple : SAM 47900 ‚Üí premier p√©tard √† 47100 (47900 - 800)
    const pkPetardsStart = pkSamStart - DISTANCE_RULE;
    const petardsStart = makePetards(pkPetardsStart, "ouest");

    results.push({
      side: "pkStart",
      pkSamRep: pkSamStart,
      petards: petardsStart,
      rationale: `SAM √† ${SAM_OFFSET} m en direction St-Germain, 3 p√©tards √† ${DISTANCE_RULE} m en amont (espac√©s de ${PETARD_SPACING} m)`,
    });

    // C√¥t√© PK fin : SAM √† 100m en direction Chessy/Boissy (PK augmente)
    // Exemple : PK chantier 49000 ‚Üí SAM √† 49100
    const pkSamEnd = pkEnd + SAM_OFFSET;
    // Premier p√©tard √† 800m du SAM (donc 800m en amont du SAM)
    // Exemple : SAM 49100 ‚Üí premier p√©tard √† 49900 (49100 + 800)
    const pkPetardsEnd = pkSamEnd + DISTANCE_RULE;
    const petardsEnd = makePetards(pkPetardsEnd, "est");

    results.push({
      side: "pkEnd",
      pkSamRep: pkSamEnd,
      petards: petardsEnd,
      rationale: `SAM √† ${SAM_OFFSET} m en direction Chessy/Boissy, 3 p√©tards √† ${DISTANCE_RULE} m en amont (espac√©s de ${PETARD_SPACING} m)`,
    });

    return {
      lineId: "RERA",
      bySide: results,
      distanceRule: DISTANCE_RULE,
    };
  }

  // Fonction pour obtenir les coordonn√©es GPS d'un PK donn√©
  function getGpsFromPk(targetPk) {
    if (targetPk == null || !linePoints || linePoints.length < 2) {
      return null;
    }

    // Trouver les deux points les plus proches du PK cible
    let bestBefore = null;
    let bestAfter = null;
    let minDiffBefore = Infinity;
    let minDiffAfter = Infinity;

    for (let i = 0; i < linePoints.length; i++) {
      const pt = linePoints[i];
      if (pt.pk == null || pt.lat == null || pt.lon == null) continue;

      const diff = targetPk - pt.pk;
      if (diff === 0) {
        // PK exact trouv√©
        return { lat: pt.lat, lon: pt.lon };
      } else if (diff > 0 && diff < minDiffAfter) {
        // Point apr√®s le PK cible
        minDiffAfter = diff;
        bestAfter = pt;
      } else if (diff < 0 && Math.abs(diff) < minDiffBefore) {
        // Point avant le PK cible
        minDiffBefore = Math.abs(diff);
        bestBefore = pt;
      }
    }

    // Si on a trouv√© un point exact
    if (minDiffAfter === 0 || minDiffBefore === 0) {
      const exact = bestAfter || bestBefore;
      return { lat: exact.lat, lon: exact.lon };
    }

    // Interpolation entre les deux points les plus proches
    if (bestBefore && bestAfter) {
      const totalDiff = bestAfter.pk - bestBefore.pk;
      const targetDiff = targetPk - bestBefore.pk;
      const ratio = totalDiff > 0 ? targetDiff / totalDiff : 0;

      const lat = bestBefore.lat + (bestAfter.lat - bestBefore.lat) * ratio;
      const lon = bestBefore.lon + (bestAfter.lon - bestBefore.lon) * ratio;

      return { lat: lat, lon: lon };
    }

    // Si on n'a qu'un seul point proche, on l'utilise
    if (bestBefore) {
      return { lat: bestBefore.lat, lon: bestBefore.lon };
    }
    if (bestAfter) {
      return { lat: bestAfter.lat, lon: bestAfter.lon };
    }

    return null;
  }

  // Nearest access uniquement par PK (utilis√© pour la recherche manuelle)
  function findNearestAccess(pk) {
    if (pk == null) return null;
    let best = null;
    let bestDiff = Infinity;
    for (const acc of accessPoints) {
      if (acc.pk == null) continue;
      const d = Math.abs(acc.pk - pk);
      if (d < bestDiff) {
        bestDiff = d;
        best = acc;
      }
    }
    return best;
  }

  // Nearest access par distance GPS (pour "autour de moi")
  function findNearestAccessGeo(lat, lon) {
    if (lat == null || lon == null) return null;
    let best = null;
    let bestDist = Infinity;
    for (const acc of accessPoints) {
      if (acc.lat == null || acc.lon == null) continue;
      const d = distanceMeters(lat, lon, acc.lat, acc.lon);
      if (d < bestDist) {
        bestDist = d;
        best = acc;
      }
    }
    return best;
  }

  // Top N acc√®s par distance GPS (utilis√© pour "Top 2 en PK")
  function getNearestAccessesGeo(lat, lon, pk, maxCount = 2) {
    if (lat == null || lon == null) return [];

    const list = [];

    for (const acc of accessPoints) {
     
      if (acc.lat == null || acc.lon == null) continue;

      const dGeo = distanceMeters(lat, lon, acc.lat, acc.lon);
      const dPk  = (pk != null && acc.pk != null) ? Math.abs(acc.pk - pk) : null;

      list.push({ acc, dGeo, dPk });
    }

    // Classement par distance GPS r√©elle
    list.sort((a, b) => a.dGeo - b.dGeo);

    // On ne garde que les N premiers (par d√©faut 2)
    return list.slice(0, maxCount);
  }

  function findNextStation(pk, direction, branch) {
    if (pk == null) return null;
    let arr;
    if (branch === "boissy") {
      arr = troncCommun.concat(brancheBoissy);
    } else if (branch === "chessy") {
      arr = troncCommun.concat(brancheChessy);
    } else {
      arr = stations;
    }

    let candidates;
    if (direction === "est") {
      candidates = arr.filter(s => s.pk > pk).sort((a,b) => a.pk - b.pk);
    } else if (direction === "ouest") {
      candidates = arr.filter(s => s.pk < pk).sort((a,b) => b.pk - a.pk);
    } else {
      return findNearestStation(pk, branch);
    }
    return candidates[0] || findNearestStation(pk, branch);
  }

function detectBranch(lat, lon) {
  // Si on n'a pas de GPS (cas de certains acc√®s sans coordonn√©es),
  // on reste en "both" = tronc commun / branche inconnue
  if (lat == null || lon == null) {
    return "both";
  }

  // S'assure que les polylignes calibr√©es sont pr√™tes
  buildCalibrationPolylines();

  // V√©rification de s√©curit√© : si les polylignes ne sont pas initialis√©es, on utilise les valeurs par d√©faut
  if (!linePointsBoissy || !linePointsChessy || !troncCommun || troncCommun.length < 2) {
    return "both";
  }

  // √âTAPE 1 : V√©rifier d'abord si on est sur le TRONC COMMUN (PK 0-34000)
  // On projette sur le tronc commun pour obtenir la distance et le PK estim√©
  let minTronc = Infinity;
  let pkTronc = null;
  
  for (let i = 0; i < troncCommun.length - 1; i++) {
    const a = troncCommun[i];
    const b = troncCommun[i + 1];
    if (a.lat == null || a.lon == null || b.lat == null || b.lon == null) continue;
    
    const proj = projectToSegment(lat, lon, a, b);
    if (proj.dist < minTronc) {
      minTronc = proj.dist;
      pkTronc = proj.pkProj;
    }
  }

  // Si on est tr√®s proche du tronc commun (moins de 200m) ET que le PK est <= 34000, on est sur le tronc commun
  if (minTronc < 200 && pkTronc != null && pkTronc <= 34000) {
    return "both"; // Tronc commun
  }

  // √âTAPE 2 : Si on n'est pas clairement sur le tronc commun, comparer Boissy vs Chessy
  // On utilise la projection sur les segments (plus pr√©cis que la distance aux points)
  let minBoissy = Infinity;
  let pkBoissy = null;
  
  for (let i = 0; i < linePointsBoissy.length - 1; i++) {
    const a = linePointsBoissy[i];
    const b = linePointsBoissy[i + 1];
    if (a.lat == null || a.lon == null || b.lat == null || b.lon == null) continue;
    
    const proj = projectToSegment(lat, lon, a, b);
    if (proj.dist < minBoissy) {
      minBoissy = proj.dist;
      pkBoissy = proj.pkProj;
    }
  }

  let minChessy = Infinity;
  let pkChessy = null;
  
  for (let i = 0; i < linePointsChessy.length - 1; i++) {
    const a = linePointsChessy[i];
    const b = linePointsChessy[i + 1];
    if (a.lat == null || a.lon == null || b.lat == null || b.lon == null) continue;
    
    const proj = projectToSegment(lat, lon, a, b);
    if (proj.dist < minChessy) {
      minChessy = proj.dist;
      pkChessy = proj.pkProj;
    }
  }

  // Si pour une raison quelconque on n'a rien trouv√©, on reste neutre
  if (!isFinite(minBoissy) && !isFinite(minChessy)) {
    return "both";
  }

  // √âTAPE 3 : Comparer les distances avec un seuil de tol√©rance
  // Si les deux distances sont tr√®s proches (< 50m de diff√©rence), on utilise le PK pour trancher
  const diff = Math.abs(minBoissy - minChessy);
  
  if (diff < 50 && pkBoissy != null && pkChessy != null) {
    // Si les distances sont tr√®s proches, on utilise le PK pour d√©terminer la branche
    // Si on est proche de la bifurcation (PK ~34000), on privil√©gie la distance
    if (pkBoissy > 34000 && pkChessy > 34000) {
      // On est clairement sur une branche, on utilise la distance la plus proche
      return minBoissy < minChessy ? "boissy" : "chessy";
    } else if (pkBoissy <= 34000 && pkChessy <= 34000) {
      // On est sur le tronc commun
      return "both";
    } else {
      // Une branche a un PK > 34000, l'autre non : on choisit celle avec PK > 34000
      return pkBoissy > 34000 ? "boissy" : "chessy";
    }
  }

  // √âTAPE 4 : Branche = celle dont la poly-ligne calibr√©e est la plus proche
  // Avec un seuil : si la diff√©rence est trop faible, on reste sur "both" pour √©viter les erreurs
  if (diff < 30) {
    // Si la diff√©rence est tr√®s faible, on v√©rifie le PK pour trancher
    if (pkBoissy != null && pkChessy != null) {
      if (pkBoissy > 34000 && pkChessy <= 34000) return "boissy";
      if (pkChessy > 34000 && pkBoissy <= 34000) return "chessy";
    }
    // Sinon, on reste neutre si vraiment ind√©termin√©
    return "both";
  }

  return minBoissy < minChessy ? "boissy" : "chessy";
}

  function safeGetItem(key) {
    try {
      return localStorage.getItem(key);
    } catch (e) {
      console.warn("localStorage getItem bloqu√© pour", key, e);
      return null;
    }
  }

  function safeSetItem(key, value) {
    try {
      localStorage.setItem(key, value);
    } catch (e) {
      console.warn("localStorage setItem bloqu√© pour", key, e);
    }
  }

  function loadSettings() {
    let storedOffset = parseFloat(safeGetItem("pkOffset"));
    pkOffset = isNaN(storedOffset) ? 0 : storedOffset;

    const sos = safeGetItem("sosPhone");
    const ms  = safeGetItem("motionSensitivity");

    sosPhone = sos || "";
    motionSensitivity = ms || "normal";

    inputSosPhone.value = sosPhone;
    selectSensitivity.value = motionSensitivity;
    updateOffsetInfo();
    // Plan : visible ou non
    if (toggleOrientation && orientationCard) {
      const stored = safeGetItem(ORIENT_ENABLED_KEY);
      const enabled = stored === null ? false : (stored === "1");
      toggleOrientation.checked = enabled;
      orientationCard.style.display = enabled ? "block" : "none";
    }
}

  function updateOffsetInfo() {
    const val = Math.round(pkOffset);
    const sign = val === 0 ? "0" : (val > 0 ? "+"+val : ""+val);
    pkOffsetInfo.textContent = "Offset actuel : " + sign + " m appliqu√©s √† tous les PK.";
  }

  function savePhoneNumber() {
    const phoneValue = inputSosPhone.value.trim();
    
    if (!phoneValue) {
      alert("Veuillez saisir un num√©ro de t√©l√©phone.");
      return;
    }

    // Validation et nettoyage du num√©ro de t√©l√©phone
    // Supprimer les espaces, tirets et points
    const cleaned = phoneValue.replace(/[\s\-\.]/g, "");
    
    // V√©rifier le format : doit commencer par +33 ou 0, puis 9 chiffres
    // Format accept√© : +33XXXXXXXXX ou 0XXXXXXXXX (10 chiffres au total)
    const phoneRegex = /^(\+33|0)[1-9]\d{8}$/;
    
    if (!phoneRegex.test(cleaned)) {
      // Avertissement mais on permet quand m√™me la sauvegarde
      const confirmSave = confirm(
        "Le format du num√©ro de t√©l√©phone semble incorrect.\n" +
        "Format recommand√© : 0612345678 ou +33612345678\n\n" +
        "Voulez-vous quand m√™me enregistrer ce num√©ro ?"
      );
      if (!confirmSave) {
        return; // L'utilisateur annule
      }
      sosPhone = phoneValue; // Sauvegarder tel quel si format incorrect mais confirm√©
    } else {
      // Si le format est correct, on sauvegarde le num√©ro nettoy√©
      sosPhone = cleaned;
      inputSosPhone.value = sosPhone;
    }

    safeSetItem("sosPhone", sosPhone);
    
    // Message de confirmation
    alert("Num√©ro de t√©l√©phone sauvegard√© avec succ√®s ‚úÖ\n\nLe num√©ro sera conserv√© et recharg√© automatiquement.");
  }

  function saveSettings() {
    sosPhone = inputSosPhone.value.trim();
    motionSensitivity = selectSensitivity.value;

    // Validation et nettoyage du num√©ro de t√©l√©phone (optionnel)
    if (sosPhone) {
      // Supprimer les espaces, tirets et points
      const cleaned = sosPhone.replace(/[\s\-\.]/g, "");
      
      // V√©rifier le format : doit commencer par +33 ou 0, puis 9 chiffres
      // Format accept√© : +33XXXXXXXXX ou 0XXXXXXXXX (10 chiffres au total)
      const phoneRegex = /^(\+33|0)[1-9]\d{8}$/;
      
      if (!phoneRegex.test(cleaned)) {
        // Avertissement mais on permet quand m√™me la sauvegarde
        const confirmSave = confirm(
          "Le format du num√©ro de t√©l√©phone semble incorrect.\n" +
          "Format recommand√© : 0612345678 ou +33612345678\n\n" +
          "Voulez-vous quand m√™me enregistrer ce num√©ro ?"
        );
        if (!confirmSave) {
          return; // L'utilisateur annule
        }
      } else {
        // Si le format est correct, on sauvegarde le num√©ro nettoy√©
        sosPhone = cleaned;
        inputSosPhone.value = sosPhone;
      }
    }

    safeSetItem("sosPhone", sosPhone);
    safeSetItem("motionSensitivity", motionSensitivity);
    safeSetItem("pkOffset", pkOffset);

    updateOffsetInfo();
    
    // Message de confirmation
    alert("Param√®tres enregistr√©s avec succ√®s ‚úÖ");
  }

  function updatePkEstimateInSettings() {
    if (state.lastRawPk == null) {
      pkEstimateText.textContent = "En attente de position GPS‚Ä¶";
      if (pkCurrentValue) pkCurrentValue.textContent = "‚Äî";
      if (pkCurrentDetails) pkCurrentDetails.textContent = "En attente de position GPS‚Ä¶";
      return;
    }

    const corrected = state.lastRawPk + pkOffset;
    const pkText = "PK " + formatPk(corrected);
    const distText = state.lastDist != null
      ? "¬∑ ~" + Math.round(state.lastDist) + " m de la voie"
      : "";

    // Mise √† jour du texte dans les param√®tres
    pkEstimateText.textContent = pkText + " " + distText;

    // Affichage sur la carte "PK actuel"
    if (pkCurrentValue) pkCurrentValue.textContent = pkText;
    if (pkCurrentDetails) pkCurrentDetails.textContent = distText || "";
  }

  let geolocActive = false;

  function setGpsStatus(status, message) {
    if (status === "off") {
      gpsStatusBadge.className = "badge badge-danger";
      gpsStatusBadge.textContent = "GPS inactif";
      geolocText.textContent = message || "Position non encore re√ßue.";
    } else if (status === "on") {
      gpsStatusBadge.className = "badge badge-good";
      gpsStatusBadge.textContent = "GPS actif";
      if (message) geolocText.textContent = message;
    } else if (status === "error") {
      gpsStatusBadge.className = "badge badge-danger";
      gpsStatusBadge.textContent = "Erreur GPS";
      geolocText.textContent = message ||
        "Impossible d‚Äôobtenir la position. V√©rifie que la g√©olocalisation est autoris√©e pour ce site.";
    }
  }

  function startGeoloc() {
    if (!navigator.geolocation) {
      setGpsStatus("error", "Ce navigateur ne supporte pas la g√©olocalisation.");
      return;
    }
    if (geolocActive) return;

    geolocActive = true;
    btnToggleGeoloc.innerHTML = "Arr√™ter la g√©oloc";
    setGpsStatus("on", "En attente d‚Äôun premier point‚Ä¶");

    // Optimisation batterie : augmenter maximumAge pour utiliser le cache GPS
    // et r√©duire la fr√©quence des mises √† jour
    state.watchId = navigator.geolocation.watchPosition(
      handlePosition,
      handleGeolocError,
      { 
        enableHighAccuracy: true, 
        maximumAge: 5000, // Utiliser les positions en cache jusqu'√† 5 secondes (au lieu de 1)
        timeout: 15000 
      }
    );
  }

  function stopGeoloc() {
    if (state.watchId != null) {
      navigator.geolocation.clearWatch(state.watchId);
      state.watchId = null;
    }
    geolocActive = false;
    btnToggleGeoloc.innerHTML = "D√©marrer la g√©oloc";
    setGpsStatus("off");
  }

  function handleGeolocError(err) {
    setGpsStatus("error");
    console.error(err);
  }

  // Throttle pour limiter la fr√©quence des mises √† jour (√©conomie batterie)
  let lastUpdateTime = 0;
  const UPDATE_THROTTLE_MS = 1000; // Mise √† jour max toutes les 1 seconde

  function handlePosition(pos) {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const accuracy = pos.coords.accuracy; // AJOUT CALIBRAGE

    state.lastAccuracy = accuracy;

    // Throttle : ne pas mettre √† jour trop souvent
    const now = Date.now();
    const timeSinceLastUpdate = now - lastUpdateTime;
    
    // Toujours mettre √† jour le statut GPS (l√©ger)
    setGpsStatus(
      "on",
      "Position re√ßue (lat : " + lat.toFixed(5) + ", lon : " + lon.toFixed(5) + ")"
    );

    // Si moins de 1 seconde depuis la derni√®re mise √† jour, ignorer (sauf premi√®re position)
    if (timeSinceLastUpdate < UPDATE_THROTTLE_MS && state.lastPk != null) {
      return;
    }
    lastUpdateTime = now;

    // D√©tection de la branche avec la g√©o + polylignes calibr√©es
    currentBranch = detectBranch(lat, lon);

    // On choisit la bonne poly-ligne pour la projection PK
    if (currentBranch === "boissy") {
      linePoints = linePointsBoissy || troncCommun.concat(brancheBoissy);
    } else if (currentBranch === "chessy") {
      linePoints = linePointsChessy || troncCommun.concat(brancheChessy);
    } else {
      // S√©curit√© : si "both" ou autre, on reste sur Chessy par d√©faut
      linePoints = troncCommun.concat(brancheChessy);
    }

    const proj = projectToLine(lat, lon);
    if (proj.pkProj == null) return;

    const rawPk = proj.pkProj;
    const correctedPk = rawPk + pkOffset;
    const nowSeconds = Date.now() / 1000;

    if (state.lastPk != null && state.lastPkTime != null) {
      const dPk = correctedPk - state.lastPk;
      const dt = nowSeconds - state.lastPkTime;
      if (dt > 1) {
        updateMovement(dPk, dt);
      }
    } else {
      movementTitle.textContent = "En attente d'un deuxi√®me point‚Ä¶";
      movementDetails.textContent = "‚Äî";
    }

    state.lastRawPk   = rawPk;
    state.lastPk      = correctedPk;
    state.lastPkTime  = nowSeconds;
    state.lastLat     = lat;
    state.lastLon     = lon;
    state.lastDist    = proj.dist;

    const nearest       = findNearestStation(correctedPk, currentBranch);
    const nearestAccess = findNearestAccessGeo(lat, lon);

    state.nearestStation = nearest;
    state.nearestAccess  = nearestAccess;

    updateNearestStation(correctedPk, nearest);
    updateNextStation(correctedPk);
    updatePkTargetView();
    updateAccessList(correctedPk);
    updateSmsPreview();
    updatePkEstimateInSettings();
    updateOrientationPanel();
  }

  function updateMovement(dPk, dt) {
    const profile = sensitivityProfiles[motionSensitivity] || sensitivityProfiles.normal;
    const speed = Math.abs(dPk) / dt;

    if (dPk > 0) state.direction = "est";
    else if (dPk < 0) state.direction = "ouest";

    const dirLabel = state.direction === "est" ? "vers Chessy / Boissy"
                    : state.direction === "ouest" ? "vers St-Germain / Paris"
                    : "";

    const distText = "ŒîPK ‚âà " + Math.round(Math.abs(dPk)) +
      " m sur ~" + Math.round(dt) + " s.";

    if (speed < profile.idle) {
      movementTitle.textContent = "Quasi immobile";
      movementDetails.textContent = distText;
    } else if (speed < profile.walk) {
      movementTitle.textContent = "√Ä pied " + dirLabel;
      movementDetails.textContent = distText + " (‚âà " + speed.toFixed(1) + " m/s)";
    } else {
      movementTitle.textContent = "Train " + dirLabel;
      movementDetails.textContent = distText + " (‚âà " + speed.toFixed(1) + " m/s)";
    }
  }

  function updateNearestStation(pk, nearest) {
    if (!nearest || pk == null) {
      nearestStationName.textContent = "Aucune";
      nearestStationInfo.textContent = "En attente de position GPS‚Ä¶";
      return;
    }
    nearestStationName.textContent = nearest.name;
    const delta = Math.round(Math.abs(nearest.pk - pk));
    nearestStationInfo.textContent =
      "PK " + formatPk(nearest.pk) + " ¬∑ ŒîPK ‚âà " + delta + " m";
  }

  function updateNextStation(pk) {
    if (pk == null) {
      nextStationName.textContent = "Aucune";
      nextStationInfo.textContent = "En attente de position GPS‚Ä¶";
      return;
    }
    const next = findNextStation(pk, state.direction, currentBranch);
    if (!next) {
      nextStationName.textContent = "Aucune";
      nextStationInfo.textContent = "‚Äî";
      return;
    }
    nextStationName.textContent = next.name;
    const delta = Math.round(Math.abs(next.pk - pk));
    const dir = next.pk >= pk ? "vers Chessy / Boissy" : "vers St-Germain / Paris";
    nextStationInfo.textContent =
      "PK " + formatPk(next.pk) + " ¬∑ ‚âà " + delta + " m " + dir;
  }

 function updatePkTargetView() {
  if (!pkTarget) {
    pkTargetLabel.textContent = "Aucun";
    pkTargetInfo.textContent =
      "Saisis un PK puis clique sur ¬´ D√©finir ce PK comme cible ¬ª.";
    return;
  }

  pkTargetLabel.textContent = "PK " + formatPk(pkTarget);
  if (state.lastPk == null) {
    pkTargetInfo.textContent = "En attente de position GPS‚Ä¶";
    return;
  }
  const delta = pkTarget - state.lastPk;
  const dist = Math.round(Math.abs(delta));
  const dir = delta >= 0 ? "vers Chessy / Boissy" : "vers St-Germain / Paris";
  pkTargetInfo.textContent = "‚âà " + dist + " m " + dir;
}

  // Variables globales pour la carte Leaflet
  let orientationMap = null;
  let pkActuelMarker = null;
  let gareMarker = null;
  let accesMarkers = [];
  let directionMarker = null;
  let pkTargetMarker = null; // Marqueur du PK cible
  let allGareMarkers = []; // Tous les marqueurs de gares
  let allAccesMarkers = []; // Tous les marqueurs d'acc√®s
  let coverageSamMarkers = []; // Marqueurs SAM (feux rouges)
  let coveragePetardMarkers = []; // Marqueurs p√©tards (carr√©s verts)

  // Initialisation de la carte Leaflet
  function initOrientationMap() {
    const mapElement = document.getElementById("orientationMap");
    if (!mapElement || orientationMap) return;

    // Cr√©er la carte avec un th√®me sombre (CartoDB Dark Matter)
    orientationMap = L.map("orientationMap", {
      zoomControl: true,
      attributionControl: true,
    });

    // Ajouter une couche de tuiles sombre (CartoDB Dark Matter)
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: "abcd",
      maxZoom: 19,
    }).addTo(orientationMap);

    // Centrer la carte sur Paris (RER A)
    orientationMap.setView([48.85, 2.35], 12);

    // √âcouter les √©v√©nements de zoom et de d√©placement pour mettre √† jour les marqueurs
    orientationMap.on("zoomend moveend", updateVisibleMarkers);
  }

  // Fonction pour mettre √† jour les marqueurs visibles selon la zone et le zoom
  function updateVisibleMarkers() {
    if (!orientationMap) return;

    const bounds = orientationMap.getBounds();
    const zoom = orientationMap.getZoom();

    // Seuil de zoom pour afficher les gares et acc√®s
    // Zoom < 13 : afficher seulement les gares principales
    // Zoom >= 13 : afficher toutes les gares et acc√®s dans la zone visible
    const minZoomForGares = 12;
    const minZoomForAcces = 13;

    // Filtrer et afficher les gares dans la zone visible
    if (allGareMarkers && Array.isArray(allGareMarkers)) {
      allGareMarkers.forEach(marker => {
        if (!marker) return;
        try {
          const latlng = marker.getLatLng();
          const isVisible = bounds.contains(latlng);
          const shouldShow = zoom >= minZoomForGares && isVisible;
          
          if (shouldShow && !orientationMap.hasLayer(marker)) {
            orientationMap.addLayer(marker);
          } else if (!shouldShow && orientationMap.hasLayer(marker)) {
            orientationMap.removeLayer(marker);
          }
        } catch (e) {
          console.warn("Erreur lors de la mise √† jour du marqueur de gare :", e);
        }
      });
    }

    // Filtrer et afficher les acc√®s dans la zone visible
    if (allAccesMarkers && Array.isArray(allAccesMarkers)) {
      allAccesMarkers.forEach(marker => {
        if (!marker) return;
        try {
          const latlng = marker.getLatLng();
          const isVisible = bounds.contains(latlng);
          const shouldShow = zoom >= minZoomForAcces && isVisible;
          
          if (shouldShow && !orientationMap.hasLayer(marker)) {
            orientationMap.addLayer(marker);
          } else if (!shouldShow && orientationMap.hasLayer(marker)) {
            orientationMap.removeLayer(marker);
          }
        } catch (e) {
          console.warn("Erreur lors de la mise √† jour du marqueur d'acc√®s :", e);
        }
      });
    }
  }

  // Fonction principale pour mettre √† jour la carte du plan
  function updateOrientationPanel() {
    const card = document.getElementById("orientationCard");
    const pkValue = document.getElementById("orientPkValue");
    const dirValue = document.getElementById("orientDirValue");
    const gareValue = document.getElementById("orientGareValue");
    const accessValue = document.getElementById("orientAccessValue");
    const infoPanel = document.getElementById("orientationInfoPanel");

    if (!card || !pkValue || !dirValue || !gareValue || !accessValue || !infoPanel) return;

    // Si le bloc est cach√©, on ne fait rien
    if (card.style.display === "none") return;

    // Initialiser la carte si n√©cessaire
    if (!orientationMap) {
      initOrientationMap();
    }

    // Pas encore de GPS
    if (state.lastPk == null || state.lastLat == null || state.lastLon == null) {
      pkValue.textContent = "‚Äî";
      dirValue.textContent = "En attente de position‚Ä¶";
      gareValue.textContent = "‚Äî";
      accessValue.textContent = "‚Äî";
      infoPanel.style.display = "none";
      return;
    }

    // Afficher le panneau d'information
    infoPanel.style.display = "block";

    // Coordonn√©es GPS actuelles
    const currentLat = state.lastLat;
    const currentLon = state.lastLon;

    // PK actuel + cible
    let txtPk = formatPk(state.lastPk);
    if (pkTarget) {
      txtPk += " ¬∑ cible " + formatPk(pkTarget);
    }
    pkValue.textContent = txtPk;

    // Sens
    let dirLabel = "ind√©termin√©";
    let directionAngle = null; // Angle en degr√©s pour la fl√®che (0 = Nord, 90 = Est, etc.)
    
    if (state.direction === "est") {
      dirLabel = "vers Chessy / Boissy";
      directionAngle = 90; // Est
    } else if (state.direction === "ouest") {
      dirLabel = "vers St-Germain / Paris";
      directionAngle = 270; // Ouest
    }

    if (pkTarget && state.lastPk != null) {
      const delta = pkTarget - state.lastPk;
      if (delta > 0) {
        dirLabel = "vers le PK cible (Chessy / Boissy)";
        directionAngle = 90;
      } else if (delta < 0) {
        dirLabel = "vers le PK cible (St-Germain / Paris)";
        directionAngle = 270;
      }
    }
    dirValue.textContent = dirLabel;

    // Gare la plus proche
    let gareText = "‚Äî";
    if (state.nearestStation) {
      gareText = state.nearestStation.name + " (PK " + formatPk(state.nearestStation.pk) + ")";
      gareValue.textContent = gareText;
    } else {
      gareValue.textContent = "‚Äî";
    }

    // 2 acc√®s les plus proches autour de moi
    const list = getNearestAccessesGeo(state.lastLat, state.lastLon, state.lastPk, 2);
    let accessText = "‚Äî";
    if (list && list.length) {
      accessText = list
        .map(item => item.acc.name + " (PK " + formatPk(item.acc.pk) + ")")
        .join(" ¬∑ ");
      accessValue.textContent = accessText;
    } else {
      accessValue.textContent = "‚Äî";
    }

    // Centrer la carte sur la position actuelle
    orientationMap.setView([currentLat, currentLon], 15);

    // Supprimer les anciens marqueurs dynamiques (PK actuel, gare la plus proche, direction, PK cible)
    if (pkActuelMarker) {
      orientationMap.removeLayer(pkActuelMarker);
    }
    if (gareMarker) {
      orientationMap.removeLayer(gareMarker);
    }
    accesMarkers.forEach(marker => {
      orientationMap.removeLayer(marker);
    });
    accesMarkers = [];
    if (directionMarker) {
      orientationMap.removeLayer(directionMarker);
    }
    if (pkTargetMarker) {
      orientationMap.removeLayer(pkTargetMarker);
      pkTargetMarker = null;
    }
    // Note: Les marqueurs de couverture (SAM et p√©tards) ne sont pas supprim√©s ici
    // Ils restent visibles jusqu'√† ce que l'utilisateur clique sur "Effacer les marqueurs"

    // Cr√©er tous les marqueurs de gares une seule fois (si pas d√©j√† cr√©√©s)
    if (allGareMarkers.length === 0) {
      const allStations = troncCommun.concat(brancheBoissy, brancheChessy);
      allStations.forEach(station => {
        if (station.lat && station.lon) {
          const gareIcon = L.divIcon({
            className: "leaflet-marker-gare",
            html: "üöâ",
            iconSize: [24, 24],
            iconAnchor: [12, 12],
          });
          const stationMarker = L.marker([station.lat, station.lon], {
            icon: gareIcon,
            zIndexOffset: 900,
          });
          stationMarker.bindPopup(
            "Gare : " + station.name + "<br>PK : " + formatPk(station.pk)
          );
          allGareMarkers.push(stationMarker);
        }
      });
    }

    // Cr√©er tous les marqueurs d'acc√®s une seule fois (si pas d√©j√† cr√©√©s)
    if (allAccesMarkers.length === 0) {
      accessPoints.forEach(access => {
        if (access.lat && access.lon) {
          const accesIcon = L.divIcon({
            className: "leaflet-marker-acces",
            html: "üö™",
            iconSize: [18, 18],
            iconAnchor: [9, 9],
          });
          const accessMarker = L.marker([access.lat, access.lon], {
            icon: accesIcon,
            zIndexOffset: 800,
          });
          accessMarker.bindPopup(
            "Acc√®s : " + access.name + "<br>PK : " + (access.pk ? formatPk(access.pk) : "‚Äî")
          );
          allAccesMarkers.push(accessMarker);
        }
      });
    }

    // Ajouter le marqueur PK actuel (point central) - toujours visible
    const pkActuelIcon = L.divIcon({
      className: "leaflet-marker-pk-actuel",
      html: "",
      iconSize: [20, 20],
      iconAnchor: [10, 10],
    });
    pkActuelMarker = L.marker([currentLat, currentLon], {
      icon: pkActuelIcon,
      zIndexOffset: 1000,
    }).addTo(orientationMap);
    pkActuelMarker.bindPopup("PK actuel : " + formatPk(state.lastPk));

    // Ajouter le marqueur de la gare la plus proche (toujours visible)
    if (state.nearestStation && state.nearestStation.lat && state.nearestStation.lon) {
      const gareIcon = L.divIcon({
        className: "leaflet-marker-gare",
        html: "üöâ",
        iconSize: [24, 24],
        iconAnchor: [12, 12],
      });
      gareMarker = L.marker([state.nearestStation.lat, state.nearestStation.lon], {
        icon: gareIcon,
        zIndexOffset: 950,
      }).addTo(orientationMap);
      gareMarker.bindPopup(
        "Gare la plus proche : " + state.nearestStation.name + "<br>PK : " + formatPk(state.nearestStation.pk)
      );
    }

    // Mettre √† jour les marqueurs visibles selon la zone et le zoom
    updateVisibleMarkers();

    // Ajouter la fl√®che de direction qui avance en temps r√©el
    if (directionAngle !== null) {
      // Calculer la position de la fl√®che devant la position actuelle dans la direction du mouvement
      // Distance approximative : ~50 m√®tres devant (0.0005 degr√©s ‚âà 50m √† cette latitude)
      const arrowDistance = 0.0005; // Distance en degr√©s (environ 50m)
      
      // Convertir l'angle en radians pour les calculs trigonom√©triques
      const angleRad = (directionAngle * Math.PI) / 180;
      
      // Calculer le d√©calage lat/lon pour positionner la fl√®che devant
      // Note: directionAngle 90 = Est, 270 = Ouest
      // Pour Est (90¬∞): d√©calage vers l'Est (lon augmente)
      // Pour Ouest (270¬∞): d√©calage vers l'Ouest (lon diminue)
      let arrowLat, arrowLon;
      
      if (directionAngle === 90) {
        // Direction Est (vers Chessy/Boissy) - d√©calage vers l'Est
        arrowLat = currentLat;
        arrowLon = currentLon + arrowDistance;
      } else if (directionAngle === 270) {
        // Direction Ouest (vers St-Germain/Paris) - d√©calage vers l'Ouest
        arrowLat = currentLat;
        arrowLon = currentLon - arrowDistance;
      } else {
        // Direction g√©n√©rale (calcul trigonom√©trique)
        arrowLat = currentLat + arrowDistance * Math.cos(angleRad);
        arrowLon = currentLon + arrowDistance * Math.sin(angleRad);
      }
      
      // Cr√©er une fl√®che HTML avec rotation et animation de mouvement
      const arrowHtml = '<div class="direction-arrow direction-arrow-moving" style="transform: rotate(' + directionAngle + 'deg);"></div>';
      const directionIcon = L.divIcon({
        className: "leaflet-marker-direction",
        html: arrowHtml,
        iconSize: [40, 40],
        iconAnchor: [20, 20],
      });
      
      // Positionner la fl√®che devant la position actuelle
      directionMarker = L.marker([arrowLat, arrowLon], {
        icon: directionIcon,
        zIndexOffset: 1100,
      }).addTo(orientationMap);
      directionMarker.bindPopup("Sens : " + dirLabel + "<br>Position : " + formatPk(state.lastPk));
    } else {
      // Fl√®che gris√©e si direction ind√©termin√©e (positionn√©e au-dessus du point)
      const arrowHtml = '<div class="direction-arrow direction-arrow-indetermine"></div>';
      const directionIcon = L.divIcon({
        className: "leaflet-marker-direction",
        html: arrowHtml,
        iconSize: [40, 40],
        iconAnchor: [20, 20],
      });
      const arrowLat = currentLat + 0.0003; // D√©calage vers le nord si ind√©termin√©
      directionMarker = L.marker([arrowLat, currentLon], {
        icon: directionIcon,
        zIndexOffset: 1100,
      }).addTo(orientationMap);
      directionMarker.bindPopup("Sens : ind√©termin√©");
    }

    // Ajouter le marqueur du PK cible (croix rouge) si d√©fini
    if (pkTarget) {
      const targetGps = getGpsFromPk(pkTarget);
      if (targetGps && targetGps.lat && targetGps.lon) {
        const pkTargetIcon = L.divIcon({
          className: "leaflet-marker-pk-target",
          html: "",
          iconSize: [30, 30],
          iconAnchor: [15, 15],
        });
        pkTargetMarker = L.marker([targetGps.lat, targetGps.lon], {
          icon: pkTargetIcon,
          zIndexOffset: 1050,
        }).addTo(orientationMap);
        pkTargetMarker.bindPopup("PK cible : " + formatPk(pkTarget));
      }
    }

    // Ajuster la vue pour inclure tous les marqueurs
    const group = new L.featureGroup([pkActuelMarker]);
    if (gareMarker) group.addLayer(gareMarker);
    accesMarkers.forEach(marker => group.addLayer(marker));
    if (directionMarker) group.addLayer(directionMarker);
    if (pkTargetMarker) group.addLayer(pkTargetMarker);
    coverageSamMarkers.forEach(marker => group.addLayer(marker));
    coveragePetardMarkers.forEach(marker => group.addLayer(marker));
    
    orientationMap.fitBounds(group.getBounds().pad(0.1), {
      maxZoom: 16,
    });
  }

  // Fonction updateOrientation pour rafra√Æchir la carte du plan (bonus)
  function updateOrientation(pk, sens) {
    // Cette fonction peut √™tre appel√©e manuellement pour rafra√Æchir la carte
    // Elle utilise les valeurs actuelles de state
    updateOrientationPanel();
  }

  function updateAccessList(pk) {
    // Pas de PK ou pas encore de GPS ‚Üí on attend
    if (pk == null || state.lastLat == null || state.lastLon == null) {
      accessList.textContent = "En attente de position GPS‚Ä¶";
      return;
    }

    // Top 2 acc√®s les plus proches en distance GPS
    const nearestList = getNearestAccessesGeo(state.lastLat, state.lastLon, pk, 2);

    if (!nearestList.length) {
      accessList.textContent = "Aucun acc√®s disponible.";
      return;
    }

    const lines = nearestList.map(item => {
      const acc = item.acc;
      const dGeo = Math.round(item.dGeo); // m "√† vol d‚Äôoiseau"
      const dPk  = (item.dPk != null) ? Math.round(item.dPk) : null;
      const dir  = (acc.pk != null && pk != null && acc.pk >= pk)
        ? "vers Chessy / Boissy"
        : "vers St-Germain / Paris";

      let pkLine = "PK " + formatPk(acc.pk) + " ‚Äì " + acc.name;
      let sub = "‚âà " + dGeo + " m en distance GPS";

      if (dPk != null) {
        sub = "ŒîPK ‚âà " + dPk + " m " + dir + " ¬∑ " + sub;
      }

      return (
        '<div class="access-item">' +
          '<div><strong>' + pkLine + "</strong></div>" +
          '<div class="muted">' + sub + "</div>" +
        "</div>"
      );
    });

    accessList.innerHTML = lines.join("");
  }

  function updateSmsPreview() {
    if (state.lastPk == null || state.lastLat == null) {
      smsPreview.textContent =
        "En attente de position GPS pour pr√©parer le SMS.";
      return;
    }
    const pkText = "PK " + formatPk(state.lastPk);
    const nearestName = state.nearestStation ? state.nearestStation.name : "inconnue";
    const branchLabel = currentBranch === "boissy" ? "branche Boissy-Saint-L√©ger"
                     : currentBranch === "chessy" ? "branche Marne-la-Vall√©e ‚Äì Chessy"
                     : "branche inconnue";
    let base =
      pkText + " (" + branchLabel + "), gare la plus proche : " + nearestName +
      ", lat " + state.lastLat.toFixed(5) +
      ", lon " + state.lastLon.toFixed(5) + ".";

    if (state.nearestAccess) {
      base += " Acc√®s le plus proche : " + state.nearestAccess.name +
        " (" + state.nearestAccess.address + ").";
    }

    const numPart = " Num√©ro utilis√© : " +
      (sosPhone ? sosPhone : "aucun (√† d√©finir dans Param√®tres).");
    smsPreview.textContent = base + numPart;
  }

  function sendSms() {
    if (state.lastPk == null || state.lastLat == null) {
      alert("Position GPS insuffisante pour pr√©parer le SMS.");
      return;
    }
    const pkText = "PK " + formatPk(state.lastPk);
    const nearestName = state.nearestStation ? state.nearestStation.name : "inconnue";
    const branchLabel = currentBranch === "boissy" ? "branche Boissy-Saint-L√©ger"
                     : currentBranch === "chessy" ? "branche Marne-la-Vall√©e ‚Äì Chessy"
                     : "branche inconnue";
    let message =
      "J'ai eu un accident, je suis bless√©, venez me secourir.\n\n" +
      "PK : " + pkText + " (" + branchLabel + ")\n" +
      "Gare la plus proche : " + nearestName + "\n";

    if (state.nearestAccess) {
      message +=
        "Acc√®s le plus proche : " + state.nearestAccess.name +
        " (" + state.nearestAccess.address + ")\n";
    }

    message +=
      "Coordonn√©es : " + state.lastLat.toFixed(5) + ", " + state.lastLon.toFixed(5) + "\n";

    const body = encodeURIComponent(message);
    const numberPart = sosPhone ? encodeURIComponent(sosPhone) : "";
    const url = numberPart
      ? "sms:" + numberPart + "?&body=" + body
      : "sms:?&body=" + body;

    window.location.href = url;
  }

  function handlePkLookup() {
    const val = parsePkInput(inputPkLookup.value);
    if (val == null) {
      alert("PK invalide. Utilise 32400 ou 32+400.");
      return;
    }
    const acc = findNearestAccess(val);
    if (!acc) {
      pkLookupResultField.style.display = "none";
      alert("Aucun acc√®s disponible pour ce PK.");
      return;
    }
    lastPkLookupAccess = acc;
    const delta = Math.round(Math.abs(acc.pk - val));
    const dir = acc.pk >= val ? "vers Chessy / Boissy" : "vers St-Germain / Paris";

    pkLookupResult.innerHTML =
      "<strong>Acc√®s le plus proche :</strong> " + acc.name + "<br>" +
      "PK " + formatPk(acc.pk) + " (ŒîPK ‚âà " + delta + " m " + dir + ")<br>" +
      "<span class='muted'>" + acc.address + "</span>";

    pkLookupResultField.style.display = "block";
  }

  function openPkLookupInMaps() {
    if (!lastPkLookupAccess) {
      alert("Aucun acc√®s s√©lectionn√©. Lance une recherche par PK d‚Äôabord.");
      return;
    }

    let url;
    // Si on a des coordonn√©es GPS pr√©cises ‚Üí on ouvre directement √† cet endroit
    if (
      lastPkLookupAccess.lat != null &&
      lastPkLookupAccess.lon != null
    ) {
      url = "https://maps.google.com/?q=" +
        lastPkLookupAccess.lat + "," + lastPkLookupAccess.lon;
    } else {
      // Sinon on ouvre une recherche sur l‚Äôadresse / le nom
      const query = lastPkLookupAccess.address || lastPkLookupAccess.name;
      url = "https://www.google.com/maps/search/?api=1&query=" +
        encodeURIComponent(query);
    }

    window.open(url, "_blank");
  }

  function openPkLookupInWaze() {
    if (!lastPkLookupAccess) {
      alert("Aucun acc√®s s√©lectionn√©. Lance une recherche par PK d‚Äôabord.");
      return;
    }
    const lat = lastPkLookupAccess.lat;
    const lon = lastPkLookupAccess.lon;
    if (lat == null || lon == null) {
      alert("Pas de coordonn√©es GPS pour cet acc√®s.");
      return;
    }
    // Lien universel Waze
    const url = "https://waze.com/ul?ll=" + lat + "," + lon + "&navigate=yes";
    window.open(url, "_blank");
  }

  if (selectIncidentType) {
    selectIncidentType.addEventListener("change", () => {
      if (selectIncidentType.value === "Autre") {
        if (incidentOtherField) incidentOtherField.style.display = "block";
      } else {
        if (incidentOtherField) incidentOtherField.style.display = "none";
      }
    });
  }

  if (btnGenerateIncident) {
    btnGenerateIncident.addEventListener("click", () => {
      if (state.lastPk == null || state.lastLat == null) {
        alert("Position GPS non disponible. Lance la g√©oloc avant de signaler.");
        return;
      }
      let type = selectIncidentType ? selectIncidentType.value : "";
      if (!type) {
        alert("Choisis un type d'incident avant de g√©n√©rer le message.");
        return;
      }
      if (type === "Autre") {
        const desc = inputIncidentOther ? inputIncidentOther.value.trim() : "";
        if (!desc) {
          alert("Pr√©cise la nature de l'incident.");
          return;
        }
        type = desc;
      }

      const pkTxt = "PK " + formatPk(state.lastPk);
      const station = state.nearestStation ? state.nearestStation.name : "inconnue";
      const lat = state.lastLat.toFixed(5);
      const lon = state.lastLon.toFixed(5);
      const now = new Date();
      const dateTxt = now.toLocaleDateString("fr-FR");
      const timeTxt = now.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });

      let message =
        "üö® Signalement d'avarie / incident\n" +
        "Type : " + type + "\n" +
        "PK : " + pkTxt + "\n" +
        "Branche : " + (currentBranch === "boissy"
                        ? "Boissy-Saint-L√©ger"
                        : currentBranch === "chessy"
                          ? "Marne-la-Vall√©e ‚Äì Chessy"
                          : "inconnue") + "\n" +
        "Gare la plus proche : " + station + "\n";

      if (state.nearestAccess) {
        message +=
          "Acc√®s le plus proche : " + state.nearestAccess.name +
          " (" + state.nearestAccess.address + ")\n";
      }

      message +=
        "Coordonn√©es : " + lat + ", " + lon + "\n" +
        "Date/heure : " + dateTxt + " ‚Äì " + timeTxt;

      if (incidentPhotoInput && incidentPhotoInput.files && incidentPhotoInput.files.length > 0) {
        const file = incidentPhotoInput.files[0];
        if (file && file.name) {
          message += "\nPhoto jointe : " + file.name;
        }
      }

      if (incidentResultText) incidentResultText.value = message;
      if (incidentResultField) incidentResultField.style.display = "block";
    });
  }

  if (btnCopyIncident) {
    btnCopyIncident.addEventListener("click", () => {
      const text = incidentResultText.value;
      if (!text) {
        alert("Aucun message √† copier.");
        return;
      }
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          alert("Message copi√© dans le presse-papiers ‚úÖ");
        }).catch(() => {
          incidentResultText.select();
          document.execCommand("copy");
          alert("Message copi√© dans le presse-papiers ‚úÖ");
        });
      } else {
        incidentResultText.select();
        document.execCommand("copy");
        alert("Message copi√© dans le presse-papiers ‚úÖ");
      }
    });
  }

  if (btnToggleGeoloc) {
    btnToggleGeoloc.addEventListener("click", () => {
      if (geolocActive) stopGeoloc();
      else startGeoloc();
    });
  }

  if (btnSettingsToggle && settingsPanel) {
    btnSettingsToggle.addEventListener("click", () => {
      const isVisible = settingsPanel.style.display !== "none";
      settingsPanel.style.display = isVisible ? "none" : "block";
    });
  }

  if (btnSetPkTarget && inputPkTarget) {
    btnSetPkTarget.addEventListener("click", () => {
      const val = parsePkInput(inputPkTarget.value);
      if (val == null) {
        alert("PK cible invalide. Utilise 32400 ou 32+400.");
        return;
      }
      pkTarget = val;
      updatePkTargetView();
      updateOrientationPanel();
    });
  }

  if (btnSms) {
    btnSms.addEventListener("click", sendSms);
  }

  if (btnResetOffset) {
    btnResetOffset.addEventListener("click", () => {
      pkOffset = 0;
      safeSetItem("pkOffset", pkOffset);
      updateOffsetInfo();
      if (state.lastRawPk != null) {
        state.lastPk = state.lastRawPk;
        state.nearestStation = findNearestStation(state.lastPk, currentBranch);
        state.nearestAccess = (state.lastLat != null && state.lastLon != null) 
          ? findNearestAccessGeo(state.lastLat, state.lastLon)
          : findNearestAccess(state.lastPk);
        updateNearestStation(state.lastPk, state.nearestStation);
        updateNextStation(state.lastPk);
        updatePkTargetView();
        updateAccessList(state.lastPk);
        updateSmsPreview();
        updatePkEstimateInSettings();
      } else {
        updatePkEstimateInSettings();
      }
    });
  }

  if (btnApplyRecal && inputPkRecal) {
    btnApplyRecal.addEventListener("click", () => {
      const exactPk = parsePkInput(inputPkRecal.value);
      if (exactPk == null) {
        alert("PK invalide. Utilise 52700 ou 52+700.");
        return;
      }
      if (state.lastRawPk == null) {
        alert("Pas de position GPS pour recaler. Lance la g√©oloc d'abord.");
        return;
      }
      pkOffset = exactPk - state.lastRawPk;
      safeSetItem("pkOffset", pkOffset);
      updateOffsetInfo();
      updatePkEstimateInSettings();

      // AJOUT CALIBRAGE : on enregistre ce recalage comme un point de calibration
      if (state.lastLat != null && state.lastLon != null) {
        const calib = {
          // PK exact saisi par toi
          pkExact: exactPk,
          // PK brut estim√© par l'algorithme avant offset
          pkRaw: state.lastRawPk,
          // offset appliqu√©
          pkOffset: pkOffset,
          // coordonn√©es GPS au moment du recalage
          lat: state.lastLat,
          lon: state.lastLon,
          accuracy: state.lastAccuracy,
          branch: currentBranch,
          timestamp: new Date().toISOString()
        };
        localCalibrations.push(calib);
        saveLocalCalibrations();
        console.log("Nouveau recalage enregistr√© :", calib);
      }
      // FIN AJOUT CALIBRAGE
    });
  }

  if (btnSavePhone) {
    btnSavePhone.addEventListener("click", () => {
      savePhoneNumber();
      updateSmsPreview();
    });
  }

if (selectSensitivity) {
  selectSensitivity.addEventListener("change", () => {
    motionSensitivity = selectSensitivity.value;
    safeSetItem("motionSensitivity", motionSensitivity);
  });
}

// Gestion de l'affichage du bloc Plan
if (toggleOrientation && orientationCard) {
  toggleOrientation.addEventListener("change", () => {
    const enabled = toggleOrientation.checked;
    orientationCard.style.display = enabled ? "block" : "none";
    safeSetItem(ORIENT_ENABLED_KEY, enabled ? "1" : "0");
    if (enabled) {
      updateOrientationPanel();
    }
  });
}

  if (btnPkLookup) {
    btnPkLookup.addEventListener("click", handlePkLookup);
  }
  if (btnPkLookupOpenMaps) {
    btnPkLookupOpenMaps.addEventListener("click", openPkLookupInMaps);
  }
  if (btnPkLookupOpenWaze) {
    btnPkLookupOpenWaze.addEventListener("click", openPkLookupInWaze);
  }

  // AJOUT CALIBRAGE : clic sur "Exporter mes recalages"
  if (btnExportCalibrations) {
    btnExportCalibrations.addEventListener("click", exportLocalCalibrationsForGitHub);
  }

  // Calcul de couverture travaux (feux rouges et p√©tards)
  const inputCoveragePkStart = document.getElementById("inputCoveragePkStart");
  const inputCoveragePkEnd = document.getElementById("inputCoveragePkEnd");
  const btnComputeCoverage = document.getElementById("btnComputeCoverage");
  const btnClearCoverage = document.getElementById("btnClearCoverage");
  const coverageResult = document.getElementById("coverageResult");
  const coverageResultText = document.getElementById("coverageResultText");
  const coverageResultsLine = document.getElementById("coverageResultsLine");

  function clearCoverageMarkers() {
    coverageSamMarkers.forEach(marker => {
      if (orientationMap && orientationMap.hasLayer(marker)) {
        orientationMap.removeLayer(marker);
      }
    });
    coveragePetardMarkers.forEach(marker => {
      if (orientationMap && orientationMap.hasLayer(marker)) {
        orientationMap.removeLayer(marker);
      }
    });
    coverageSamMarkers = [];
    coveragePetardMarkers = [];
    if (coverageResult) coverageResult.style.display = "none";
    if (btnClearCoverage) btnClearCoverage.style.display = "none";
    if (coverageResultsLine) {
      coverageResultsLine.innerHTML = '<span style="color: rgba(255, 255, 255, 0.5);">Cliquez sur ¬´ Calculer rouges & p√©tards ¬ª pour voir les r√©sultats</span>';
    }
  }

  function addCoverageMarkersToMap(result) {
    try {
      // Supprimer les anciens marqueurs
      clearCoverageMarkers();

      // Afficher les r√©sultats dans la ligne m√™me si la carte n'est pas activ√©e
      if (coverageResultsLine) {
        let lineText = "";
        for (const sideResult of result.bySide) {
          const sideLabel = sideResult.side === "pkStart" ? "D√©but" : "Fin";
          lineText += `<span style="margin-right: 15px;"><strong>${sideLabel} :</strong> üî¥ PK ${formatPk(sideResult.pkSamRep)}`;
          if (sideResult.petards.length > 0) {
            const petardsPk = sideResult.petards.map(p => formatPk(p.pk)).join(", ");
            lineText += ` | üü¢ P√©tards PK ${petardsPk}`;
          }
          lineText += `</span>`;
        }
        coverageResultsLine.innerHTML = lineText;
      }

      // Afficher le r√©sultat d√©taill√©
      if (coverageResultText) {
        let resultHtml = `<div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: #ff9f7b;">üìä R√©sultat du calcul</div>`;
        resultHtml += `<div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 255, 255, 0.03); border-radius: 6px;">`;
        resultHtml += `<strong>Distance r√®gle :</strong> ${result.distanceRule} m<br>`;
        resultHtml += `</div>`;
        
        for (const sideResult of result.bySide) {
          const sideLabel = sideResult.side === "pkStart" ? "D√©but" : "Fin";
          const sideColor = sideResult.side === "pkStart" ? "#ff4b6b" : "#3d7bff";
          
          resultHtml += `<div style="margin-top: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-left: 3px solid ${sideColor}; border-radius: 4px;">`;
          resultHtml += `<div style="font-weight: 600; color: ${sideColor}; margin-bottom: 8px;">üö¶ C√¥t√© ${sideLabel}</div>`;
          resultHtml += `<div style="margin-bottom: 5px;"><strong>üî¥ Feu rouge :</strong> PK ${formatPk(sideResult.pkSamRep)}</div>`;
          if (sideResult.petards.length > 0) {
            resultHtml += `<div style="margin-bottom: 5px;"><strong>P√©tards (carr√©s verts) :</strong><br>`;
            sideResult.petards.forEach((p, idx) => {
              resultHtml += `&nbsp;&nbsp;‚Ä¢ P√©tard ${p.order} (${p.railFile}) : PK ${formatPk(p.pk)}<br>`;
            });
            resultHtml += `</div>`;
          }
          resultHtml += `<div style="margin-top: 8px; font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); font-style: italic;">${sideResult.rationale}</div>`;
          resultHtml += `</div>`;
        }
        
        coverageResultText.innerHTML = resultHtml;
      }
      if (coverageResult) {
        coverageResult.style.display = "block";
      }
      if (btnClearCoverage) {
        btnClearCoverage.style.display = "block";
      }

      // Ajouter les marqueurs sur la carte seulement si elle est activ√©e
      if (!orientationMap) {
        return;
      }

      // Ajouter les marqueurs SAM (feux rouges) et p√©tards (carr√©s verts) sur la carte
      for (const sideResult of result.bySide) {
        // Marqueur SAM (feu rouge)
        const samGps = getGpsFromPk(sideResult.pkSamRep);
        if (samGps && samGps.lat && samGps.lon) {
          const samIcon = L.divIcon({
            className: "leaflet-marker-sam",
            html: "",
            iconSize: [20, 20],
            iconAnchor: [10, 10],
          });
          const samMarker = L.marker([samGps.lat, samGps.lon], {
            icon: samIcon,
            zIndexOffset: 1200,
          }).addTo(orientationMap);
          samMarker.bindPopup(
            `üî¥ Feu rouge ${sideResult.side === "pkStart" ? "d√©but" : "fin"} : PK ${formatPk(sideResult.pkSamRep)}`
          );
          coverageSamMarkers.push(samMarker);
        }

        // Marqueurs p√©tards (carr√©s verts)
        for (const petard of sideResult.petards) {
          const petardGps = getGpsFromPk(petard.pk);
          if (petardGps && petardGps.lat && petardGps.lon) {
            const petardIcon = L.divIcon({
              className: "leaflet-marker-petard",
              html: "",
              iconSize: [16, 16],
              iconAnchor: [8, 8],
            });
            const petardMarker = L.marker([petardGps.lat, petardGps.lon], {
              icon: petardIcon,
              zIndexOffset: 1150,
            }).addTo(orientationMap);
            petardMarker.bindPopup(
              `P√©tard ${petard.order} (${petard.railFile}) : PK ${formatPk(petard.pk)}`
            );
            coveragePetardMarkers.push(petardMarker);
          }
        }
      }

      // Mettre √† jour la vue de la carte
      if (orientationMap) {
        updateOrientationPanel();
      }
    } catch (error) {
      console.error("Erreur dans addCoverageMarkersToMap :", error);
      alert("Erreur lors de l'affichage des r√©sultats : " + error.message);
    }
  }

  if (btnComputeCoverage) {
    btnComputeCoverage.addEventListener("click", () => {
      try {
        if (!inputCoveragePkStart || !inputCoveragePkEnd) {
          alert("Veuillez remplir les PK d√©but et fin.");
          return;
        }

        const pkStart = parseFloat(inputCoveragePkStart.value);
        const pkEnd = parseFloat(inputCoveragePkEnd.value);

        if (isNaN(pkStart) || isNaN(pkEnd)) {
          alert("Veuillez saisir des valeurs num√©riques valides.");
          return;
        }

        if (pkStart >= pkEnd) {
          alert("Le PK d√©but doit √™tre inf√©rieur au PK fin.");
          return;
        }

        const result = computeCoverageMarkers(pkStart, pkEnd);
        if (!result || !result.bySide) {
          console.error("Erreur : computeCoverageMarkers n'a pas retourn√© un r√©sultat valide", result);
          alert("Erreur lors du calcul. Veuillez r√©essayer.");
          return;
        }
        
        addCoverageMarkersToMap(result);
      } catch (error) {
        console.error("Erreur lors du calcul des rouges et p√©tards :", error);
        alert("Une erreur est survenue : " + error.message);
      }
    });
  }

  if (btnClearCoverage) {
    btnClearCoverage.addEventListener("click", () => {
      clearCoverageMarkers();
      if (orientationMap) {
        updateOrientationPanel();
      }
    });
  }

  if (selectIncidentType) {
    selectIncidentType.dispatchEvent(new Event("change"));
  }

  // Initialisation
    function initAccessGate() {
  const overlay = document.getElementById("accessOverlay");
  const input   = document.getElementById("accessCodeInput");
  const btn     = document.getElementById("btnAccessCode");
  const err     = document.getElementById("accessError");

  if (!overlay || !input || !btn) return;

  const already = safeGetItem(ACCESS_CODE_KEY);
  if (already === "ok") {
    // D√©j√† autoris√© sur cet appareil -> on masque l'overlay
    overlay.style.display = "none";
    return;
  }

  function tryCode() {
    const v = (input.value || "").trim();
    if (v === ACCESS_CODE) {
      safeSetItem(ACCESS_CODE_KEY, "ok");
      err.style.display = "none";
      overlay.style.transition = "opacity 0.2s ease";
      overlay.style.opacity = "0";
      setTimeout(() => { overlay.style.display = "none"; }, 200);
    } else {
      err.style.display = "block";
    }
  }

  btn.addEventListener("click", tryCode);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") tryCode();
  });
}

loadSettings();
loadLocalCalibrations();
// loadSharedCalibrations(); // d√©sactiv√© pour √©viter tout fetch
updateSmsPreview();
setGpsStatus("off");
initAccessGate();
console.log("PK Assistant RER A ‚Äì script charg√© sans erreur ‚úÖ");

  // Optimisation batterie : pause les animations quand la page n'est pas visible
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      document.body.setAttribute("data-page-hidden", "true");
      // R√©duire la fr√©quence GPS quand la page n'est pas visible
      if (geolocActive && state.watchId) {
        // Augmenter maximumAge quand la page n'est pas visible
        navigator.geolocation.clearWatch(state.watchId);
        state.watchId = navigator.geolocation.watchPosition(
          handlePosition,
          handleGeolocError,
          { 
            enableHighAccuracy: false, // R√©duire la pr√©cision quand invisible
            maximumAge: 10000, // Utiliser le cache jusqu'√† 10 secondes
            timeout: 20000 
          }
        );
      }
    } else {
      document.body.removeAttribute("data-page-hidden");
      // Restaurer la fr√©quence GPS normale quand la page redevient visible
      if (geolocActive && state.watchId) {
        navigator.geolocation.clearWatch(state.watchId);
        state.watchId = navigator.geolocation.watchPosition(
          handlePosition,
          handleGeolocError,
          { 
            enableHighAccuracy: true, 
            maximumAge: 5000,
            timeout: 15000 
          }
        );
      }
    }
  });
  </script>

  <!-- Signature -->
  <div class="app-footer">
    KYFUN
  </div>
</body>
</html>
